# Process this file with autoconf to generate the Makefile
# @configure_input@

# MANIFEST and prefix must match the value defaulted in starconf.
# FIXME: tie these together, and link with starconf values.
prefix=@prefix@
MANIFEST=$(prefix)/manifests

# Keep the following in alphabetical order
ALL_TARGETS = \
	$(MANIFEST)/adam \
	$(MANIFEST)/ams \
	$(MANIFEST)/atimer \
	$(MANIFEST)/chr \
	$(MANIFEST)/cnf \
	$(MANIFEST)/dtask \
	$(MANIFEST)/ems \
	$(MANIFEST)/fio \
	$(MANIFEST)/hds \
	$(MANIFEST)/hdspar \
	$(MANIFEST)/hlp \
	$(MANIFEST)/lex \
	$(MANIFEST)/mers \
	$(MANIFEST)/messgen \
	$(MANIFEST)/messys \
	$(MANIFEST)/misc \
	$(MANIFEST)/msp \
	$(MANIFEST)/par \
	$(MANIFEST)/parsecon \
	$(MANIFEST)/pcs \
	$(MANIFEST)/psx \
	$(MANIFEST)/sae \
	$(MANIFEST)/sla \
	$(MANIFEST)/sock \
	$(MANIFEST)/sst \
	$(MANIFEST)/starconf \
	$(MANIFEST)/string \
	$(MANIFEST)/subpar \
	$(MANIFEST)/task

# Targets present in tree, but excluded from list
#   adamnet -- obsolete

# The other important target is `buildsupport', the dependencies of
# which are defined in the Makefile.dependencies which is included below.



SUBDIRS = @subdirs@
@SET_MAKE@
LN_S=@LN_S@

# Java support: need a java runtime
JAVA=@JAVA@

RECURSIVE_TARGETS = clean maintainer-clean



all: $(ALL_TARGETS)

# The Makefile dependencies are built using a Java program.  This
# isn't installed (it should be -- see the comments in
# buildsupport/starconf/Makefile.am) so we have to hack it.  Ugly: FIXME.
#
# Avoid doing anything if the variable JAVA is null -- this is true if
# we're using this file unconfigured during bootstrap (see ./bootstrap
# for the relevant gymnastics).
#
# At the same time, create a set of dependencies for componentset.xml.
# These won't _necessarily_ be up-to-date, but they'll only be
# inaccurate if we (rarely) add a new component, so they're good
# enough for their purpose.  componentset.xml doesn't really depend on
# configure.ac, but it's a useful and plausible dummy to end the list with.
#
# The test of whether $(JAVA) is zero-length is important.  An edited
# version of this file is used by the ./bootstrap script, in which the
# JAVA variable is empty (since the directory may not have been
# configured yet); we must not fail in this case, nor may we attempt
# to make GenerateDependencies.class.
Makefile.dependencies: componentset.xml
	if test -f buildsupport/starconf/java/GenerateDependencies.class \
			-o -z "$(JAVA)";then \
		:; \
	    else \
		cd buildsupport/starconf/java && \
		    $(MAKE) GenerateDependencies.class; \
	    fi
	if test -n "$(JAVA)"; then \
	    $(JAVA) -classpath buildsupport/starconf/java \
		GenerateDependencies componentset.xml >$@ \
	    && echo "componentset.xml: \\" >>$@ \
	    && find . -name component.xml | sed 's/\(.*\)/		\1 \\/' >>$@ \
	    && echo "		configure.ac" >>$@; \
	else :; fi

# Make a componentset.xml by concatenating all the component.xml files
# we can find.  Sort the list of files, not because this matters, but
# to make this deterministic.  The removal of the DOCTYPE lines and
# PIs is admittedly lame, but good enough for the moment.
componentset.xml: componentinfo.dtd
	echo '<!DOCTYPE componentset SYSTEM "componentinfo.dtd">' >$@
	echo '<componentset>' >>$@
	find . -name component.xml | sort | { \
	    while read cname; do \
		sed -e '/^<?/d' -e '/^<!DOCTYPE/d' $$cname >>$@; \
	    done; }
	echo '</componentset>' >>$@

# Make a link to an installed componentinfo.dtd file.  This will not
# work at bootstrap time (so the bootstrap file takes care of this
# link).  It does no harm to have the rule in, just in case this is
# used at some other time.
componentinfo.dtd:
	$(LN_S) `starconf --show buildsupportdata`/componentinfo.dtd componentinfo.dtd

# Makefile.dependencies expresses all the dependencies between components.
# It expects the current file to define variable MANIFEST to be the directory
# which holds the manifest files, typically /star/manifests
#
# This include file also contains the TARGET buildsupport
include Makefile.dependencies

$(MANIFEST)/starconf: buildsupport/starconf/install-sh

buildsupport/starconf/install-sh: $(MANIFEST)/automake $(MANIFEST)/autoconf
	cd buildsupport/starconf && \
	    aclocal && \
	    automake --add-missing && \
	    autoconf

$(RECURSIVE_TARGETS):
	for d in $(SUBDIRS); do \
	    (cd $$d; $(MAKE) $@); \
	done
