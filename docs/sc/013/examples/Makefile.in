# Makefile for the demo programs for SC/13
#
# To build all the example programs, give the commands
#
#    ./configure
#    make
#
# See README for further discussion.
#
#
# $Id$


# Compilers to use
CC=@CC@
F77=@F77@
DEFS=@DEFS@

PROFILING=@PROFILINGOPTION@
NOUNDERSCORES=@NOUNDERSCORES@


EXECS=timewaster fpdemo fpp dfpp mixed crash

EXAMPLES=crash.c fpp.c fpdemo.c \
	io-f.f io-c.c \
	p1.f p2.f p3.f \
	islittleendian.c mixed-f.f mixed-c.c \
	maple.ms idl-functions.pro


all: $(EXECS)

#
# Floating-point demo
#

# Simple link of the FP programs
fpdemo: fpdemo.c
	$(CC) $(DEFS) -o $@ fpdemo.c

dfpp: fpp.c bytesex.h
	$(CC) $(DEFS) -DDOUBLEPRECISION=1 -o $@ fpp.c

fpp: fpp.c bytesex.h
	$(CC) $(DEFS) -DDOUBLEPRECISION=0 -o $@ fpp.c

bytesex.h: islittleendian
	echo '#define BIGENDIAN' `if ./islittleendian; then echo 0; else echo 1;fi` >$@

islittleendian: islittleendian.c

#fpp: fpp.o
#	$(LINK.C) $(DEFS) -o $@ fpp.o $(LDLIBS)

#
# Compile all three profiled programs with the $(PROFILING) flag, 
# to enable us to use the profiler.
# 
p1.o: p1.f
	$(F77) $(PROFILING) -c p1.f

p2.o: p2.f
	$(F77) $(PROFILING) -c p2.f

p3.o: p3.f
	$(F77) $(PROFILING) -c p3.f

timewaster: p1.o p2.o p3.o
	$(F77) -o $@ $(PROFILING) p1.o p2.o p3.o

#
# Compile and link the mixed-language demo.
#
mixed: mixed-f.o mixed-c.o
	$(LINK.F) -o mixed mixed-c.o mixed-f.o

# Compile the Fortran code with no trailing underscores
mixed-f.o: mixed-f.f
	$(F77) -c mixed-f.f $(NOUNDERSCORES)

mixed-c.o: mixed-c.c
	$(CC) -c mixed-c.c


######################################################################
#
# Following are maintenance targets
#

# Create SGML-ised versions of the example programs (with < and & escaped)
%.sgml: %
	sed -e 's/&/\&amp;/g' -e 's/</\&lt;/g' $< > $@

sgmlexamples: $(EXAMPLES:=.sgml)

# Tar up the current directory, folding in the version number stored
# in file ../VERSION
sc13-examples.tar: configure
	DIRNAME=sc13.`cat ../VERSION`-examples; \
		mkdir $$DIRNAME; \
		for f in ../VERSION Makefile.in configure $(EXAMPLES) gausssine.dat; \
			do ln $$f $$DIRNAME/$$f; \
		done; \
		sed 's/%%VERSION%%/'`cat ../VERSION`/ README.in >$$DIRNAME/README; \
		tar cf $$DIRNAME.tar $$DIRNAME; \
		ln -s $$DIRNAME.tar $@; \
		rm -Rf $$DIRNAME

%.gz: %
	gzip -9 $<

configure: config/configure.in
	autoconf $< >$@
	chmod 755 configure

tidy:
	rm -f *~ core gmon.out timewaster.gprof *.gz

clean: tidy
	rm -f *.o $(EXECS) $(EXAMPLES:=.sgml)

distclean: clean
	rm -f Makefile bytesex.h config.cache config.log config.status
