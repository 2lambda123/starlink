\chapter{\xlabel{pol2_dr}POL-2 Data Reduction - Running pol2map}
\label{sec:rundr}

The previous chapter, \cref{Chapter}{pol2_dr} described how pol2 map produces I Q and U maps from raw POL-2 data. 
This chapter describes how to use the command. 

As with the other Python scripts in SMURF, you can get more information about the available
parameters by doing either:
\begin{terminalv}
% pol2map --help
\end{terminalv}
or
\begin{terminalv}
% smurfhelp pol2map
\end{terminalv}

\section{\xlabel{how-pol2map}How to use pol2map}

Before running pol2map directly, you need to ensure that the Starlink environment has been 
initialised and the Smurf package started (see
\cref{Section}{sec:starinit}{Initialising Starlink} and
\cref{Section}{sec:packinit}{KAPPA and SMURF for data processing}).
To run pol2map you need to supply values for the 
following command-line parameters\footnote{Note the distinction between
``command-line parameters'' (also known as ``ADAM'' parameters) that are
supplied on the \texttt{makemap} command line, and ``configuration parameters''
that are specified within a configuration file. Values for all
\emph{configuration} parameters are obtained using a single \emph{command-line}
parameter called \texttt{CONFIG}.}:



\begin{aligndesc}
\item[\texttt{IN}] A list of input NDFs containing raw POL-2 data. 
There are many ways in which the list of files can be supplied,
as described in Section ``\xref{Specifying Groups of Objects}{sun95}{se_groups}''
in \xref{SUN/95}{sun95}{}. The easiest is to create a simple text
file containing the names of the raw data files -- one per line --- and
then supply the name of the text file, preceded by an up-caret character
(\,\texttt{\^{}}\,), as the value for parameter \texttt{IN}. Note, the names of
the raw data files can contain wild-cards such as ``$*$'' and ``?''.

\item[\texttt{IOUT}] 
The name of the NDF in which to store the the total intensity (I) map
including all supplied observations. The supplied file name should either have a file type of
``\texttt{.sdf}'', or no file type at all (in which case \texttt{.sdf}
will be appended to the supplied value). Any existing file with the same
name will be over-written.

\item[\texttt{QOUT}] 
The output NDF in which to return the Q map including all supplied
observations. This will be in units of pW. Supply null (!) if no Q
map is required.


\item[\texttt{UOUT}] 
The output NDF in which to return the U map including all supplied
observations. This will be in units of pW. Supply null (!) if no U
map is required.

\item[\texttt{MAPDIR}] 
The name of a directory in which to put the Q, U an I maps made
from each individual observation supplied via "IN", before
coadding them. If
null is supplied, the new maps are placed in the same temporary
directory as all the other intermediate files and so will be
deleted when the script exists (unless parameter RETAIN is set
TRUE). Note, these maps are always in units of pW. Each one will
contain FITS headers specifying the pointing corrections needed
to align the map with the reference map. [!]


\item[\texttt{QUDIR}] 
The name of a directory in which to put the Q, U and I time series
generated by SMURF:CALCQU, prior to generating maps from them. If
null (!) is supplied, they are placed in the same temporary directory
as all the other intermediate files and so will be deleted when the
script exists (unless parameter RETAIN is set TRUE). [!]


\end{aligndesc}

\section{\xlabel{how-step1}Running pol2map - step 1}

As discussed in \cref{Chapter}{sec:dr}{POL-2 Data Reduction - The Theory} we must first run pol2map on the raw data to produce an mask for our second and third pol2map reduction steps.

In this first step we run:

\begin{terminalv}
% pol2map in=^myfiles.list iout=iauto qout=! uout=! mapdir=maps qudir=qudata
\end{terminalv}

Here, the file \texttt{myfiles.lis} contains a list of the raw data
files to be included in the map, and could for instance look like this:

\begin{terminalv}
% cat myfiles.lis
/jcmtdata/raw/scuba2/s8a/20160125/00043/*
/jcmtdata/raw/scuba2/s8b/20160125/00043/*
/jcmtdata/raw/scuba2/s8c/20160125/00043/*
/jcmtdata/raw/scuba2/s8d/20160125/00043/*
\end{terminalv}

This uses all available data for all four 850\,$\mu$m sub-arrays, for
observation 43 taken on 25th January 2016\footnote{The input files should all be
for a single waveband and a single observation from a POL-2 observation --- do not mix files from
different wavebands and/or astronomical regions}. In addition the data used in this example also
comes from observation 56 and 59 taken on January 11th 2016


\begin{terminalv}
Logging to file pol2map.log
Calculating Q, U and I time streams from raw analysed intensity data...
   1/1: Processing 116 raw data files from observation 20160125_00043 ...

>>>>   Making I map from 20160125_00043_0003...

Storing pointing corrections of (0.0,0.0) arc-seconds for future use
\begin{terminalv}


\section{\xlabel{how-step23}Running pol2map - steps 2 \& 3}


As discussed in \cref{Chapter}{sec:dr}{POL-2 Data Reduction - The Theory} we take the output from the initial run of pol2map  

The second and third steps of the POL-2 data reduction process,  can be run in a single command

\begin{terminalv}
% pol2map in=qudata/\* iout=iext qout=qext uout=uext mapdir=maps mask=iauto \
          maskout1=astmask maskout2=pcamask ipref=iext cat=mycat debias=yes
\end{terminalv}


\begin{terminalv}
%
\end{terminalv}


\begin{terminalv}
%
\end{terminalv}

