#! /bin/sh -
# @configure_input@
#
# Create a starconf script which packages current versions of important files
#
# Usage:
#    make-starconf file...
#
# `file' has the format '[<option>*]<file>[:<sourcefile>].
#
# The file <sourcefile> is packaged up and unpacked as <file>.  If
# [:<sourcefile>] is omitted, then <sourcefile>=<file>.  This allows us to say
# "acinclude.m4:starconf.m4", so that the starconf.m4 file in the
# current directory doesn't have to be called acinclude.m4, which
# would confuse things.
#
# The <option> characters are `?', `!' and `*'.
#
#     If the files start with a `?' then they are optionally unpacked,
#     depending on logic contained within this script, which is kept
#     consistent with the requirements of macros in starconf.m4.in.
#     That is, files which do not have a `?' <option> are always
#     unpacked. 
#
#     If the <option> includes `!' then the file is will overwrite any
#     file of the same name in the directory in which the `starconf'
#     script is run; if the <option> `!' is not present, then the
#     script will not overwrite a file named <file> if one exists in
#     the directory.  Thus files which the starconf package `owns'
#     (such as the `acinclude.m4' file) should be given with a `!'
#     option, and ones which it merely provides if they are not
#     present (such as the `component.xml.in' file) should not have a
#     `!' option. 
#
#     If the <option> includes `*', then the corresponding file is
#     made executable after it is extracted.
#
# This script generates a starconf script which has the specified
# files contained within it.  When the (generated) starconf script is
# run in a development directory, it runs starconf-validate to check
# that the configuration is OK, and builds a list of files to extract.  It
# extracts these into a script, `starconf.status', which does nothing
# other than unpack the files, and then execs the script; the user may
# also run the `starconf.status' script to regenerate them, and it is
# this script which can be checked into a repository.
#
# Yes, we are indeed more cunning than a nest of monkeys.
#
#
# The starconf.status file that results from the above gymnastics
# contains configuration files that are required for the build, but
# since it is checked in, it should not contain any configuration
# paths.  Therefore after it unpacks the files, starconf.status
# configures the unpacked files by substituting variables indicated by
# !!variable_name!!, using values given either on the starconf.status
# command line or in the environment.  The starconf script handles
# this by invoking the starconf.status script with arguments whose
# values come from the installation-time configuration of starconf.
#
#
# Dependencies:
#   Currently none




# Check we have at least one argument
if test $# -eq 0; then
    echo "Usage: $0 chunkname [chunkname...]"
    exit 1
fi
allconfchunks="$@"

# The list of option characters
optchars="?!\*"

# Find all the files which are always extracted -- that is, all the
# files which do not have a `?' <option>
defaultchunklist=
for c in $allconfchunks
do
    if expr $c : "[$optchars]*?" >/dev/null; then
        : skip it
    else
        defaultchunklist="$defaultchunklist $c"
    fi
done

# Find all the !!variables!! which are to be substituted.  For the
# moment, just hard-wire this, but for full generality we should grep
# the input files for strings matching !!\([A-Za-z0-9_]*\)!!
allconfsubs="DEFAULT_STARLINK DEFAULT_PREFIX"


# Start generating the output -- open FD 3 for the generated script
outputscript=starconf
exec 3>$outputscript

cat >&3 <<\_STARCONF3_EOD
#! /bin/sh -
#
# This is starconf, version @PACKAGE_VERSION@

# Configuration
bindir=@bindir@
datadir=@datadir@
ln_s="@LN_S@"
curr_starconf_version="@PACKAGE_VERSIONINT@"

# Always include the following files:
_STARCONF3_EOD
echo "defaultchunks=\"$defaultchunklist\"" >&3
cat >&3 <<\_STARCONF3_EOD
# Extra chunks should be added to this variable, according to logic below
extrachunks=""

# Make sure we have a configure.ac in the current directory
if test -r configure.ac -a Makefile.am; then
    : OK
else
    echo "$0: can't find readable configure.ac and Makefile.am"
    echo "    ...see $datadir for templates"
    exit 1
fi

# If we can find a starconf-validate script (that is, if we're on a build
# system, which has starconf installed, rather than a distribution system)
# then run starconf-validate to make sure everything's OK.  Call it
# with the --force option, so that this will succeed, albeit with
# warnings, the very first time that starconf is run in a directory,
# before the user has had the chance to check in Makefile.in and friends.
if test -x $bindir/starconf-validate; then
    if $bindir/starconf-validate --force .; then
        : OK
    else
        echo "$0: Configuration not valid -- fix above errors first"
        exit 1
    fi
fi

if test -e bootstrap; then
    # Check the `bootstrap' file, to see if the first word on the second line
    # is `original'.  If it is, then unpack the bootstrap file, overwriting
    # any bootstrap file that's already there.
    eval `sed -e '1d' -e '2{s/^[^a-z]*\([a-z]*\).*rnum=\([0-9]*\)/original=\1; bootstrap_version=\2;/;q;}' bootstrap`
    # echo "XXX original=$original  rnum=$bootstrap_version curr=$curr_starconf_version"
    if test "X$original" != Xoriginal; then
        : do nothing -- file has been modified
    elif test $bootstrap_version -lt $curr_starconf_version; then
        extrachunks="$extrachunks !*bootstrap"
    else
        : do nothing -- file is up to date
    fi
else
    # No `bootstrap' file, so unpack one
    extrachunks="$extrachunks bootstrap"
fi

# Scan configure.ac, getting all the used STAR_* macros into a string
starmacros=`sed -n 's/^\(STAR[_A-Z]*\).*/\1/p' configure.ac | sed '{:a;N;s/\n/ /;t a;}'`

# Certain macros depend on certain additional files.  Scan the list of
# used macros, and add the required files to $extrachunks.  There are
# currently no macros in starconf.m4.in which require such files, but
# if they are added, the dependencies should be documented here.
found_star_defaults=false
for foundmacro in $starmacros dummy
do
    case $foundmacro in
        STAR_DEFAULTS)
            found_star_defaults=true
            ;;
        *) ;;
    esac
done

# Check that we did find a STAR_DEFAULTS macro in the configure.ac,
# and object if we didn't.
if $found_star_default; then
    : OK
else
    echo "$0: configure.ac has no STAR_DEFAULTS macro"
    exit 1
fi

# Similarly, scan Makefile.am and check that there it includes
# Makefile.starconf
if grep 'include .*Makefile.starconf' Makefile.am >/dev/null; then
    echo "$0: Makefile.am still includes \$(srcdir)/Makefile.starconf"
    exit 1
else
    : OK -- should not be there
fi
# if grep 'include .*Makefile.starconf' Makefile.am >/dev/null; then
#     : OK -- found it
# else
#     echo "$0: Makefile.am does not include \$(srcdir)/Makefile.starconf"
#     exit 1
# fi

# We now know what files we're going to include in the generated
# starconf.status
filelist=" $defaultchunks $extrachunks "
# echo "XXX filelist=$filelist"

# Make sure there's a link to the installed componentinfo.dtd
test -e componentinfo.dtd || $ln_s $datadir/componentinfo.dtd componentinfo.dtd

# Start writing the starconf.status file; send output to FD 4
exec 4>starconf.status
cat >&4 <<EOF
#! /bin/sh -
#
# This is starconf.status: generated by starconf, version @PACKAGE_VERSION@
# DO NOT EDIT: your changes will be overwritten next time starconf is run
#
# Usage:
#     ./starconf.status [variable=value ...]
# where VARIABLE is one of the variables
#     $allconfsubs
# This substitutes instances of !!variable!! in the file(s) below,
# when they are unpacked.
#
# Re-run this file to regenerate the files listed below:
EOF
for f in $filelist
do
_STARCONF3_EOD
echo "    echo \$f | sed \"s/^[$optchars]*\([^:]*\).*/#    \1/\" >&4"    >&3
echo 'done'                                                              >&3
echo 'echo "" >&4'                                                       >&3

echo "echo 'allconfsubs=\"$allconfsubs\"' >&4"                           >&3
cat >&3 <<\_STARCONF3_EOD
cat >&4 <<\_STARCONF4_EOD
sedsubsts=
# Process the arguments, which are variable=value pairs, processing
# then into a collection of sed substitutions.  No spaces in the `value'!
while test $# -gt 0
do
    expr "$1" : '.*=' >/dev/null || \
        { echo "Usage: $0 [variable=value...]"; exit 1; }
    sedsubsts="$sedsubsts "`echo $1 | sed 's/\(.*\)=\(.*\)/-e s,!!\1!!,\2,/'`
    shift
done
if test -n "$allconfsubs"; then
    for s in $allconfsubs
    do
        if expr "x$sedsubsts" : "x.*!!$s!!" >/dev/null; then
            : OK
        else
            eval sval='${'$s'}'
            if test -n "$sval"; then
                sedsubsts="$sedsubsts -e s,!!$s!!,$sval,"
            else
                echo "$0: no value for config variable $s, supply one with 'starconf.status $s=xxx' or 'env $s=xxx starconf.status'"
                exit 1
            fi
        fi
    done
fi
if test -n "$sedsubsts"; then
    sedsubsts="sed $sedsubsts"
fi
_STARCONF4_EOD
_STARCONF3_EOD

# Start the extraction of the files
echo 'echo "allm4=" >&4'                                                 >&3
echo 'echo "allextracted=" >&4'                                          >&3
  
for ch in $allconfchunks
do
    # extract the options, destination and source filenames
    eval `echo $ch | sed 's/\(['$optchars']*\)\([^:]*\)\(:\(.*\)\)*/opts=\1;filename=\2; filesource=\4/'`
    test -n "$filename" || { echo "Impossible: null filename"; exit 1; }
    test -n "$filesource" || filesource=$filename
    echo "Including $filename from $filesource (opts=$opts)"

    # Don't just cat to &3 here -- we need to be careful about quoting
    echo ""                                                              >&3
    echo "# -------------------- $filename --------------------"         >&3
    echo "echo '# ---------- $filename ----------'       >&4"            >&3

    # Handle the ! option
    echo 't=`expr "x $filelist" : "x .* \(['$optchars']*\)'$filename'"`' >&3
    echo '# If the ! option is present, ...'                             >&3
    echo 'if expr "x$t" : "x.*\(!\)" >/dev/null; then'                   >&3
    echo '    # ...then just unpack the file (stomp stomp stomp)'        >&3
    echo '    echo unpack_this=true                      >&4'            >&3
    echo 'else'                                                          >&3
    echo '    # ...but if not, then only unpack the file if'             >&3
    echo '    # there is no such file in the current directory'          >&3
    echo '    # (ie, avoid stomping on modified files)'                  >&3
    echo "    echo 'if test -e $filename; then unpack_this=false; else unpack_this=true;fi' >&4" >&3
    echo 'fi'                                                            >&3

    # do the unpacking
    echo "echo 'if \$unpack_this; then'                  >&4"            >&3
    echo "echo '    echo \"Creating $filename\"'         >&4"            >&3
    echo "echo '    cat >$filename <<\_STARCONF_EOD'     >&4"            >&3
    echo 'cat >&4 <<\_STARCONF_EOD'                                      >&3
    cat $filesource                                                      >&3
    echo '_STARCONF_EOD'                                                 >&3
    echo 'echo _STARCONF_EOD                             >&4'            >&3
    # Is this file to be made executable (* option present)?
    if expr "$opts" : '.*\*' >/dev/null; then
        echo "echo '    chmod +x $filename'              >&4"            >&3
    fi
    echo "echo 'else'                                    >&4"            >&3
    echo "echo '    echo \"File $filename already exists, not overwriting\"'>&4 ">&3
    echo "echo 'fi'                                      >&4"            >&3
    echo "echo 'expr $filename : \".*m4\$\" >/dev/null && allm4=\"\$allm4 $filename\"' >&4" >&3
    echo "echo 'allextracted=\"\$allextracted $filename\"' >&4"          >&3
#    echo 'fi'                                                            >&3
done

cat >&3 <<\_STARCONF3_EOD
cat >&4 <<\_STARCONF4_EOD

# -------------------- Tidy up and finish -------------------- 
if test -n "$allextracted"; then
    # There were at least some files extracted
    if test -n "$sedsubsts"; then
        for f in $allextracted
        do
            rm -f $f.tmp
            $sedsubsts $f >$f.tmp
            # retain any execute bit
            test -x $f && chmod +x $f.tmp
            mv $f.tmp $f
        done
    fi
fi
if test -n "$allm4"; then
    echo "Creating acinclude.m4 from$allm4"
    cat $allm4 >acinclude.m4
fi
exit 0
_STARCONF4_EOD
# Close the starconf.status file
exec 4>&-
# ...and make it executable
chmod +x starconf.status
# Finally, exec the new script
exec ./starconf.status DEFAULT_STARLINK=@DEFAULT_STARLINK@ DEFAULT_PREFIX=@DEFAULT_PREFIX@
_STARCONF3_EOD

echo "exit 0" >&3

# Close FD 3; the starconf file
exec 3>&-
# ...and make it executable
chmod +x $outputscript

exit 0
