# E.S.O. - VLT project/ESO Archive
# $Id: Makefile.in,v 1.2 2003/01/20 20:47:11 brighton Exp $
#
# Makefile.in - Makefile to create the "skycat" binary
#               (uses Scriptics Tclpro to create one binary with tcl scripts loaded)
#
# This file is processed by configure to produce the actual Makefile.
#
# who             when       what
# --------------  ---------  ---------------------------------------------
# Allan Brighton  29 Oct 98  Created
# ------------------------------------------------------------------------

DEFINES      = @DEFS@

CFLAGS       = @CXXDEBUGFLAGS@

# C compiler
CC 	     = @CC@

# C++ compiler
CXX          = @CXX@

# install directories
TOPDIR	     = @DESTDIR@
BINDIR       = @BINDIR@
SKYCAT_DIR   = @SKYCAT_DIR@

# set to 1 if shared libs were enabled with --enable-shared configure option
SHARED       = @SHARED@

# ------------------------------------------------------------------------
#       Include directives for Tcl, Tk, and X include files 
# ------------------------------------------------------------------------

TCL_INCLUDE   = @TCLINCSW@
TK_INCLUDE    = @TKINCSW@
X_INCLUDE     = @XINCSW@

# ------------------------------------------------------------------------
#       Libraries for Tcl, Tk, X11, BLT, etc.
# ------------------------------------------------------------------------
# note: using shared X libs might cause problems if end user has different 
# library versions, but it is needed for plugins that might access more
# Xlib functions than skycat does.
# 
X_LIB        = @XLIBSW@

# Tclpro runtime library (XXX configure this)
TCLPRO_DIR   = @TCLPRO_DIR@
TCLPRO_MACH_DIR  = @TCLPRO_MACH_DIR@
TCLPRO_LIBDIR = @TCLPRO_LIB_DIR@
TCLPRO_LIBS  = @TCLPRO_LIBS@
TCLPRO_INCLUDE = @TCLPRO_INCLUDE@
TCLPRO_WRAP  = @TCLPRO_WRAP@

# static tcl/tk archives: use tclpro, if available
TCL_LIB      = @TCLPRO_TCL_LIB@
TK_LIB       = @TCLPRO_TK_LIB@
ITCL_LIB     = @TCLPRO_ITCL_LIB@
TCLX_LIB     = @TCLPRO_TCLX_LIB@
BLT_LIB      = @BLT_LIB_SPEC_STATIC@

# config file used to hold arguments to prowrap
TCLPRO_CONFIG  = prowrap.cfg

EXTRA_LIBS   = @LIBS@

TCL_LIBS     = \
	$(TCLPRO_LIBS) \
	$(ITCL_LIB) \
	$(TCLX_LIB) \
	$(BLT_LIB) \
	$(TK_LIB) \
	$(TCL_LIB)

# skycat lib
SKYCAT_LIB  = ../libskycat.a

# ------------------------------------------------------------------------
# tcl script to load all of the tcl library files
INIT_SCRIPT  = library/skyCatInit.tcl

# first script loaded, starts skycat
START_SCRIPT  = library/skyCatStart.tcl

# name of tcl interpreter to use to run $(INIT_SCRIPT)
TCL_INTERP   = ../interp/bin/skycat_tcl

# name of the base wish interpreter to use to create the tclpro wrapper
WISH_INTERP   = skycat_wish

# name of program
PROG         = bin/skycat-@OSVERSION@

# include flags
INCLUDES     = $(TK_INCLUDE) $(TCL_INCLUDE) $(X_INCLUDE) $(TCLPRO_INCLUDE)

# compiler flags
CC_SWITCHES  = $(DEFINES) $(INCLUDES) $(CFLAGS)

# libraries to link
LIBRARIES    = \
	$(SKYCAT_LIB) \
	$(TCL_LIBS) \
	$(X_LIB) \
	$(EXTRA_LIBS)

# shared library flags
LD_SEARCH_FLAGS=@LD_SEARCH_FLAGS@
LIB_RUNTIME_DIR=@LIB_RUNTIME_DIR@
LD_FLAGS=@LD_FLAGS@

# these objects are only needed to make the skycat_wish binary for the demos
OBJECTS      = proTkUnixMain.o proWrapTkMain.o

INSTALL      = @INSTALL@
RANLIB 	     = @RANLIB@
SHELL 	     = /bin/sh
RM 	     = rm -f
LN 	     = ln -s

# locations of Tcl library files
TCLUTIL_LIBRARY=@TCLUTIL_BUILD_LIBRARY@
ASTROTCL_LIBRARY=@ASTROTCL_BUILD_LIBRARY@
RTD_LIBRARY=@RTD_BUILD_LIBRARY@
CAT_LIBRARY=@CAT_BUILD_LIBRARY@
SKYCAT_LIBRARY=@SKYCAT_BUILD_LIBRARY@
BLT_LIBRARY=@BLT_LIBRARY@

# ------------------------------------------------------------------------
all: $(PROG) 

# build the tclpro wrapped skycat executable
$(PROG): $(WISH_INTERP) $(TCLPRO_CONFIG)
	$(TCLPRO_WRAP) \
		-executable $(WISH_INTERP) \
		-out $(PROG) \
		$(START_SCRIPT) \
		`cat $(TCLPRO_CONFIG)`

# build the wish interpreter
# Note: TODO: Need to add -static-libgcc for gcc-3.2.1 to avoid shared lib dependency
$(WISH_INTERP): $(OBJECTS) $(TCL_LIBS) $(SKYCAT_LIB) 
	@echo "linking \"$(WISH_INTERP)\"..."
	$(CXX) $(LD_FLAGS) $(CC_SWITCHES) $(OBJECTS) \
	    -o $(WISH_INTERP) -L. $(LD_SEARCH_FLAGS) $(LIBRARIES)
	strip $(WISH_INTERP)

$(TCLPRO_CONFIG): FORCE
	TCLUTIL_LIBRARY=$(TCLUTIL_LIBRARY); export TCLUTIL_LIBRARY; \
	ASTROTCL_LIBRARY=$(ASTROTCL_LIBRARY); export ASTROTCL_LIBRARY; \
	RTD_LIBRARY=$(RTD_LIBRARY); export RTD_LIBRARY; \
	CAT_LIBRARY=$(CAT_LIBRARY); export CAT_LIBRARY; \
	SKYCAT_LIBRARY=$(SKYCAT_LIBRARY); export SKYCAT_LIBRARY; \
	BLT_LIBRARY=$(BLT_LIBRARY); export BLT_LIBRARY; \
	$(TCL_INTERP) $(INIT_SCRIPT) $(TCLPRO_CONFIG)

install-top:
	@test -d $(TOPDIR) || mkdir $(TOPDIR)

install-bin: 
	@test -d $(BINDIR) || mkdir $(BINDIR)
	$(INSTALL) $(PROG) $(BINDIR)

install: install-top install-bin

clean:
	$(RM) $(OBJECTS) *.o $(PROG) $(WISH_INTERP) *\~ "#"* $(TCLPRO_CONFIG)

distclean: clean
	$(RM) Makefile

depend:

man:

FORCE:

.SUFFIXES: .C
.c.o:
	$(CC) -c $(CC_SWITCHES) $<

.C.o:
	$(CXX) -c $(CC_SWITCHES) $<

