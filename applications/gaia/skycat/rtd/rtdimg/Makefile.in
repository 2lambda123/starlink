# E.S.O. - VLT project 
# "@(#) $Id: Makefile.in,v 1.2 2005/02/02 01:43:03 brighton Exp $"
#
# who             when      what
# --------------  --------  ----------------------------------------
# Allan Brighton  05/12/95  Created
# ------------------------------------------------------------------------

# run make in these sub directories
SUBDIRS      = include bitmaps colormaps src images man library demos test


# -D flags
DEFINES      = 	-DSHARED=@SHARED@

# info needed for shared libraries (see configure.in or tclConfig.sh for an explanation)
SHLIB_CFLAGS		= @SHLIB_CFLAGS@
SHLIB_LD		= @SHLIB_LD@
SHLIB_SUFFIX		= @SHLIB_SUFFIX@
SHLIB_LD_LIBS		= @SHLIB_LD_LIBS@
DL_LIBS			= @DL_LIBS@
LD_FLAGS		= @LD_FLAGS@
LD_SEARCH_FLAGS		= @LD_SEARCH_FLAGS@
LIB_RUNTIME_DIR		= @LIB_RUNTIME_DIR@
LIB_STDCPP		= @LIB_STDCPP@

# ------------------------------------------------------------------------

# name of wish binary to generate
demo_wish    = bin/rtdimage_wish

# include flags
INCLUDES     = -I. -Iinclude -Isrc $(TK_INCLUDE) $(TCL_INCLUDE) $(X_INCLUDE)

# compiler flags
CC_SWITCHES  = $(DEFINES) $(INCLUDES) $(CFLAGS)

# local library base names
RTDIMAGE_LIB  = rtdimage
RTDIMGEVT_LIB = rtdImgEvt
RTI_LIB       = rti

# local library path names
RTDIMAGE_LIBDIR  = ./lib
RTDIMGEVT_LIBDIR = ../rtdevt/lib
RTI_LIBDIR       = ../rtilib/lib

# local library full names
RTDIMAGE_LIBRARY = $(RTDIMAGE_LIBDIR)/lib$(RTDIMAGE_LIB).a
RTI_LIBRARY	 = $(RTI_LIBDIR)/lib$(RTI_LIB).a
RTDIMGEVT_LIBRARY= $(RTDIMGEVT_LIBDIR)/lib$(RTDIMGEVT_LIB).a

LOCAL_LIBRARIES = \
	$(RTDIMAGE_LIBRARY) \
	$(RTI_LIBRARY) \
	$(RTDIMGEVT_LIBRARY) \
	$(ASTROTCL_LIB_STATIC) \
	$(TCLUTIL_LIB_STATIC)

# local library search paths and flags
LIBS_RTD_SEARCH  = \
	-L$(RTDIMAGE_LIBDIR) \
	-L$(RTI_LIBDIR) \
	-L$(RTDIMGEVT_LIBDIR)

LIBS_RTD         = \
	-l$(RTDIMAGE_LIB) \
	-l$(RTI_LIB) \
	-l$(RTDIMGEVT_LIB)

# these objects are only needed to make the rtdimage_widh binary for the demos
OBJECTS      = tkAppInit.o


# ------------------------------------------------------------------------
# Make the libs and a sample wish binary with Rtd included.
# Note: if the Rtd shared lib was created, we don't link it here,
# but load it at run time from Tcl. Otherwise it is linked in as a
# static library.
do_all $(demo_wish): lib  $(LOCAL_LIBRARIES) $(OBJECTS) tkAppInit.o
	$(AT)if test @SHARED@ -eq 1 ; then \
	  $(CXX) $(LD_FLAGS) $(CC_SWITCHES) $(OBJECTS) -o $(demo_wish) \
	         $(LD_SEARCH_FLAGS) $(TCLTKLIBS) $(X_LIB) $(EXTRA_LIBS) $(LIB_STDCPP) $(DL_LIBS) ;\
	else \
	  $(CXX) $(LD_FLAGS) $(CC_SWITCHES) $(OBJECTS) -o $(demo_wish) \
	         $(LD_SEARCH_FLAGS) $(LIBS_RTD_SEARCH) $(LIBS_RTD) \
		 $(ASTROTCL_LIB) $(TCLUTIL_LIB)  $(TCLTKLIBS) \
		 $(X_LIB) $(EXTRA_LIBS) $(LIB_STDCPP) ;\
	fi
	@(cd demos; $(MAKE))
	@(cd test; $(MAKE))

tkAppInit.o: tkAppInit.C
	$(CXX) -c $(CC_SWITCHES) tkAppInit.C

# force recompile after configure for ifdefs
$(OBJECTS): ../config.status

$(RTDIMAGE_LIBRARY) lib:
	$(AT)for i in bitmaps colormaps src demos; do (cd $$i; $(MAKE)) || exit 1; done

install-top:
	@test -d $(TOPDIR) || mkdir $(TOPDIR)
	@test -d $(LIBDIR) || mkdir $(LIBDIR)
	@test -d $(BINDIR) || mkdir $(BINDIR)

install-bin:
	@test -d $(BINDIR) || mkdir $(BINDIR)
	@chmod 0755 $(demo_wish)
	$(AT)$(INSTALL) $(demo_wish) $(BINDIR)

install-man: 
	@(cd man; $(MAKE) install)

install-lib:
	@(cd src; $(MAKE) install)
	@(cd include; $(MAKE) install)

install-demos:
	@(cd demos; $(MAKE) install)

install-images:
	@(cd images; $(MAKE) install)

install-test:
	@(cd test; $(MAKE) install)

install-colormaps:
	@(cd colormaps; $(MAKE) install)

install-library:
	@(cd library; $(MAKE) install)

install-bitmaps:
	@(cd bitmaps; $(MAKE) install)

do_install: install-top install-library install-demos \
	install-bin install-lib install-bitmaps install-man \
	install-colormaps install-images install-test 

do_clean:
	$(AT)$(RM) $(OBJECTS) $(demo_wish) *\~ "#"*
	$(AT)for i in $(SUBDIRS); do (cd $$i; $(MAKE) $@) done
	$(AT)$(RM) demos/tRtd

do_distclean: clean
	$(AT)for i in $(SUBDIRS); do (cd $$i; $(MAKE) $@) done

do_depend:
	-$(AT)cd src; $(MAKE) depend

do_man:
	$(AT)for i in $(SUBDIRS); do (cd $$i; $(MAKE) $@) done

include ../makefile.mk
