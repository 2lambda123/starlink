# $Id$
#
# Makefile.in - Makefile for creating gaia standalone executable.
#
# This file is processed by configure to produce the actual Makefile.
#
# who             when       what
# --------------- ---------- ---------------------------------------------
# Peter W. Draper 6-Oct-1997 Created
# --------------- ---------- ---------------------------------------------

#  C compiler
CC 	     = @CC@

#  C++ compiler
CXX          = @CXX@

#  Libtool link command.
LIBTOOL      = @LIBTOOL@
LTLINK       = $(LIBTOOL) --mode=link $(CXX) $(CFLAGS)

# Static/dynamic non-atask linker flags
LDFLAG1 =
LDFLAG2 =

#  -D flags
DEFINES      = -DSHARED=@SHARED@ @TCLUTIL_DEFS@ \
               -DGAIA_LIBRARY=\"@GAIA_BUILD_LIBRARY@\"

#  Other flags to pass to compiler
CFLAGS       = @CXXDEBUGFLAGS@

#  Install directories
TOPDIR	     = @DESTDIR@
BINDIR       = @BINDIR@
LIBDIR       = @LIBDIR@
INSTALL_TARGET = @INSTALL_TARGET@

#  Include directives for Tcl, Tk, and X include files
TCL_INCLUDE   = @TCLINCSW@
TK_INCLUDE    = @TKINCSW@
X_INCLUDE     = @XINCSW@

#  X Libraries
X_LIB        = @XLIBSW@
EXTRA_LIBS   = @LIBS@

#  Tcl libs
TCLLIBS =  @TCLX_LIB_SPEC@ \
           @ITCL_LIB_SPEC@ \
           @TCL_LIB_SPEC@ 

#  Tk libs
TKLIBS = @ITK_LIB_SPEC@ \
         @TIX_LIB_SPEC@ \
         @TK_LIB_SPEC@ \
         @BLT_LIB_SPEC@ \
         ../tkhtml/libtkhtml.a

#  Tcl/Tk libs
TCLTKLIBS = $(TCLLIBS) $(TKLIBS)

#  Tclutil library
TCLUTIL_LIB          = -ltclutil
TCLUTIL_LIB_STATIC   = @TCLUTIL_LIB_STATIC@

#  Astrotcl library
ASTROTCL_LIB         = -lastrotcl
ASTROTCL_LIB_STATIC  = @ASTROTCL_LIB_STATIC@

#  Rtd library
RTD_LIB              = -lrtd
RTD_LIB_STATIC       = @RTD_LIB_STATIC@

#  Catalog library
CAT_LIB              = -lcat
CAT_LIB_STATIC       = @CAT_LIB_STATIC@

#  Skycat libraries
SKYCAT_LIB	     = -lskycat
SKYCAT_LIB_STATIC    = @SKYCAT_LIB_STATIC@

#  Local GAIA library.
LOCAL_LIBRARY = ../lib/libgaia.a

#  Info needed for shared libraries (see configure.in or tclConfig.sh
#  for an explanation)
SHLIB_CFLAGS=@SHLIB_CFLAGS@
SHLIB_LD=@SHLIB_LD@
SHLIB_SUFFIX=@SHLIB_SUFFIX@
SHLIB_LD_LIBS=@SHLIB_LD_LIBS@
DL_LIBS=@DL_LIBS@
LD_FLAGS=@LD_FLAGS@
LD_SEARCH_FLAGS=@LD_SEARCH_FLAGS@ -L$(LIBDIR)
LIB_RUNTIME_DIR=@LIB_RUNTIME_DIR@

# ------------------------------------------------------------------------
#       Libraries required to link against Fortran source code
#       using a C++ compiler.
# ------------------------------------------------------------------------
STARLINK = @STARLINK@
F77_LIBS = @F77_LIBS@
STAR_LIB = @STARLINK@/lib
STAR_INC = @STARLINK@/include
COMPIFL  = @STARLINK@/bin/compifl
#  Define sets of ADAM libraries we need to link against. Note that
#  ast_link and ndf_link must be carefully managed to avoid picking up
#  default AST libraries for errors and graphics.
AST_OPTIONS = -myerr -mygrf -fsla
AST_LIBS = -L$(STAR_LIB) `ast_link $(AST_OPTIONS)` `sla_link`
AST_LIBS_NOGRF = -L$(STAR_LIB) `ast_link -myerr -fsla` `sla_link`
STARTCL_OBJECT = $(STAR_LIB)/tclAdam.o
ADAM_LIBS = -L$(STAR_LIB) `ard_link $(AST_OPTIONS)` `fio_link` $(STARTCL_OBJECT) \
            `ams_link_adam` `ndf_link $(AST_OPTIONS)`  -lpda

#  Name of single binaries
TKPROG = bin/gaia_swish
TCLPROG = bin/gaia_stcl

#  Name of mktclapp converter.
MKTCLAPP = bin/mktclapp

INCLUDES     = $(TK_INCLUDE) $(TCL_INCLUDE) $(X_INCLUDE)

CC_SWITCHES  = $(DEFINES) $(INCLUDES) $(CFLAGS)

#  List of all object files and intermediary sources (used to clean)
OBJECTS      = mktclapp.o gaia_swish.o gaia_stcl.o tkAppInit.o tclAppInit.o
SOURCES      = gaia_swish.c gaia_stcl.c gaia_swish.mta gaia_stcl.mta \
	       gaia_swish.h gaia_stcl.h

INSTALL      = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
RANLIB 	     = @RANLIB@
AR_D         = ar d
SHELL 	     = /bin/sh
RM 	     = rm -f
LN 	     = ln -s

# ------------------------------------------------------------------------
all: $(TKPROG) $(TCLPROG)

$(MKTCLAPP): mktclapp.o
	$(CC) $(CFLAGS) -o $(MKTCLAPP) mktclapp.o

gaia_swish.c: $(MKTCLAPP) library/gaia_swish.tcl
	$(BINDIR)/skycat_tcl library/gaia_swish.tcl gaia_swish.mta
	$(MKTCLAPP) -header > gaia_swish.h
	$(MKTCLAPP) -f gaia_swish.mta > gaia_swish.c

gaia_stcl.c: $(MKTCLAPP) library/gaia_stcl.tcl
	$(BINDIR)/skycat_tcl library/gaia_stcl.tcl gaia_stcl.mta
	$(MKTCLAPP) -header > gaia_stcl.h
	$(MKTCLAPP) -f gaia_stcl.mta > gaia_stcl.c

#  Link wish. 
$(TKPROG): $(MKTCLAPP) gaia_swish.o tkAppInit.o ../initFortran.o FORCE
	@echo "linking \"$(TKPROG)\"..."
	- $(AR_D) $(LIBDIR)/libskycat.a slasubs.o
	- $(RANLIB) $(LIBDIR)/libskycat.a
	$(LTLINK) $(CC_SWITCHES) tkAppInit.o gaia_swish.o ../initFortran.o \
	   -o $(TKPROG)  \
	   $(LDFLAG1) $(LD_SEARCH_FLAGS) $(AST_LIBS) \
	   $(SKYCAT_LIB) $(LOCAL_LIBRARY) \
	   $(AST_LIBS) $(ADAM_LIBS) $(AST_LIBS) $(TCLTKLIBS) \
	   $(X_LIB) $(LDFLAG2) $(EXTRA_LIBS)

$(TCLPROG): $(MKTCLAPP) gaia_stcl.o tclAppInit.o ../initFortran.o FORCE
	@echo "linking \"$(TCLPROG)\"..."
	$(LTLINK) $(CC_SWITCHES) tclAppInit.o gaia_stcl.o ../initFortran.o \
	       -o $(TCLPROG)  \
	       $(LD_SEARCH_FLAGS) \
	       $(LDFLAG1) $(ADAM_LIBS) $(AST_LIBS_NOGRF) $(LOCAL_LIBRARY) $(TCLLIBS) \
	       $(LDFLAG2) $(EXTRA_LIBS)

# initFortran lives in the parent directory
../initFortran.o:
	cd ..; $(MAKE) initFortran.o

install: install-top install-bin

install-top:
	@if test -d $(TOPDIR); then : ; else mkdir $(TOPDIR); fi

install-bin:
	@if test -d $(BINDIR); then : ; else mkdir $(BINDIR); fi
	$(INSTALL) $(TCLPROG) $(BINDIR)
	$(INSTALL) $(TKPROG) $(BINDIR)

clean:
	$(RM) $(OBJECTS) $(TKPROG) $(TCLPROG) $(MKTCLAPP) $(SOURCES)

distclean: clean
	$(RM) Makefile library/gaia_swish.tcl library/gaia_stcl.tcl

depend:

man:

.SUFFIXES: .C
.c.o:
	$(CC) -c $(CC_SWITCHES) $<

.C.o:
	$(CXX) -c $(CC_SWITCHES) $<

FORCE:

