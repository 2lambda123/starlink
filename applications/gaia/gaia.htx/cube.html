<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>Cube handling toolbox</title>
  </head>

  <body>
    <h2 align=center><font color=red>Cube handling toolbox</font></h2>
    <p align="center">
      <img src="cube.gif"/>
    <p>
      Using this toolbox you can interactively display successive images from
      the planes of a cube and <tt>spectra</tt> from the remaining
      dimension. The aim is to be as efficient as possible at these two jobs,
      and very good speed is available on machines whose physical memory is
      greater than the size of the cube.
    </p>

    <h3>Displaying image planes</h3>
    <p>
      To view an image plane from the cube, just select the file containing
      the cube and then use the axis control to choose an axis to step along
      (normally this will be the dispersion/spectral axis) now either type in
      the index of the image that you want to view along that axis and press
      return or drag the slider to move through slices. The image display data
      limits are set once for efficiency, but you can have an autocut applied
      to each slice by selecting the <tt>Autocut</tt> item in the
      <tt>Options</tt> menu.
    </p>
    <p>
      Once an image is displayed you are free to analyse it using the usual
      tools, such as the photometric or image region toolboxes.
    </p>

    <h3>Extracting and displaying spectra</h3>
    <p align="center">
      <img src="spectralplot.gif"/>
    <p>
      <font color="red">Quick start:</font> To display a spectrum extracted
      from a point, just click, using mouse button 1, on a position on the
      image. To see a continuously updating spectrum, click and drag around
      the image. The controls in the <tt>Spectrum</tt> tab offer enhancements
      to this basic behaviour.
    </p>
    <p>
      The extraction limits along the spectral axis are the full range by
      default. To extract a smaller range of values you can use the 
      <tt>Lower index:</tt> and <tt>Upper index:</tt> controls. The new
      extraction limits are not used until you click on the image again.
      To see these limits graphically (that is displayed in the spectrum that
      is already extracted), select <tt>Show limits on plot:</tt>.
    </p>
    <p>
      As well as extracting a spectrum along a point (a pixel), you can
      extract a spectrum defined by a region by drawing an ARD region shape on
      the image. This is done by pressing one of the buttons <tt>Define
      region:</tt> and dragging out a shape on the image. Each value in the
      spectrum is evaluated by combining all the pixels within the region. By
      default this is just a simple mean, but you can choose a median instead
      (this option will be more suited for cleaning up flat regions of sky
      than those with gradients).
    </p>
    <p>
      Note that you can draw more than one shape, but the extracted spectrum
      is just that of the selected shapes. To select more than one shape you
      click on it while holding down the control key. You should also note
      that when interacting with shapes the single pixel extraction mode is
      still enabled, so if you click off the region you will get another
      extracted spectrum. This can be confusing so you can disable this by
      deselecting <tt>Point tracking:</tt>
    </p>
    <p>
      To remove shapes from the image you need to use the <tt>Graphics</tt>
      menu options <tt>Clear</tt> or <tt>Delete</tt>. You are also free to use
      any of the other configuration options in the <tt>Graphics</tt> menu,
      like outline thickness, fill, stipple etc.
    </p>

    <h5>Comparing spectra</h5>
    <p>
      It is possible to have two extracted spectra on display at the same
      time. The second one is known as a reference spectrum. To create a
      reference spectrum press the <tt>Set</tt> in the <tt>Reference:</tt>
      line. This copies the currently extracted spectrum to be the reference
      one (and can be a region extracted spectrum), naturally <tt>Clear</tt>
      removes the reference spectrum. Note that the reference spectrum does
      not take part in the auto-scaling of the plot.
    </p>

    <h3>Cube handling actions</h3>
    <p>
      Other various action tabs of controls are shown in the lower pane. These
      currently allow you to animate through a range of indices, collapse the
      cube to a white-light image, create a "channel map" and subtract a
      fitted baselines.
    <p>
    <h5>Animation</h5>
    <p>
      Using these controls you can automatically step through a range of
      indices. At the end of the range you can choose to either stop 
      (<tt>Off</tt>), continuously start again from the beginning 
      (<tt>On</tt>) or continuously reverse direction 
      (<tt>Rock 'n Roll</tt>). The limits to animate over can be controlled
      using the sliders, or you can select "Show limits on plot:" to interact
      with a graphic displayed over the spectral plot.
    </p>
    <h5>Collapse</h5>
    <p>
      These controls run the KAPPA application COLLAPSE to create white-light
      images of various kinds. The collapse range is controlled as in the
      Animation tab. The combination method provides a wide range of methods,
      including: 
    </p>
    <ul>
      <li> <tt>Mean</tt> - Mean value </li>
      <li> <tt>WMean</tt> - Weighted mean in which each data value is weighted
        by the reciprocal of the associated variance.</li> 
      <li> <tt>Mode</tt> - Modal value</li>
      <li> <tt>Median</tt> - Median value. Note that this is extremely memory
        and CPU intensive for large datasets; use with care!</li>
      <li> <tt>Absdev</tt> - Mean absolute deviation from the unweighted
        mean.</li> 
      <li> <tt>Comax</tt> - Co-ordinate of the maximum value.</li>
      <li> <tt>Comin</tt> - Co-ordinate of the minimum value.</li>
      <li> <tt>Integ</tt> - Integrated value, being the sum of the products of
        the value and pixel width in world co-ordinates.</li> 
      <li> <tt>Iwc</tt> - Intensity-weighted co-ordinate, being the sum of
        each value times its co-ordinate, all divided by the integrated value
        (see the <tt>Integ</tt> option).</li> 
      <li> <tt>Iwd</tt> - Intensity-weighted dispersion of the co-ordinate,
        normalised like <tt>Iwc</tt> by the integrated value.</li> 
      <li> <tt>Max</tt> - Maximum value.</li>
      <li> <tt>Min</tt> - Minimum value.</li>
      <li> <tt>Rms</tt> - Root-mean-square value.</li>
      <li> <tt>Sigma</tt> - Standard deviation about the unweighted mean.</li>
      <li> <tt>Sum</tt> - The total value.</li>
    </ul>

    <h5>Chanmap</h5>
    <p>
      These controls run the KAPPA application CHANMAP to create a 
      <tt>channel map</tt> image. A channel map image consists of image tiles,
      each tile being the result of collapsing a range of planes in a cube.
      These ranges are chosen to create a given number of tiles between two
      limits (which can be the whole cube).
    </p>
    <p>
      The full range for collapsing is controlled as in the Animation tab and
      same combination methods are used as in the Collapse tab (see above).
    </p>
    <p>
      Once a channel-map is displayed it can have a grid overlaid, and you can
      inspect the coordinates of each tile. The average value of the collapsed
      axis can be seen in the 
      <tt>Image-Analysis->Change coordinates->Show all coordinates...</tt>
      toolbox, just track the mouse over the tile you want to investigate.

    <h5>Baseline</h5>
    <p>
      These controls run the KAPPA application MFITTREND to fit and subtract
      baselines from each spectrum in the cube. The baseline is estimated as a
      polynomial fit, of the selected order. Each spectrum is fitted
      independently and the data selected for each fit can include up to four
      ranges along the spectral axis. To define a range you must
      <tt>Enable</tt> it and then chose the lower and upper indices. These can
      be visualised in the spectral plot by selecting <tt>Show limits on
      plot:</tt> (in fact you can drag and resize these on the plot). Once ran
      the new cube replaces the old one and you can inspect it for success. If
      you want to keep the new cube then inspect the current directory for the
      latest file called <tt>GaiaTempCube[n].sdf</tt> (where <tt>[n]</tt> is
      some integer that increments for each new cube). This will not be
      deleted when GAIA exits (so you must do this yourself from
      time-to-time).
    </p>
    <p>

    <h3>Coordinates</h3>
    <p>
      The indices used to select an image plane are what are normally known as
      NDF pixel indices. For FITS cubes this will be just the grid indices
      (starting from 1 to the length of the chosen axis), for NDFs this will
      include the origin (this will also be true of FITS files converted from
      NDFs).
    </p>
    <p>
      When your cube has a world coordinate system defined (either as an NDF
      WCS component, or as FITS headers) you will also see the coordinate of
      the current slice displayed, together with a description of its
      meaning and units.
    </p>
    <p>
      For coordinate systems that define a spectral axis, you can also choose
      to transform into other supported coordinate systems. These are listed
      in the <tt>Coords</tt> menu (currently: angstroms, nm, mm, micrometres,
      GHz, MHz, THz, KHz, J, ergs, eV, keV and 1/m, plus m/s and km/s (radio),
      and redshift if a rest frequency is defined). Just choose one and the
      slice coordinates and the spectral plot (if active) will be redisplayed
      to show your new coordinates. This menu is replicated in the spectral
      plot for convenience. To return to the initial system just choose the
      <tt>Default</tt> item.
    </p>

    <h3>Data formats and efficiency</h3>
    <p>
      The toolbox should handle both NDF and FITS data cubes with more-or-less
      equal efficiency (NDFs may be slightly more efficient for some
      integer data types). Other formats will be converted into NDFs on the
      fly. For large datasets that isn't optimal, so you should convert the
      data yourself to NDF first. The CONVERT package has many applications for
      performing these conversions. If you want to use any tools that operate
      on the full cube data, rather than a plane (so that's any operations ran
      from this window, rather than any of the usual image analysis
      toolboxes), then having your data in NDF format is definitely preferred,
      as that will also involve a conversion to NDF anyway.
    </p>
    <p>
      Normally the cube file is memory mapped to access the data. Usually this
      gives a good compromise between startup speed and access speed. However,
      for very large cubes (2Gb and up) the access speed can suffer as the
      data is only read incrementally on demand. This is particularly
      noticeable when plotting spectra (which are usually accessed sparsely in
      the third dimension), typically this manifests itself as a very slow
      response, which suddenly becomes much faster after clicking on the cube
      many times. To avoid this behaviour you can choose to read the cube into
      core memory (but make sure you have sufficient first), in one chunk. To
      do this select the <tt>Memory map cube data</tt> option in the
      <tt>Options</tt> menu (and wait a while).
    </p>
    <p>
      When using some image analysis tools the currently displayed plane will
      be replaced with an actual NDF (for speed the image plane is displayed
      using a skeletal NDF with dynamically updated data, so cannot be
      directly processed by any external processes). After analysis you are
      free to continue moving through slices. A side-effect of this quest for
      speed is that the data processed by the analysis tools will not be a
      full NDF, that is it currently does not contain any addition components,
      such as variance or quality. If this is important you will need to
      extract the plane from the cube using the KAPPA task NDFCOPY, with a
      suitable NDF section (this is shown as part of the slice name in the
      main window) and open that normally in GAIA.
    </p>

    <h3>Analysing spectra</h3>
    <p>
      The spectral display tool is just that and offers no analysis
      features. If you want to perform a measurement on a spectrum (or say
      compare it with one from the VO, or with many from the same cube) then
      you can either extract it (using some command-line tool like KAPPA
      NDFCOPY), or send it to the Starlink SPLAT-VO program (best to only do
      this when displaying NDFs). If you want to do this press the
      <tt>Send</tt> button. This will be greyed out if SPLAT-VO is not
      available on your system.
    </p>
  </body>
</html>
