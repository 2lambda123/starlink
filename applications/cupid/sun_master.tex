\documentclass[twoside,11pt]{article}

% ? Specify used packages
\usepackage{graphicx}        %  Use this one for final production.
\usepackage[english]{babel}
% \usepackage[draft]{graphicx} %  Use this one for drafting.
% ? End of specify used packages

\pagestyle{myheadings}

% -----------------------------------------------------------------------------
% ? Document identification
\newcommand{\stardoccategory}  {Starlink User Note}
\newcommand{\stardocinitials}  {SUN}
\newcommand{\stardocsource}    {sun\stardocnumber}
\newcommand{\stardocnumber}    {999.1}
\newcommand{\stardocauthors}   {D.S. Berry}
\newcommand{\stardocdate}      {6th February 2006}
\newcommand{\stardoctitle}     {CUPID}
\newcommand{\stardoconeline}   {A Clump Identification and Analysis Package}
\newcommand{\stardocversion}   {Version 0.0-1}
\newcommand{\stardocmanual}    {Users' Manual}
\newcommand{\stardocabstract}  {CUPID is a package of the identification
and analysis of clumps of emission within 2- and 3- dimensional 
data arrays.}

% ? End of document identification
% -----------------------------------------------------------------------------

% +
%  Name:
%     sun.tex
%
%  Purpose:
%     Template for Starlink User Note (SUN) documents.
%     Refer to SUN/199
%
%  Authors:
%     AJC: A.J.Chipperfield (Starlink, RAL)
%     BLY: M.J.Bly (Starlink, RAL)
%     PWD: Peter W. Draper (Starlink, Durham University)
%
%  History:
%     17-JAN-1996 (AJC):
%        Original with hypertext macros, based on MDL plain originals.
%     16-JUN-1997 (BLY):
%        Adapted for LaTeX2e.
%        Added picture commands.
%     13-AUG-1998 (PWD):
%        Converted for use with LaTeX2HTML version 98.2 and
%        Star2HTML version 1.3.
%     {Add further history here}
%
% -

\newcommand{\stardocname}{\stardocinitials /\stardocnumber}
\markboth{\stardocname}{\stardocname}
\setlength{\textwidth}{160mm}
\setlength{\textheight}{230mm}
\setlength{\topmargin}{-2mm}
\setlength{\oddsidemargin}{0mm}
\setlength{\evensidemargin}{0mm}
\setlength{\parindent}{0mm}
\setlength{\parskip}{\medskipamount}
\setlength{\unitlength}{1mm}

% -----------------------------------------------------------------------------
%  Hypertext definitions.
%  ======================
%  These are used by the LaTeX2HTML translator in conjunction with star2html.

%  Comment.sty: version 2.0, 19 June 1992
%  Selectively in/exclude pieces of text.
%
%  Author
%    Victor Eijkhout                                      <eijkhout@cs.utk.edu>
%    Department of Computer Science
%    University Tennessee at Knoxville
%    104 Ayres Hall
%    Knoxville, TN 37996
%    USA

%  Do not remove the %begin{latexonly} and %end{latexonly} lines (used by 
%  LaTeX2HTML to signify text it shouldn't process).
%begin{latexonly}
\makeatletter
\def\makeinnocent#1{\catcode`#1=12 }
\def\csarg#1#2{\expandafter#1\csname#2\endcsname}

\def\ThrowAwayComment#1{\begingroup
    \def\CurrentComment{#1}%
    \let\do\makeinnocent \dospecials
    \makeinnocent\^^L% and whatever other special cases
    \endlinechar`\^^M \catcode`\^^M=12 \xComment}
{\catcode`\^^M=12 \endlinechar=-1 %
 \gdef\xComment#1^^M{\def\test{#1}
      \csarg\ifx{PlainEnd\CurrentComment Test}\test
          \let\html@next\endgroup
      \else \csarg\ifx{LaLaEnd\CurrentComment Test}\test
            \edef\html@next{\endgroup\noexpand\end{\CurrentComment}}
      \else \let\html@next\xComment
      \fi \fi \html@next}
}
\makeatother

\def\includecomment
 #1{\expandafter\def\csname#1\endcsname{}%
    \expandafter\def\csname end#1\endcsname{}}
\def\excludecomment
 #1{\expandafter\def\csname#1\endcsname{\ThrowAwayComment{#1}}%
    {\escapechar=-1\relax
     \csarg\xdef{PlainEnd#1Test}{\string\\end#1}%
     \csarg\xdef{LaLaEnd#1Test}{\string\\end\string\{#1\string\}}%
    }}

%  Define environments that ignore their contents.
\excludecomment{comment}
\excludecomment{rawhtml}
\excludecomment{htmlonly}

%  Hypertext commands etc. This is a condensed version of the html.sty
%  file supplied with LaTeX2HTML by: Nikos Drakos <nikos@cbl.leeds.ac.uk> &
%  Jelle van Zeijl <jvzeijl@isou17.estec.esa.nl>. The LaTeX2HTML documentation
%  should be consulted about all commands (and the environments defined above)
%  except \xref and \xlabel which are Starlink specific.

\newcommand{\htmladdnormallinkfoot}[2]{#1\footnote{#2}}
\newcommand{\htmladdnormallink}[2]{#1}
\newcommand{\htmladdimg}[1]{}
\newcommand{\hyperref}[4]{#2\ref{#4}#3}
\newcommand{\htmlref}[2]{#1}
\newcommand{\htmlimage}[1]{}
\newcommand{\htmladdtonavigation}[1]{}

\newenvironment{latexonly}{}{}
\newcommand{\latex}[1]{#1}
\newcommand{\html}[1]{}
\newcommand{\latexhtml}[2]{#1}
\newcommand{\HTMLcode}[2][]{}

%  Starlink cross-references and labels.
\newcommand{\xref}[3]{#1}
\newcommand{\xlabel}[1]{}

%  LaTeX2HTML symbol.
\newcommand{\latextohtml}{\LaTeX2\texttt{HTML}}

%  Define command to re-centre underscore for Latex and leave as normal
%  for HTML (severe problems with \_ in tabbing environments and \_\_
%  generally otherwise).
\renewcommand{\_}{\texttt{\symbol{95}}}

% -----------------------------------------------------------------------------
%  Debugging.
%  =========
%  Remove % on the following to debug links in the HTML version using Latex.

% \newcommand{\hotlink}[2]{\fbox{\begin{tabular}[t]{@{}c@{}}#1\\\hline{\footnotesize #2}\end{tabular}}}
% \renewcommand{\htmladdnormallinkfoot}[2]{\hotlink{#1}{#2}}
% \renewcommand{\htmladdnormallink}[2]{\hotlink{#1}{#2}}
% \renewcommand{\hyperref}[4]{\hotlink{#1}{\S\ref{#4}}}
% \renewcommand{\htmlref}[2]{\hotlink{#1}{\S\ref{#2}}}
% \renewcommand{\xref}[3]{\hotlink{#1}{#2 -- #3}}
%end{latexonly}
% -----------------------------------------------------------------------------
% ? Document specific \newcommand or \newenvironment commands.


% Includes a gif version of a figure, centred within a table, with a caption.
\newcommand{\htmlfig}[3]{
   \label{#1}
   \begin{rawhtml} <CENTER><TABLE NOSAVE > \end{rawhtml}
   \begin{rawhtml} <TR ALIGN=CENTER VALIGN=CENTER NOSAVE> \end{rawhtml}
   \begin{rawhtml} <TD NOSAVE><DT><IMG SRC=" \end{rawhtml}
   #2
   \begin{rawhtml} " NOSAVE ></DT></TD></TR> \end{rawhtml}
   \begin{rawhtml} <CAPTION ALIGN=BOTTOM><FONT SIZE=+1><BR><BR><B> \end{rawhtml}
   #3 
   \begin{rawhtml} </B><BR><BR><BR><BR></FONT></CAPTION></TABLE></CENTER> \end{rawhtml}
}

% centre an asterisk
\newcommand{\lsk}{\raisebox{-0.4ex}{\rm *}}
\begin{htmlonly}
\renewcommand{\lsk}{*} 
\end{htmlonly}

% Environment for indenting and using a small font.
\newenvironment{myquote}{\begin{quote}\begin{small}}{\end{small}\end{quote}}

% In-line typed text, buttons and menu items.
\newcommand{\butt}[1]{{\small \bf \tt #1}}
\newcommand{\menu}[1]{{\small \bf \em #1}}
\newcommand{\wlab}[1]{{\small \bf #1}}
\newcommand{\text}[1]{{\small \tt #1}}

% Quick routine descriptions
\newcommand{\quickdes}[3]{
                         \parbox{1.1in}{\bf #1}
                         \parbox{4.4in}{\raggedright #2 \dotfill}
                         \parbox{0.6in}{\pageref{#3}}
                         \vspace*{0.2in}}

% Quotes for SST.
\newcommand{\qt}[1]{{\tt "}#1{\tt "}}
\newcommand{\qs}[1]{{\tt '}#1{\tt '}}
\begin{htmlonly}
   \renewcommand{\qt}[1]{ {\tt{"}}#1{\tt{"}} }
   \renewcommand{\qs}[1]{ {\tt{'}}#1{\tt{'}} }
\end{htmlonly}

% Routines with descriptions in the appendix.
\newcommand{\routine}[1]{{\sc #1}}
\newcommand{\xroutine}[1]{\htmlref{{\sc #1}}{#1}}

% Latex only sections, subsections etc. Surround these with a latexonly
% environment.
\newcommand{\latexonlysection}[1]{\section{#1}}
\newcommand{\latexonlysubsection}[1]{\subsection{#1}}
\newcommand{\latexonlysubsubsection}[1]{\subsubsection{#1}}
\begin{htmlonly}
   \newcommand{\latexonlysection}[1]{#1}
   \newcommand{\latexonlysubsection}[1]{#1}
   \newcommand{\latexonlysubsubsection}[1]{#1}
\end{htmlonly}

% degrees symbol
\newcommand{\dgs}{\hbox{$^\circ$}} 
\begin{htmlonly}
\renewcommand{\dgs}{ degrees} 
\end{htmlonly}

\newcommand{\dash}{--}
\begin{htmlonly}
\renewcommand{\dash}{-}
\end{htmlonly}
\newcommand{\STARURL}{http://www.starlink.rl.ac.uk}
\newcommand{\TCLURL}{http://www.scriptics.com/}
\newcommand{\IRAFURL}{http://www.starlink.rl.ac.uk/iraf/web/iraf-homepage.html}
\newcommand{\STORE}{http://www.starlink.rl.ac.uk/cgi-bin/storetop}

%+
%  Name:
%     SST.TEX

%  Purpose:
%     Define LaTeX commands for laying out Starlink routine descriptions.

%  Language:
%     LaTeX

%  Type of Module:
%     LaTeX data file.

%  Description:
%     This file defines LaTeX commands which allow routine documentation
%     produced by the SST application PROLAT to be processed by LaTeX and
%     by LaTeX2html. The contents of this file should be included in the
%     source prior to any statements that make of the sst commnds.

%  Notes:
%     The style file html.sty provided with LaTeX2html needs to be used.
%     This must be before this file.

%  Authors:
%     RFWS: R.F. Warren-Smith (STARLINK)
%     PDRAPER: P.W. Draper (Starlink - Durham University)

%  History:
%     10-SEP-1990 (RFWS):
%        Original version.
%     10-SEP-1990 (RFWS):
%        Added the implementation status section.
%     12-SEP-1990 (RFWS):
%        Added support for the usage section and adjusted various spacings.
%     8-DEC-1994 (PDRAPER):
%        Added support for simplified formatting using LaTeX2html.
%     {enter_further_changes_here}

%  Bugs:
%     {note_any_bugs_here}

%-

%  Define length variables.
\newlength{\sstbannerlength}
\newlength{\sstcaptionlength}
\newlength{\sstexampleslength}
\newlength{\sstexampleswidth}

%  Define a \tt font of the required size.
\latex{\newfont{\ssttt}{cmtt10 scaled 1095}}
\html{\newcommand{\ssttt}{\tt}}

%  Define a command to produce a routine header, including its name,
%  a purpose description and the rest of the routine's documentation.
\newcommand{\sstroutine}[3]{
   \newpage
   \goodbreak
   \label{#1}
   \markboth{{\stardocname}~ --- #1}{{\stardocname}~ --- #1}
   \rule{\textwidth}{0.5mm}
   \vspace{-7ex}
   \newline
   \settowidth{\sstbannerlength}{{\Large {\bf #1}}}
   \setlength{\sstcaptionlength}{\textwidth}
   \setlength{\sstexampleslength}{\textwidth}
   \addtolength{\sstbannerlength}{0.5em}
   \addtolength{\sstcaptionlength}{-2.0\sstbannerlength}
   \addtolength{\sstcaptionlength}{-5.0pt}
   \settowidth{\sstexampleswidth}{{\bf Examples:}}
   \addtolength{\sstexampleslength}{-\sstexampleswidth}
   \parbox[t]{\sstbannerlength}{\flushleft{\Large {\bf #1}}}
   \parbox[t]{\sstcaptionlength}{\center{\Large #2}}
   \parbox[t]{\sstbannerlength}{\flushright{\Large {\bf #1}}}
   \begin{description}
      #3
   \end{description}
}

%  Format the description section.
\newcommand{\sstdescription}[1]{\item[Description:] #1}

%  Format the usage section.
\newcommand{\sstusage}[1]{\item[Usage:] \mbox{}
\\[1.3ex]{\raggedright \ssttt #1}}

%  Format the invocation section.
\newcommand{\sstinvocation}[1]{\item[Invocation:]\hspace{0.4em}{\tt #1}}

%  Format the arguments section.
\newcommand{\sstarguments}[1]{
   \item[Arguments:] \mbox{} \\
   \vspace{-3.5ex}
   \begin{description}
      #1
   \end{description}
}

%  Format the returned value section (for a function).
\newcommand{\sstreturnedvalue}[1]{
   \item[Returned Value:] \mbox{} \\
   \vspace{-3.5ex}
   \begin{description}
      #1
   \end{description}
}

%  Format the parameters section (for an application).
\newcommand{\sstparameters}[1]{
   \item[Parameters:] \mbox{} \\
   \vspace{-3.5ex}
   \begin{description}
      #1
   \end{description}
}

%  Format the examples section.
\newcommand{\sstexamples}[1]{
   \item[Examples:] \mbox{} \\
   \vspace{-3.5ex}
   \begin{description}
      #1
   \end{description}
}

%  Define the format of a subsection in a normal section.
\newcommand{\sstsubsection}[1]{ \item[{#1}] \mbox{} \\}

%  Define the format of a subsection in the examples section.
\newcommand{\sstexamplesubsection}[2]{\sloppy
\item[\parbox{\sstexampleslength}{\ssttt #1}] \mbox{} \vspace{1.0ex}
\\ #2 }

%  Format the notes section.
\newcommand{\sstnotes}[1]{\item[Notes:] \mbox{} \\[1.3ex] #1}

%  Provide a general-purpose format for additional (DIY) sections.
\newcommand{\sstdiytopic}[2]{\item[{\hspace{-0.35em}#1\hspace{-0.35em}:}]
\mbox{} \\[1.3ex] #2}

%  Format the implementation status section.
\newcommand{\sstimplementationstatus}[1]{
   \item[{Implementation Status:}] \mbox{} \\[1.3ex] #1}

%  Format the bugs section.
\newcommand{\sstbugs}[1]{\item[Bugs:] #1}

%  Format a list of items while in paragraph mode.
\newcommand{\sstitemlist}[1]{
  \mbox{} \\
  \vspace{-3.5ex}
  \begin{itemize}
     #1
  \end{itemize}
}

%  Define the format of an item.
\newcommand{\sstitem}{\item}

%% Now define html equivalents of those already set. These are used by
%  latex2html and are defined in the html.sty files.
\begin{htmlonly}

%  sstroutine.
   \newcommand{\sstroutine}[3]{
      \subsection{#1\xlabel{#1}-\label{#1}#2}
      \begin{description}
         #3
      \end{description}
   }

%  sstdescription
   \newcommand{\sstdescription}[1]{\item[Description:]
      \begin{description}
         #1
      \end{description}
      \\
   }

%  sstusage
   \newcommand{\sstusage}[1]{\item[Usage:]
      \begin{description}
         {\ssttt #1}
      \end{description}
      \\
   }

%  sstinvocation
   \newcommand{\sstinvocation}[1]{\item[Invocation:]
      \begin{description}
         {\ssttt #1}
      \end{description}
      \\
   }

%  sstarguments
   \newcommand{\sstarguments}[1]{
      \item[Arguments:] \\
      \begin{description}
         #1
      \end{description}
      \\
   }

%  sstreturnedvalue
   \newcommand{\sstreturnedvalue}[1]{
      \item[Returned Value:] \\
      \begin{description}
         #1
      \end{description}
      \\
   }

%  sstparameters
   \newcommand{\sstparameters}[1]{
      \item[Parameters:] \\
      \begin{description}
         #1
      \end{description}
      \\
   }

%  sstexamples
   \newcommand{\sstexamples}[1]{
      \item[Examples:] \\
      \begin{description}
         #1
      \end{description}
      \\
   }

%  sstsubsection
   \newcommand{\sstsubsection}[1]{\item[{#1}]}

%  sstexamplesubsection
   \newcommand{\sstexamplesubsection}[2]{\item[{\ssttt #1}] #2}

%  sstnotes
   \newcommand{\sstnotes}[1]{\item[Notes:] #1 }

%  sstdiytopic
   \newcommand{\sstdiytopic}[2]{\item[{#1}] #2 }

%  sstimplementationstatus
   \newcommand{\sstimplementationstatus}[1]{
      \item[Implementation Status:] #1
   }

%  sstitemlist
   \newcommand{\sstitemlist}[1]{
      \begin{itemize}
         #1
      \end{itemize}
      \\
   }
%  sstitem
   \newcommand{\sstitem}{\item}

\end{htmlonly}

%  End of "sst.tex" layout definitions.
%.



% ? End of document specific commands
% -----------------------------------------------------------------------------
%  Title Page.
%  ===========
\renewcommand{\thepage}{\roman{page}}
\begin{document}
\thispagestyle{empty}

%  Latex document header.
%  ======================
\begin{latexonly}
   CCLRC / \textsc{Rutherford Appleton Laboratory} \hfill \textbf{\stardocname}\\
   {\large Particle Physics \& Astronomy Research Council}\\
   {\large Starlink Project\\}
   {\large \stardoccategory\ \stardocnumber}
   \begin{flushright}
   \stardocauthors\\
   \stardocdate
   \end{flushright}
   \vspace{-4mm}
   \rule{\textwidth}{0.5mm}
   \vspace{5mm}
   \begin{center}
   {\Huge\textbf{\stardoctitle \\ [2.5ex]}}
   {\LARGE\textbf{\stardocversion \\ [4ex]}}
   {\Huge\textbf{\stardocmanual}}
   \end{center}
   \vspace{5mm}

% ? Add picture here if required for the LaTeX version.
% ? End of picture

% ? Heading for abstract if used.
   \vspace{5mm}
   \begin{center}
      {\Large\textbf{Abstract}}
   \end{center}
% ? End of heading for abstract.
\end{latexonly}

%  HTML documentation header.
%  ==========================
\begin{htmlonly}
   \xlabel{}
   \begin{rawhtml} <H1 ALIGN=CENTER> \end{rawhtml}
      \stardoctitle\\
      \stardocversion\\
      \stardocmanual
   \begin{rawhtml} </H1> <HR> \end{rawhtml}

   \begin{rawhtml} <P> <I> \end{rawhtml}
   \stardoccategory\ \stardocnumber \\
   \stardocauthors \\
   \stardocdate
   \begin{rawhtml} </I> </P> <H3> \end{rawhtml}
      \htmladdnormallink{CCLRC}{http://www.cclrc.ac.uk} /
      \htmladdnormallink{Rutherford Appleton Laboratory}
                        {http://www.cclrc.ac.uk/ral} \\
      \htmladdnormallink{Particle Physics \& Astronomy Research Council}
                        {http://www.pparc.ac.uk} \\
   \begin{rawhtml} </H3> <H2> \end{rawhtml}
      \htmladdnormallink{Starlink Project}{http://www.starlink.rl.ac.uk/}
   \begin{rawhtml} </H2> \end{rawhtml}
   \htmladdnormallink{\htmladdimg{source.gif} Retrieve hardcopy}
      {http://www.starlink.rl.ac.uk/cgi-bin/hcserver?\stardocsource}\\

%  HTML document table of contents. 
%  ================================
%  Add table of contents header and a navigation button to return to this 
%  point in the document (this should always go before the abstract \section). 
  \label{stardoccontents}
  \begin{rawhtml} 
    <HR>
    <H2>Contents</H2>
  \end{rawhtml}
  \htmladdtonavigation{\htmlref{\htmladdimg{contents_motif.gif}}
        {stardoccontents}}

% ? New section for abstract if used.
  \section{\xlabel{abstract}Abstract}
% ? End of new section for abstract
\end{htmlonly}

% -----------------------------------------------------------------------------
% ? Document Abstract. (if used)
%  ==================
\stardocabstract

% ? End of document abstract
% -----------------------------------------------------------------------------
% ? Latex document Table of Contents (if used).
%  ===========================================
  \newpage
  \begin{latexonly}
    \setlength{\parskip}{0mm}
    \tableofcontents
    \setlength{\parskip}{\medskipamount}
    \markboth{\stardocname}{\stardocname}
  \end{latexonly}
% ? End of Latex document table of contents
% -----------------------------------------------------------------------------
\cleardoublepage
\renewcommand{\thepage}{\arabic{page}}
\setcounter{page}{1}

\section{\xlabel{introduction}Introduction}

The CUPID package provides a set of tools for identifying and analysing
clumps of emission within 1, 2 or 3D data arrays. Specifically, it currently
provides the following facilities:

\begin{itemize}
\item identification of clumps of emission using a variety of different
      algorithms (\emph{e.g.} GaussClumps, ClumpFind, \emph{etc}).
\item creation of catalogues of clump parameters
\item creation of cut-out images containing the emission from individual clumps.
\end{itemize}

CUPID processes data in \emph{NDF} format. This is the standard data
format used by most Starlink software, and is described fully in
\xref{SUN/33}{sun33}{}. However, other astronomical data formats may also
be processed using transparent on-the-fly data conversion facilities
provided by the NDF subroutine library, and the CONVERT package. The use of 
these facilities is described \hyperref{here}{in section }{}{SEC:CONVERT},
and more fully in \xref{SUN/55}{sun55}{}.

All CUPID applications use standard Starlink subroutine libraries for
accessing parameters, producing graphics, reporting errors, \emph{etc}. They
therefore look and feel very similar to applications in other Starlink
packages such as KAPPA and CCDPACK. The following sections in
\xref{SUN/95}{sun95}{} (the KAPPA manual) should therefore be consulted for 
general information about these issues:

\begin{itemize}
\item ``\xref{Parameters}{sun95}{se_param}''
\item ``\xref{Graphics Devices and Files}{sun95}{se_graphdev}''
\item ``\xref{Plotting Styles and Attributes}{sun95}{se_style}''
\item ``\xref{Data Structures}{sun95}{se_datastr}''
\item ``\xref{NDF Sections}{sun95}{se_ndfsect}''
\item ``\xref{NDF History}{sun95}{se_ndfhistory}''
\item ``\xref{The Graphics Database}{sun95}{se_agitate}''
\item ``\xref{Using World Co-ordinate Systems}{sun95}{se_wcsuse}''
\item ``\xref{Procedures}{sun95}{se_procedures}''
\end{itemize}


\section{Clump Identification Algorithms}
This section lists and describes the clump identification algorithms
which are implemented within CUPID.

\subsection{\xlabel{gaussclumps}GaussClumps}
To be written.

\subsection{\xlabel{clumpfind}ClumpFind}
To be written.

\subsection{\xlabel{reinhold}Reinhold}
This algorithm was developed by Kim Reinhold whilst working at the Joint
Astronomy Centre in Hilo, Hawaii. It's overall strategy is first to
identify pixels within the data array which mark the edges of clumps of
emission. This typically produces a set of rings (in 2D), or shells (in 3D),
outlining the clumps. However, these structure can be badly affected by
noise in the data and so need to be cleaned up. This is done using a
sequence of cellular automata which first dilate the rings or shells, and
the erodes them. After cleaning, all pixels within each ring or shell
are assumed to belong to a single clump.

\subsubsection{Identifying the Clump Edges}
The initial identification of the edges is done by considering a set of
1-dimensional profiles through the data array. Each such profile can be
represented by a plot of data value against distance (in pixels) along the 
profile. For each such profile, the algorithm proceeds as follows:

\begin{enumerate}

\item Find the highest remaining (\emph{i.e.} unused) data value in the profile.

\item If this value is less than a specified background level (given by
the configuration parameter {\tt Reinhold.Noise}), then there are no
remaining significant peaks in the profile so continue with the next
profile.

\item Work out away from the peak position along the profile in both directions
to find the edges of the peak. A peak ends when it either i) meets a
pixel which has already been included within another peak, or ii) two
adjacent pixels are both below the background level, or iii) the average
gradient of the profile over three adjacent pixel drops below a minimum
value specified by the configuration parameter {\tt Reinhold.FlatSlope},
or iv) the end of the profile is reached.

\item If the peak was not truncated by reaching either end of the profile, 
and if the peak spans sufficient pixels, the positions of the two edges of 
the peak are marked in a mask array which is the same shape and size as the 
2D or 3D data array. The minimum number of pixels spanned by a peak in
order for the peak to be usable is given by the configuration parameter 
{\tt Reinhold.MinPix}.

\item The position of the peak itself is also marked so long as its peak 
value is above a specified minimum value (given by configuration parameter 
{\tt Reinhold.Thresh}).

\item The pixels within the 1D profile which fall between the upper and
lower edges of the peak are marked as ``used'', and the algorithm loops
back to the start (\emph{i.e.} step 1 above).
\end{enumerate}

This algorithm is applied to each 1D profile in turn. These profiles
are divided into groups of parallel profiles; the first group contains
profiles which are parallel to the first pixel axis, the second group
contains profiles which are parallel to the second pixel axis, \emph{etc}.
There are also groups which contain parallel profiles which proceed diagonally
through the data array. Thus there is a group of parallel profiles for every 
pixel axis and for every possible diagonal direction. Within each group,
there are sufficient profiles to ensure that every element in the data
array is included in a profile within the group.

Once all profiles have been processed, a 2 or 3D array is available that
identifies both the edges of the peaks and also the peak positions
themselves. Pixels which are flagged as peaks are only retained if the
pixel was found to be a peak in every profile group. That is, pixels
which appear as a peak when profiled in one direction but not when
profiled in another are discarded.

\subsubsection{Cleaning the Clump Edges}
The initial identification of clumps edges results in a mask array in
which each data pixel is marked as either an edge pixel or a peak pixel
or neither. Usually, the edge pixels can be seen to follow the outline of
the visible clumps, but will often be badly affected by noise in the
data. For instance, there may be holes in the edges surrounding a peak,
or spurious pixels may be have been marked as edge pixels. Before
continuing, it is necessary to reduce the effect of this noise. This is
done in two steps:

\begin{enumerate}
\item The edge regions were ``dilated'' (\emph{i.e.} thickened) using a
cellular automata algorithm which proceeds as follows: if a pixel is
marked as an edge pixel, then all immediate neighbours of the pixel are
also marked as edge pixels. Each pixel is considered to be the central
pixel in a square of 3x3 neighbouring pixels for 2D data, or the central
pixel in a cube of 3x3x3 neighbouring pixels for 3D data.

\item The thickened edge regions were then ``eroded'' (\emph{i.e.} made
thinner) using another cellular automata algorithm which proceeds as follows: 
if the number of neighbouring edge pixels surrounding a central pixel was
greater than a specified threshold value (given by the configuration
parameter {\tt Reinhold.CAThresh}), the central pixel would be marked as
an edge pixel. If the number of neighbouring edge pixels was equal to or
below this threshold, the central pixel would not be marked as an edge pixel. 
This transformation can be applied repeatedly to increase the amount of
erosion by setting a value greater than one for the configuration parameter 
{\tt Reinhold.CAIterations}.

\end{enumerate}


\subsubsection{Filling the Clump Edges}
Once the edges have been cleaned up, the volume contained within the
edges can be filled with an integer which identifies the associated peak.
This algorithm proceeds as follows:

\begin{enumerate}

\item The mask array is scanned for pixels which are marked as peaks.
Recall that only those pixels which are seen to be peaks when profiled
in all directions have been retained. Each of these pixels thus represents
a local maximum in the data value, and has a significantly higher data
value than any of the surrounding pixels. Each such peak is given a
unique integer identifier. This identifier is used within the following 
steps to label all pixels in the clump of emission surrounding the peak.

\item A line of pixels parallel to the first pixel axis, and which passes
through the peak, is then considered. The line is followed away from the
peak, in both directions, until pixels are encountered which are flagged as 
edge pixels. All the pixels along this line between the two edge pixels
are assigned the clump identifier associated with the central peak. 

\item For each such pixel, another line of pixels parallel to the second
pixel axis and passing through the pixel is considered. The line is followed 
away from the pixel, in both directions, until edge pixels are encountered.
All the pixels along this line between the two edge pixels are also assigned 
the clump identifier associated with the central peak. 

\item For each such pixel, another line of pixels parallel to the third
pixel axis and passing through the pixel is considered. The line is followed 
away from the pixel, in both directions, until edge pixels are encountered.
All the pixels along this line between the two edge pixels are also assigned 
the clump identifier associated with the central peak. 

\end{enumerate}

The above process will fill the volume between the edges, but may miss
some pixels (\emph{e.g.} if the initial line parallel to the first pixel
axis spans the clump at an unusually narrow point). In order to alleviate
this effect, the above process is repeated, but scanning the pixels axes
in a different order (2,3,1 instead of 1,2,3). For 3D data, it is repeated 
a third time using the axis order (3,1,2). 

Even so, it should be recognised that this filling algorithm will fail to
fill certain shapes entirely. For instance, ``S''-shaped clumps could not
be filled completely using this algorithm.

\subsubsection{Cleaning up the Filled Clumps}
The use of cellular automata to clean up the edges reduces the likelihood
of ``holes'' within the clump edges, but does not eliminate this risk
entirely. When the clump-filling algorithm described above encounters a
hole in the edges surrounding a peak, the clump identifier value will 
``leak out'' through the hole into the surrounding areas. This is where the
limitations of the filling algorithm have a positive benefit, in that they
prevent the leak from spreading round corners without limit. Instead, such 
leaks will tend to be produce straight features radiating out from a clump
parallel to a pixel axis, which will terminate as soon as they meet another 
edge.

It is thus possible for the two or more clumps to ``claim'' a given
pixel. This will happen if there are holes in the edges surrounding the 
peaks which allow the filling process to leak out. In this case, each
pixel is assigned to the clump associated with the nearest peak.

Another cellular automata is used once the filling process has been
completed to reduce the artifacts created by these leaks. This cellular
automata replaces each clump identifier by the most commonly occurring
clump identifier within a 3x3x3 cube (or 3x3 square for 2D data) of
neighbours. This process can be repeated to increase the degree of
cleaning, by assigning a value greater than one to the configuration
parameter Reinhold.FixClumpsIterations.

The results of this cleaning process are the final clump allocations for
every data pixel, from which the catalogue of clump parameters is produced.

\subsection{\xlabel{fellwalker}FellWalker}
This algorithm is most simply described assuming the data array is
2-dimensional, although it applies in a similar manner to 3-dimensional
data. It's name was chosen to suggest a parallel between a contour map of
a 2D astronomical data array, and the height contours seen in a geographical
map of a hilly area, such as used by most fell-walkers. The algorithm
used to assign a data pixel to a clump of emission can be compared to
that of a fell-walker ascending a hill by following the line of steepest
ascent (not perhaps the most sensible way to ascend a hill in practise
but one which lends some verisimilitude to the present algorithm!).

The algorithm considers every data pixel in the supplied array in turn as
a potential start for a ``walk'' to a neighbouring peak. Pixels which are
below a nominated background level (specified by configuration parameter
FellWalker.Noise) are ignored and are flagged as not belonging to any
emission clump. These are skipped over, as are pixels which have already
been assigned to a clump. Once a pixel is found that has not yet been
assigned to a clump and is above the background level, the algorithm
proceeds to trace out a route from this pixel to a neighbouring peak. It
does this in a series of steps (comparable to the steps of a
fell-walker). At each step the algorithm looks at the 3x3 square of
neighbouring pixels (a 3x3x3 cube for 3D data ), and selects the
neighbour which would produce the highest gradient for the next step. The
algorithm then moves to that pixel and proceeds with the next step.

Eventually, this algorithm will reach a local maximum; a point from which
all routes go down-hill. But this may be merely a noise spike, rather
than a significant peak, and so a check is made over a more extended
neighbourhood to see if a pixel with a higher data value than the current
pixel can be found (the extent of this extended neighbourhood is
specified by the configuration parameter FellWalker.MaxJump). If so, the
algorithm ``jumps'' to the pixel with the highest value in the extended
neighbourhood, and then proceeds as before to walk up-hill. If no pixel
with a higher value is found within the extended neighbourhood, the pixel
is designated as a significant peak, and is assigned a unique integer
identifier. This integer is used to identify all pixels which are within
the clump of emission containing the peak, and all pixels which were
visited along the walk are assigned this identifier.

If, in the process of walking up-hill, a pixel is visited which has
already been assigned to a clump, then the walk is terminated at that
point and all the pixels so far visited are assigned to the same clump.

In some cases, the initial part of a walk may be over very flat
``terrain''. The significant part of a walk is considered to start when
the average gradient (taken over a 4 step length) first reaches the value
of configuration parameter FlatSlope. Any pixels visited prior to this point
are deemed not to be in any clump. However, this only applies if the
walk starts at or close to ``sea level''. For walks which start from a 
higher level (\emph{i.e.} from a pixel which has a data value greater than 
the selected background level plus twice the RMS noise level), the entire
length of the walk is used, including any initial flat section.

Once all pixels in the data array have been considered as potential
starts for such a walk, an array will have been created which holds an
integer clump identifier for every data pixel. To reduce the effect of
noise on the boundaries between clumps, a cellular automata can be used
to smooth the boundaries. This replaces each clump identifier by the most
commonly occurring value within a 3x3 square (or 3x3x3 cube for 3D data)
of neighbours. The number of times which this cleaning process should be
applied is specified by configuration parameter CleanIter. 

If the high data values in a clump form a plateau with slight
undulations, then the above algorithm may create a separate clump for
each undulation. This is probably inappropriate, especially if the dips
between the undulations are less than or are comparable to the noise
level in the data. This situation can arise for instance if the
pixel-to-pixel noise is correlated on a scale equal to or larger than the
value of the MaxJump configuration parameter. To avoid this, adjoining
clumps are merged together if the dip between them is less than a
specified value. Specifically, if two clumps with peak values PEAK1 and
PEAK2, where PEAK1 is less than PEAK2, are adjacent to each other, and if
the pixels along the interface between the two clumps all have data
values which are larger than ``PEAK1 - MinDip'' (where MinDip is the
value of the MinDip configuration parameter), then the two clumps are
merged together.

The results of this merging process are the final clump allocations for
every data pixel, from which the catalogue of clump parameters is
produced.

\newpage
\appendix
\section{ \label{APP:DESCRIPTION}Description of the CUPID applications}
\begin{latexonly}
\latexonlysubsection{Alphabetic list of CUPID routines.}
%
% set up a mini table of contents for this section pointing into next section.
%
\include{list.tex}

\end{latexonly}

\subsection{Complete routine descriptions \label{descriptions}}

The CUPID routine descriptions are contained in the following pages.
These descriptions follow the style used in \xref{SUN/95}{sun95}{ap_full}
for NDF applications.

\newpage
\include{tasks.tex}

\newpage
\markboth{\stardocname}{\stardocname}

\section{\label{APP:HISTORY}History}
This section describes the major changes introduced at each release of
CUPID.


\newpage

\end{document}
