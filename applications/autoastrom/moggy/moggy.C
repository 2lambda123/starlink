// Part of moggy
// Copyright 2001 Council for the Central Laboratory of the Research Councils.
// See file LICENCE for conditions.

static const char RCSID[] =
        "$Id$";


#ifdef HAVE_CONFIG_H
#include "config.h"
#endif


#if HAVE_CSTD_INCLUDE
#include <cstdio>
//#include <cstdlib>
#include <ctime>
//using std::exit;
#else
#include <stdio.h>              // for vsprintf
//#include <stdlib.h>
#include <time.h>
#endif

#include <string>

#include <cat/CatalogInfo.h>

#include "moggy.h"
#include "CommandParse.h"

const char *progname;

void dumpCatalogue (ostream& o);

int main (int argc, char **argv)
{
    string commandline;
    string crlf = "\r\n";
    bool keepGoing = true;

    progname = argv[0];

    try
    {

	while (keepGoing && getline (cin, commandline))
	{
	    CommandParse* cmd = new CommandParse (commandline);

	    switch (cmd->type())
	    {
	      case CommandParse::INVALID:
		cout << "500 Unknown command" << crlf;
		break;

	      case CommandParse::CONF:
		cout << "210 Configuration file follows, terminated by <CRLF>.<CRLF>" << crlf;
		dumpCatalogue (cout);
		cout << "." << crlf;
		break;

	      case CommandParse::QUIT:
		cout << "220 Goodbye" << crlf;
		keepGoing = false;
		break;

	      default:
		cout << "502 Command not implemented" << crlf;
		break;
	    }
	}

    }
    catch (CommandParse::BadCommandParse& e)
    {
	cout << "501 Completely unparseable command (" << e.msg << "). Exiting"
	     << crlf;
    }
    catch (MoggyException& e)
    {
	cerr << "Error: " << e.msg << endl;
    }

    exit (0);
}


void dumpCatalogue (ostream& o)
{
    const time_t nowsecs = time(NULL);
    struct tm *now = gmtime (&nowsecs);
    char timebuf[17];

    o << "# Skycat catalogue configuration file" << endl;

    // Add an ISO 8601 date/time string
    strftime (timebuf, sizeof(timebuf), "%Y-%m-%dT%H:%MZ", now);
    o << "# Generated by " << progname << ", " << timebuf << endl;

    const char *catname = getenv ("CATLIB_CONFIG");
    if (catname == NULL)
	o << "# Default configuration" << endl;
    else
	o << "# from CATLIB_CONFIG=" << catname << endl;

    o << endl;

    for (const CatalogInfoEntry *e = CatalogInfo::first();
	 e != NULL;
	 e = e->next())
    {
	o << *e << endl;
    }

    return;
}
