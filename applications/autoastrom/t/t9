#! /bin/sh -

##testing autoastrom

if test -z "$AUTOASTROM_DIR"; then
    echo "No AUTOASTROM_DIR -- autoastrom must be test-installed"
    exit 1
fi
if test ! -d $AUTOASTROM_DIR; then
    echo "Can't find autoastrom directory $AUTOASTROM_DIR"
    exit 1
fi
if test ! -x $AUTOASTROM_DIR/autoastrom; then
    echo "Can't find autoastrom script in directory $AUTOASTROM_DIR"
    exit 1
fi
if test ! -x $AUTOASTROM_DIR/match; then
    echo "Match program isn't installed -- ignore this test"
    exit 2
fi

test -n "$KAPPA_DIR"		|| KAPPA_DIR=/star/bin/kappa
# Need CCDPACK 4.0-1 and ATOOLS 1.3, so the following might need predefining
test -n "$CCDPACK_DIR"		|| CCDPACK_DIR=/star/bin/ccdpack
test -n "$ATOOLS_DIR"		|| ATOOLS_DIR=/star/bin/atools

export AUTOASTROM_DIR KAPPA_DIR CCDPACK_DIR ATOOLS_DIR

PREFIX=t9-temp-

# The --defects options in the command lines below are actually
# redundant, since we're getting the CCD catalogue information from
# --xxxccdcat, but I keep them in to remind me they have to be there
# when/if I regenerate the xxxccdcat (the same command, but with the
# xxxccdcat file not existing, and without the xxxndfinfo option, and
# with the real r106282xx.sdf file as argument).

#keeptemps=--keeptemps
keeptemps=--nokeeptemps

$AUTOASTROM_DIR/autoastrom \
    --verbose \
    --xxxccdcat=testndf1.ccdcat.munged \
    --xxxndfinfo=dim1=2048,dim2=4097 \
    --defects \
    --noinsert \
    --keepfits=${PREFIX}testndf1.final-fits.fits \
    $keeptemps \
    testndf1.sdf \
    >${PREFIX}testndf1.STDOUT \
    2>${PREFIX}testndf1.STDERR

$AUTOASTROM_DIR/autoastrom \
    --verbose \
    --xxxccdcat=testndf2.ccdcat.munged \
    --xxxndfinfo=dim1=353,dim2=353 \
    --obsdata=col=600 \
    --noinsert \
    --keepfits=${PREFIX}testndf2.final-fits.fits \
    $keeptemps \
    testndf2 \
    >${PREFIX}testndf2.STDOUT \
    2>${PREFIX}testndf2.STDERR

# Now the same two fits, but with --match=match

$AUTOASTROM_DIR/autoastrom \
    --verbose \
    --xxxccdcat=testndf1.ccdcat.munged \
    --xxxndfinfo=dim1=2048,dim2=4097 \
    --defects \
    --noinsert \
    --keepfits=${PREFIX}testndf3.final-fits.fits \
    --match=match \
    $keeptemps \
    testndf1.sdf \
    >${PREFIX}testndf3.STDOUT \
    2>${PREFIX}testndf3.STDERR

$AUTOASTROM_DIR/autoastrom \
    --verbose \
    --xxxccdcat=testndf2.ccdcat.munged \
    --xxxndfinfo=dim1=353,dim2=353 \
    --obsdata=col=600 \
    --noinsert \
    --keepfits=${PREFIX}testndf4.final-fits.fits \
    --match=match \
    $keeptemps \
    testndf2 \
    >${PREFIX}testndf4.STDOUT \
    2>${PREFIX}testndf4.STDERR

# testnodate.sdf is testndf1.sdf but with all date and time information removed
# from the FITS headers -- can we cope?

$AUTOASTROM_DIR/autoastrom \
    --verbose \
    --xxxccdcat=testndf1.ccdcat.munged \
    --xxxndfinfo=dim1=2048,dim2=4097 \
    --defects \
    --noinsert \
    --keepfits=${PREFIX}testndf5.final-fits.fits \
    $keeptemps \
    testnodate.sdf \
    >${PREFIX}testndf5.STDOUT \
    2>${PREFIX}testndf5.STDERR


# Dump results to stdout, removing version string
# Remove lines containing version-number, HTTP proxy, and plugin path
for n in 1 2 3 4 5
do
    echo "=== Test $n ==="
    egrep -v '(autoastrom, v|HTTP proxy|plugin-match-match)' ${PREFIX}testndf$n.STDOUT
    if test -f ${PREFIX}testndf$n.final-fits.fits; then
        ./fitsdump ${PREFIX}testndf$n.final-fits.fits
    else
        echo "Can't find file ${PREFIX}testndf$n.final-fits.fits"
    fi

    echo "=== Test $n ===" >&2
    cat ${PREFIX}testndf$n.STDERR >&2
done

rm -f ${PREFIX}*

exit 0;
