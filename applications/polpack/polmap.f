      SUBROUTINE POLMAP( STATUS )
*+
*  Name:
*     POLMAP

*  Purpose:
*     

*  Language:
*     Starlink Fortran 77

*  Type of Module:
*     ADAM A-task

*  Invocation:
*     CALL POLMAP( STATUS )

*  Arguments:
*     STATUS = INTEGER (Given and Returned)
*        The global status.

*  Description:
*     This routine 

*  Usage:
*     polmap in 

*  ADAM Parameters:
*     BADCOL = LITERAL (Update)
*        The colour with which to represent missing data. This should be
*        one of RED, BLUE, GREEN, CYAN, MAGENTA, YELLOW, BLACK. Any
*        unambiguous abbreviation can be supplied, and the value is
*        case-insensitive. [CYAN]
*     DPI = _INTEGER (Read)
*        The dots per inch on the display screen. Some X servers fail to 
*        supply the correct value, resulting in the GUI being unplesantly
*        small or large. For this reason, an explicit value may be supplied 
*        using this parameter. If a null (!) value is supplied, then the
*        DPI value returned by the X server is used. This parameter may
*        also be used to adjust the size of the GUI to the user's
*        preference, even if the DPI value returned by the X server is correct.
*        Note, this value cannot be set from the GUI's "Options" menu. [!]
*     HELPAREA = _LOGICAL (Update)
*        If a true value is supplied, then dynamic help information will be
*        displayed in a box at the bottom of the GUI. This information
*        describes the component of the GUI currently under the mouse 
*        pointer. [TRUE]
*     IN = NDF (Read)
*        The input image. Note, the input image cannot be specified within 
*        the GUI.
*     LOGFILE = LITERAL (Read)
*        The name of a log file to which will be written all the messages
*        generated by the applications activated by the GUI. If "stdout"
*        is supplied, then the messages will be directed to standard
*        output (usually the screen). If a null (!) value is supplied, then 
*        no log file will be created. Note, this parameter cannot be set 
*        from the GUI's "Options" menu. [!]
*     NEWCOLMAP = _LOGICAL (Read)
*        If a true value is supplied for NEWCOLMAP, then the GUI will use
*        its own private colour map. Otherwise it will share the standard 
*        colour map. Note, with a false value for NEWCOLMAP, there may 
*        be insufficient free colours in the standard colour map (i.e. if
*        other X applications are running). In this case POLMAP will report 
*        an error and abort. If this happens, try re-running with a true
*        value for NEWCOLMAP. [FALSE]
*     PERCENTILES( 2 ) = _REAL (Update)
*        The percentiles that define the scaling limits for the displayed
*        images. For example, [25,75] would scale between the quartile 
*        values. [5,95]
*        used as supplied. [3]
*     POLCOL = LITERAL (Update)
*        The colour with which to draw polygons. This should be one of RED, 
*        BLUE, GREEN, CYAN, MAGENTA, YELLOW, BLACK. Any unambiguous 
*        abbreviation can be supplied, and the value is case-insensitive.
*        [RED]
*     SELCOL = LITERAL (Update)
*        The colour with which to mark the selected area of the image (if any).
*        This should be one of RED, BLUE, GREEN, CYAN, MAGENTA, YELLOW, BLACK. 
*        Any unambiguous abbreviation can be supplied, and the value is 
*        case-insensitive. [RED]
*     STARTHELP = _LOGICAL (Read)
*        If a true value is supplied, then a hyper-text browser will be
*        created with the GUI, displaying the contents page of the PolReg
*        on-line help documentation. Otherwise, the browser is only created
*        if the user accesses the on-line help information explicitly
*        from within the GUI by using the "Help" menu or the F1 key on 
*        the keyboard. [TRUE]
*     STATUSAREA = _LOGICAL (Update)
*        If a true value is supplied, then information describing the
*        currently displayed image, current options values, etc, will be 
*        displayed in a box underneath the displayed image. The contents
*        of this box can be selected using the "Options" menu in the GUI.
*        [TRUE]
*     XHAIR = _LOGICAL (Update)
*        If a true value is supplied, then a cross hair will be used
*        instead of a pointer while the mouse is over the image display
*        area. [TRUE]
*     XHAIRCOL = LITERAL (Update)
*        The colour with which to draw the cross-hair (if required). This 
*        should be one of RED, BLUE, GREEN, CYAN, MAGENTA, YELLOW, BLACK. Any
*        unambiguous abbreviation can be supplied, and the value is
*        case-insensitive. [YELLOW]

*  Examples:

*  Notes:

*  Authors:
*     DSB: David Berry (STARLINK)
*     {enter_new_authors_here}

*  History:
*     27-AUG-1997 (DSB):
*        Original version.
*     {enter_changes_here}

*  Bugs:
*     {note_any_bugs_here}


      
*  Type Definitions:
      IMPLICIT NONE              ! No implicit typing

*  Global Constants:
      INCLUDE 'SAE_PAR'          ! Standard SAE constants
      INCLUDE 'PAR_ERR'          ! PAR_ error constants

*  Status:
      INTEGER STATUS             ! Global status

*  External References:
      INTEGER CHR_LEN

*  Local Constants:
      CHARACTER COLS*40
      PARAMETER ( COLS = 'RED,BLUE,GREEN,CYAN,MAGENTA,YELLOW,BLACK' )

*  Local Variables:
      CHARACTER
     :        BADCOL*7,          ! Colour for missing pixels
     :        IMAGE*255,         ! Buffer for input image name
     :        LOGFIL*80,         ! Name of required log file
     :        POLCOL*7,          ! Colour for polygons
     :        SELCOL*7,          ! Colour for the selected area box
     :        SI*80,             ! String describing required status items
     :        XHRCOL*7           ! Colour for the cross-hair
      INTEGER
     :        DPI,               ! Dots per inch to use
     :        IMLEN,             ! Used length of input image buffer
     :        INDF               ! NDF identifier for input image
      LOGICAL 
     :        HAREA,             ! Is the help area to be displayed?
     :        NEWCM,             ! Use a new colour map?
     :        SAREA,             ! Is the status area to be displayed?
     :        STHLP,             ! Display a WWW browser at start-up?
     :        XHAIR              ! Is a cross-hair required?
      REAL
     :        PERCNT(2),         ! Display percentiles
     :        PERDEF(2)          ! Default display percentiles

*.

*  Check inherited global status.
      IF ( STATUS .NE. SAI__OK ) RETURN

*  Get an NDF identifier for the input image, store its name in a local 
*  variable, and annull the identifier.
      CALL NDF_ASSOC( 'IN', 'READ', INDF, STATUS )
      CALL NDF_MSG( 'NDF', INDF )
      CALL MSG_LOAD( ' ', '^NDF', IMAGE, IMLEN, STATUS )
      CALL NDF_ANNUL( INDF, STATUS )

*  See if a new colour map should be used.
      CALL PAR_GET0L( 'NEWCOLMAP', NEWCM, STATUS )

*  See if a cross hair should be used over the image display area.
      CALL PAR_GET0L( 'XHAIR', XHAIR, STATUS )

*  See if the help area is to be displayed.
      CALL PAR_GET0L( 'HELPAREA', HAREA, STATUS )

*  See if the status area is to be displayed.
      CALL PAR_GET0L( 'STATUSAREA', SAREA, STATUS )

*  See if a WWW browser displaying the PolReg manual contents page should
*  be created at start-up.
      CALL PAR_GET0L( 'STARTHELP', STHLP, STATUS )

*  Get the dots per inch to assume for the screen. A null valu means
*  use the normal TK value. Annull the error if it occurs.
      IF ( STATUS .EQ. SAI__OK ) THEN
         CALL PAR_GET0I( 'DPI', DPI, STATUS )
         IF ( STATUS .EQ. PAR__NULL ) THEN
            CALL ERR_ANNUL( STATUS )
            DPI = -1
         END IF
      END IF

*  Get an encoded string describing which status items are to be included 
*  in the status area, and in what order. 
      CALL PAR_GET0C( 'ITEMS', SI, STATUS )

*  Get the name of a logfile.
      IF ( STATUS .EQ. SAI__OK ) THEN
         CALL PAR_GET0C( 'LOGFILE', LOGFIL, STATUS )
         IF( STATUS .EQ. PAR__NULL ) THEN
            LOGFIL = ' '
            CALL ERR_ANNUL( STATUS )
         ELSE
            CALL CHR_RMBLK( LOGFIL )
         END IF
      END IF

*  Get the colours to use for various parts of the display.
      CALL PAR_CHOIC( 'BADCOL', 'CYAN', COLS, .FALSE., BADCOL, STATUS )
      CALL CHR_LCASE( BADCOL )

      CALL PAR_CHOIC( 'POLCOL', 'RED', COLS, .FALSE., POLCOL, STATUS )
      CALL CHR_LCASE( POLCOL )

      CALL PAR_CHOIC( 'SELCOL', 'RED', COLS, .FALSE., SELCOL, STATUS )
      CALL CHR_LCASE( SELCOL )

      CALL PAR_CHOIC( 'XHAIRCOL', 'RED', COLS, .FALSE., XHRCOL, STATUS )
      CALL CHR_LCASE( XHRCOL )

* Find the display percentiles required. 
      PERDEF( 1 ) = -1.0
      PERDEF( 2 ) = -1.0
      CALL PAR_GDR1R( 'PERCENTILES', 2, PERDEF, 0.0, 100.0,
     :                .FALSE., PERCNT, STATUS )

*  Execute the TCL script.
      CALL DOPLMP( IMAGE( : CHR_LEN( IMAGE ) ), DPI, HAREA, SAREA, SI, 
     :             LOGFIL( : CHR_LEN( LOGFIL ) ), BADCOL, POLCOL, 
     :             SELCOL, PERCNT(1), PERCNT(2), NEWCM, XHAIR, 
     :             XHRCOL, STHLP, STATUS )

*  The various options values may have been altered by the use of the 
*  "Options" menu in the GUI. Write them back to the parameter file in case.
      CALL PAR_PUT0L( 'XHAIR', XHAIR, STATUS )
      CALL PAR_PUT0L( 'HELPAREA', HAREA, STATUS )
      CALL PAR_PUT0L( 'STATUSAREA', SAREA, STATUS )
      CALL PAR_PUT0C( 'ITEMS', SI( : CHR_LEN( SI ) ), STATUS )
      CALL CHR_UCASE( BADCOL )
      CALL PAR_PUT0C( 'BADCOL', BADCOL, STATUS )
      CALL CHR_UCASE( POLCOL )
      CALL PAR_PUT0C( 'POLCOL', POLCOL, STATUS )
      CALL CHR_UCASE( SELCOL )
      CALL PAR_PUT0C( 'SELCOL', SELCOL, STATUS )
      CALL CHR_UCASE( XHRCOL )
      CALL PAR_PUT0C( 'XHAIRCOL', XHRCOL, STATUS )
      CALL PAR_PUT1R( 'PERCENTILES', 2, PERCNT, STATUS )

*  If an error occurred, then report a contextual message.
      IF ( STATUS .NE. SAI__OK ) THEN

*  If a null parameter was given or a parameter abort was requested, 
*  annul the error.
         IF( STATUS .EQ. PAR__NULL .OR. STATUS .EQ. PAR__ABORT ) THEN
            CALL ERR_ANNUL( STATUS )

*  If any other error occurred, then report a contextual message.
         ELSE
            CALL ERR_REP( 'POLMAP_ERR', 'POLMAP: Unable to display a '//
     :                    'polarisation map.', STATUS )
         END IF

      END IF

      END
