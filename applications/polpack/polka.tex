\documentclass[11pt,nolof]{starlink}
% -----------------------------------------------------------------------------
%Document identification
\stardoccategory    {}
\stardocinitials    {}
\stardocsource      {}
\stardocnumber      {\ }
\stardocauthors     {D.S. Berry}
\stardocdate        {19th April 1999}
\stardoctitle     {POLKA \linebreak
                                A Tool for Image Registration, Sky Subtraction,
                                and Calculation of Stokes Parameters}
\stardocversion     {Version 1.1}
\stardocmanual      {Hypertext Help}
\stardocname  {POLKA Hypertext Help}
\stardocabstract{POLKA is a tool for aligning images and subtracting sky backgrounds. If
the images hold polarimetry data, then POLKA may also be used to
calculate Stokes parameters from the aligned, sky-subtracted images.
POLKA forms part of the POLPACK package documented in SUN/223.}

% -----------------------------------------------------------------------------

\providecommand{\mylabel}[1] {\xlabel{#1}\label{#1}}
% -----------------------------------------------------------------------------
\begin{document}
\scfrontmatter

\section {\mylabel{POLKA_OVERVIEW}Introduction}
POLKA forms part of the \xref{POLPACK}{sun223}{} package, which contains
applications for the reduction of imaging polarimeter data. POLKA itself
is an interactive tool primarily intended to process a set of input
intensity images (corrected for any detector effects such as
flat-fielding, de-biassing, etc), producing a corresponding set of
aligned, sky-subtracted images. A 3-D cube holding the corresponding
Stokes vectors may also be produced. The mains steps involved are:

\begin{itemize}
\item Extraction of the required sub-regions from each input image.
\item Independent sky subtraction within each aligned sub-region.
\item Alignment of all extracted sub-regions using stars within the field.
\item Calculation of a Stokes vector for each pixel.
\end{itemize}

However, the final stage (producing the Stokes vectors) is optional,
allowing POLKA to be used as a general purpose image alignment tool for
non-polarimetric data.

POLKA can function in two basic modes; single-beam and dual-beam. In
single-beam mode each input frame contains only one image (the $O$ ray
image), and the GUI controls related to the $E$ ray image are
disabled. In dual-beam mode each input frame contains two images (the $O$
and the $E$ ray images), either side-by-side or interlaced. If you are
aligning non-polarimetric data, use single beam mode.

In either mode, use of POLKA is divided into two stages. In the first
stage, the user supplies all the information required to produce the
output data files. This includes identifying stars, masks and sky regions
on each of the supplied input images. Once this has been completed to the
satisfaction of the user, the second stage is entered in which the output
data files are created. Once initiated (using the \htmlref{
\emph{Save}}{POLKA_SAVE} item in the \htmlref{\emph{File}}{POLKA_FILE_MENU}
menu), no further interaction on the part of the user is required. This
stage involves the four steps listed below (an indication of the progress
is given as these operations proceeds):

\subsection{\mylabel{POLKA_EXTRACT}Image Extraction}
In dual-beam mode each input frame contains two images (the $O$ and $E$
ray images). Each of these images is contained within a ``mask''
consisting of one or more disconnected areas in the input frame. The user
identifies each of the two masks by drawing a polygon around the
disconnected areas forming the mask.

In single-beam mode, each input frame contains only one image (the $O$
ray image). A single mask can still be supplied, however, to specify the
usable area of the image. If not supplied, the mask area defaults to the
whole image.

It is usually only necessary to identify the masks explicitly on a single
input frame. Default masks for the other images are created automatically
on the assumption that they are identical for all input Frames (i.e. that
they do not move relative to the detector between frames). However, these
default masks can be edited if necessary by dragging, adding or deleting
vertices.

\subsection {\mylabel{POLKA_SKYSUB}Sky Subtraction}
By default, POLKA estimates and removes the sky background from each
output image. This may be suppressed using the
\xref{SKYOFF}{sun223}{POLKA} parameter when POLKA is run, or the
\htmlref{\emph{Remove Sky}}{POLKA_REMOVE_SKY} item in the \htmlref{
\emph{Options}}{POLKA_OPTIONS_MENU} menu within the GUI. If sky subtraction is
enabled, it will be performed in one of two ways, depending on whether
any sky frames have been supplied:

\begin{enumerate}

\item The user can supply a set of sky frames (one for each input object
frame) when POLKA is run, using the SKYFRAMES parameter. Each sky
frame is subtracted off the corresponding input object frame,
pixel-by-pixel, before extracting and aligning the output images. If only
one sky frame is supplied, then it is used for all input object frames.
The sky frames must be specified when POLKA is run; they may not be
specified within the GUI.

\item If no sky frames are supplied, then the user should identify sky areas
within each of the input object frames (this is done in a similar way to
the identification of the $O$ and $E$ ray masks).\footnote{In dual beam
mode, separate sky areas must be identified for the $O$ and $E$ ray
pictures. In single-beam mode, only $O$-ray sky areas are supplied.}
Upon completion, these sky areas are extracted and cleaned by removing
any small bright features. The \xref{KAPPA}{sun95}{} application
\xref{SURFIT}{sun95}{SURFIT} is then used to fit a polynomial surface
to the sky areas for each ray (the order of this surface may be controlled
by the user), and extrapolated to cover the rest of the output image.
Finally, this fitted surface is subtracted from the output image.

\end{enumerate}

The effect of sky subtraction on an image can be previewed using the
\htmlref{\emph{Fit Sky}}{POLKA_FITSKY_EFFECT} item in the
\htmlref{\emph{Effects}}{POLKA_EFFECTS_MENU} menu.

\subsection{\mylabel{POLKA_ALIGNMENT}Image Alignment}
Alignment of the extracted, sky-subtracted images is based on the
position of stars identified by the user within the images. The mapping
between any pair of images is assumed to be a shift of origin plus an
optional magnification. A rotation may also be included if POLKA is being
run in single-beam mode.

For non-polarimeter data, a full six co-efficient linear mapping may be
used which can produce shift, magnification, rotation and shear.

In all cases, the coefficients of the mappings are determined by
performing a least squares fit between the positions in the two images.
The images are re-sampled using either nearest-neighbour or bi-linear
interpolation once all required mappings have been determined, and any
sky background has been subtracted.

\subsection{\mylabel{POLKA_STOCAL}Calculation of Stokes Vectors}
The last stage in the processing is to create a data cube in which the
\emph{x-y} plane is aligned with sky-subtracted intensity images, and
\emph{z} axis holds the Stokes vector at every pixel. This stage is only
performed if a value is specified for parameter \xref{OUT\_S}{sun223}{POLKA}
when POLKA is run. The calculation of the Stokes vectors is performed by
the POLPACK application \xref{POLCAL}{sun223}{POLCAL}. If necessary,
POLCAL can be run again after POLKA has terminated, using the aligned
intensity images created by POLKA as inputs. This may be useful, for
instance, if you want to run POLCAL with a different set of parameters
values to those used within POLKA.

\section {\mylabel{POLKA_TUTORIAL}Tutorial}
This is a click-by-click introduction to the use of POLKA, which aims to
get you going with the minimum delay. It does not cover all possibilities,
and assumes you have a relatively simple problem to solve. In particular,
it assumes that the sky background for each output image is to be
estimated within a specified area of the corresponding input object frame
(see \slhyperref{here}{section }{}{POLKA_SKYSUB} if you wish to use
separate sky frames instead).

The \htmlref{\emph{Dump}}{POLKA_DUMP} command (available in the
\htmlref{\emph{File}}{POLKA_FILE_MENU} menu) can be used to save
information describing any identified features, masks, sky regions, etc,
to a disk file at any time. This information may be restored using the
\htmlref{\emph{Restore}}{POLKA_RESTORE} command. This facility enables
execution of POLKA to be interrupted and continued at a later time.

\subsection {\mylabel{POLKA_SBEAM_TUT}Single-beam Mode}
Single-beam mode is very similar to dual-beam mode. The only real
difference is that no features, masks or sky areas related to the $E$-ray
need be given (consequently, the controls related to the $E$ ray are
disabled in single-beam mode). The required areas in each input frame are
referred to as the ``$O$-ray image``. An $O$-ray mask can still be
supplied, in order to define the areas of each input frame to be copied
to the corresponding output frame.

For further details, see the \htmlref{Dual-beam tutorial}{POLKA_DBEAM_TUT}.

\subsection {\mylabel{POLKA_DBEAM_TUT}Dual-beam Mode}

\subsubsection {Specifying the input and output images.}
The first thing to do is to activate POLKA, specifying the input and
output images, and the operation mode. For instance, if you
want to process all images in the current directory matching the wild-card
template \textbf{m101\_?}, putting the output $O$-ray intensity images
in \textbf{m101\_a\_O}, \textbf{m101\_b\_O}, etc, the output $E$-ray intensity
images in \textbf{m101\_a\_E}, \textbf{m101\_b\_E}, etc, and the Stokes vector
in \textbf{cube} then run POLKA as follows:

\begin{terminalv}
   % polka in='m101_?' out_o='*_O' out_e='*_E' out_s=cube
\end{terminalv}

Note, the quotes are only needed to prevent the wild-card characters
being interpreted by the shell. They should not be included if the
parameter values are supplied in response to prompts rather than on the
command line, or if POLKA is run from ICL. The input files may also be
specified by a comma-separated list of explicit names (eg \textbf{m101\_a,m101\_b,m101\_c,m101\_d}), or by giving the name of a text file
containing the names of the input images (in which case the text file
name must be preceded by a hat ``\verb+^+'' character). The names of the
output images may also be supplied as a list, or in two text files in a
similar way.

The POLKA Graphical User Interface is then constructed, which may take
several seconds. The first of the input images (\textbf{m101\_a} in the
above example) is then displayed. On completion, the output intensity
images and the \emph{x-y} plane in the Stokes vector cube will all be
aligned with the $O$ ray picture extracted from the first input image.

\subsubsection {Selecting the options to be used.}
Next, you should set up the options to be used. This is done by clicking
on the \htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu button towards
the top left of the GUI. A menu of options which can be used to customise
the operation of POLKA is then displayed (the current option values are
shown in the \htmlref{status area}{POLKA_STATUS_AREA} below the image
display). The current option values may be saved by pressing the \emph{Save Options} item at the bottom of the \emph{Options} menu, in which case
they become the default values for subsequent invocations of POLKA.

\subsubsection {Identifying $O$-ray features in the first image.}
The default scaling for the displayed image will usually result in the
centres of star-like features being reasonably easy to locate. If this is
not the case, use the \htmlref{\emph{\% black}}{POLKA_BLACK} and
\htmlref{\emph{\% not white}}{POLKA_NOT_WHITE} entry boxes
in the \htmlref{\emph{Display Controls}}{POLKA_DISPLAY_CONTROLS} box
(to the left of the image) to adjust the scaling of the image. Also,
ensure that the \emph{$O$-ray features} button is selected in the box
labelled ``\htmlref{\emph{Current}}{POLKA_CURRENT}'' (below the left hand
end of the menu bar). You are now ready to identify the image features
which define the co-ordinate frame of the $O$-ray picture in the first
input image. You should supply as many as possible since this will
improve the accuracy of the image alignment. Each feature will be given a
numerical label automatically.

To identify a feature, point the cursor (a cross-hair by default) as
close as possible to the centre of the feature, as estimated by eye, and
click the left hand mouse button. An attempt is then made to find a more
accurate centre for the feature by a centroiding process. This improved
estimate of the centre is identified by a red ``current object'' marker
(the colour can be changed using the \htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu). It is possible for the centroiding
process to give an erroneous result, particularly if the feature is on a
strongly varying background, or is particularly large. It is therefore
always worthwhile to check that the accurate position looks reasonable.
If it does, go on to give another feature, or jump to the next stage if
you have identified them all. You may sometimes wish to disable the
centroiding process by setting the \htmlref{\emph{Feature
Size}}{POLKA_FEATURE_SIZE} option to zero in the \htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu, in which case no attempt is made to
improve the supplied feature positions. To delete an erroneous feature,
draw a box round it (by clicking and dragging over the image), and then
press the \htmlref{\emph{Delete}}{POLKA_DELETE} button in the \emph{Display Controls} box (note, this will delete \textbf{all} \emph{current}
features within the box).

It is often useful to be able to zoom in on the area around a feature
(for instance when identifying the centre, or checking that the
centroided position looks reasonable). To do this, draw a box enclosing
the area of interest by clicking and dragging over the image, and then
press the \htmlref{\emph{Zoom}}{POLKA_ZOOM} button. The image will be
re-displayed so that the selected area fills the display window in at
least one dimension. Alternatively, you can re-display the image at the
same scale but with a different centre by clicking on the \htmlref{\emph{Centre}}{POLKA_CENTRE} button. You should then position the cursor,
which will have changed to a circle, over the image and click the
left button. The image will be re-displayed with the selected position at
the centre of the display window.

Pressing the \htmlref{\emph{Unzoom}}{POLKA_UNZOOM} button, situated below
the \htmlref{\emph{Zoom}}{POLKA_ZOOM} button, will undo the effect of the
most recent zoom or centre operation. It may be used repeatedly to undo
the effects of several such operations. Note, the grey scale used to
display the image will (in general) change when the image is zoomed or
centred. This is because the data values corresponding to black and
white are not specified directly, but as percentage points within the
histogram of displayed pixel values. To prevent the scaling from
changing, press the \htmlref{\emph{Lock Scaling}}{POLKA_LOCK_SCALING}
button (situated at the bottom of the \htmlref{\emph{Display Controls}}
{POLKA_DISPLAY_CONTROLS} box). The actual data values corresponding to
black and white will then be frozen at their current values until the
button is de-selected.

\subsubsection {Identifying $E$-ray features in the first image.}
This section is only applicable to dual-beam data. If you have
single-beam data pass on to section ``\htmlref{Identifying the O-ray Areas}
{TUT_O_RAY_AREAS}''.

Once the $O$-ray features have been identified, you need to identify the
corresponding $E$-ray features. To do this, select the \emph{E-ray
features} button in the box labelled ``\htmlref{\emph{Current:}}{POLKA_CURRENT}''. The markers for the $O$-ray features will
disappear, and you may then identify any number of features in the
$E$-ray picture. As an aid to locating the required features, the $O$-ray
features previously identified may be displayed for reference purposes. To
do this, press the \emph{$O$-ray features} button in the box labelled
``\htmlref{\emph{Reference:}}{POLKA_REFERENCE}''. Green markers will be
displayed at the positions of the $O$-ray features.

In order to estimate the mapping between the $O$ and $E$ ray pictures, it
is necessary to know which $E$-ray feature corresponds to each $O$-ray
feature. To do this, every feature is given a numerical label. Features
with the same label in different pictures are assumed to correspond to
the same object on the sky. The label of any feature (whether a ``\emph{Current}'' feature or a ``\emph{Reference}'' feature) can be found by
placing the cross-hair over the associated marker. The feature label
will then be shown in the \htmlref{status area}{POLKA_STATUS_AREA} below
the image.

When an $E$-ray feature is identified, a \htmlref{dialog
box}{POLKA_GET_LABEL} will appear asking the user to select a label for
the feature. If the feature corresponds to one of the $O$-ray features
shown by the green reference markers (which it should do), then it can be
given the correct label by simply positioning the cross-hair over the
corresponding $O$-ray feature and clicking the left mouse button. The
image may be zoomed and centred if necessary to find the correct
reference feature. Alternatively, a label can be selected from a list in
the dialog box containing all the labels currently in use. To do this,
position the pointer over an entry in the list and double click (or
single click and then click the \emph{OK} button). If the feature has not
previously been identified in any picture, then the \emph{New} button
should be pressed, and an unused label will be assigned to the feature.

\subsubsection {Verifying the $OE$ mapping.}
This section is only applicable to dual-beam data. If you have
single-beam data pass on to section ``\htmlref{Identifying the O-ray Areas}
{TUT_O_RAY_AREAS}''.

Once the $O$ and $E$ ray features have been identified, it is a good idea
to press the \htmlref{\emph{Draw Aligned}}{POLKA_DRAW_ALIGNED} button in
the box labelled ``\htmlref{\emph{Reference:}}{POLKA_REFERENCE}''. This
will cause the mapping between the $O$ and $E$ ray pictures to be
estimated on the basis of the supplied features. The green reference
markers for the $O$-ray features will then be re-drawn in the co-ordinate
frame of the $E$-ray picture. If the mapping is successful, each green
``\emph{reference}'' marker should be drawn on top of the corresponding
red ``\emph{current}'' marker. If these markers are not in alignment, it
probably means that you have assigned incorrect labels to one or more of
the $E$-ray features, and you should delete the incorrect features and
try again. To do this, draw a box around the suspect $E$-ray features by
clicking and dragging over the image, and then press the \htmlref{\emph{Delete}}{POLKA_DELETE} button. The mapping can be re-estimated on the
basis of the new list, and the reference features re-drawn, by clicking
the \htmlref{\emph{Re-draw}}{POLKA_REDRAW} button (located under the \emph{Draw Aligned} button). Another possible cause is that you have selected
an inappropriate mapping type from the \htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu.

\subsubsection {\mylabel{TUT_O_RAY_AREAS}Identifying the $O$-ray areas.}
You now need to draw a mask over the image to define the areas containing
the $O$-ray picture. A mask consists of one or more polygonal areas, each
being given by positioning the cross-hair at each vertex in turn and
clicking the left mouse button.

In single-beam mode, this step is optional. If no mask is supplied, a
default mask will be used which encloses the entire image.

Select \emph{O-ray mask} from the box labelled ``\htmlref{\emph{Current:}}{POLKA_CURRENT}''. Position the cross-hair at a point on the
edge of the $O$-ray area, and press the left mouse button, being careful
not to move the mouse while the button is pressed. If you do accidentally
move the mouse while the button is pressed, an area selection box will be
drawn instead of a vertex being defined. In this case, just click again
where the vertex should be, and the box will disappear. Move the cursor
to the next vertex and click again. Continue in this way until all the
vertices in the first polygonal area have been given. The image may be
zoomed and centred at any time while this is being done by using the
\htmlref{\emph{Zoom}}{POLKA_ZOOM} and \htmlref{\emph{Centre}}{POLKA_CENTRE}
buttons. To close the polygon, click on the first vertex. Pressing the
\htmlref{\emph{Cancel}}{POLKA_CANCEL} button in the \htmlref{\emph{Display
Controls}}{POLKA_DISPLAY_CONTROLS} box will abort the operation,
deleting the incomplete polygon. If there are other $O$-ray areas not
included in the first polygon, supply further polygons in the same way
until all $O$-ray areas have been enclosed.

Once a polygon has been supplied, it can be edited in various ways. To
move a vertex, position the cross-hair over the vertex, press and hold
the left mouse button, and move the cross-hair to the required position.
The vertex will be dragged to the new location. To add an extra vertex,
position the cross-hair over one of the edges of the polygon and click
the left mouse button. To delete one or more vertices, draw a box around
them by clicking and dragging, and then press the \htmlref{\emph{Delete}}{POLKA_DELETE} button.

If you want to use the same masks for several runs, you can save the $O$
and $E$ ray masks to a text file on disk using the
\htmlref{\emph{Dump/Masks Only}}{POLKA_DUMP} item in the
\htmlref{\emph{File}}{POLKA_FILE_MENU} menu to save the mask geometry to
a text file. On each subsequent run, you can restore these masks using the
\htmlref{\emph{Restore/Masks Only}}{POLKA_RESTORE} item in the \htmlref{\emph{File}}{POLKA_FILE_MENU}
menu.

\subsubsection {Identifying the $E$-ray areas.}
This section is only applicable to dual-beam data. If you have
single-beam data pass on to section ``\htmlref{Identifying the Sky Areas}
{TUT_SKY_AREAS}''.

Once the $O$-ray areas have been identified, you can click on the \emph{E-ray mask} button in the box labelled \htmlref{\emph{Current:}}{POLKA_CURRENT}. This will cause a default $E$-ray mask to be
created by transforming the $O$-ray mask using the current mapping
between the $O$ and $E$ ray pictures. You can then
\htmlref{edit}{POLKA_EDITING_POLYGONS} this mask, if necessary, using the
same techniques as for the $O$-ray mask. Note, default masks are created
using the current mappings. No attempt is made to modify these masks to
take account of any subsequently changes in the mappings.

\subsubsection {\mylabel{TUT_SKY_AREAS}Identifying the sky areas.}
The next step is to identify the areas in which the sky background will
be estimated.\footnote{This tutorial assumes that the input object frames
contain some suitable sky areas. If this is not the case, then you may
wish to supply separate sky frames instead. To do this, you should assign
the list of sky frames to the SKYFRAMES parameter when starting POLKA. If
this is done you need not identify any sky areas manually.} To do this,
click on the \emph{O-ray sky area} button in the box labelled
\htmlref{\emph{Current:}}{POLKA_CURRENT}. You then identify sky areas
within the $O$-ray picture using the cursor in just the same way as the
$O$-ray mask. More than one polygon may be supplied if necessary. If you
do not wish to subtract any sky background, then clear the
\htmlref{\emph{Remove Sky}}{POLKA_REMOVE_SKY} box in the
\htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu.

By default, a flat surface will be fitted to these sky areas and
subtracted from the corresponding output images upon completion. However,
a varying polynomial surface can also be fitted by selecting a value
greater than zero for the \htmlref{\emph{Sky Order}}{POLKA_SKYORDER} item
in the \htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu. Larger values
allow more flexibility in the fitted surface. In this case, you should
try to give sky areas at several widely spaced positions within the image
in order to constrain the fitted surface. For instance, if you only gave
one small sky area near a corner of the image, then the fitted surface
would be poorly constrained in the opposite corner. This could easily
result in the surface being be a very bad estimate of the sky background
there! You can check that the fitted surface is reasonable by clicking on
the \htmlref{\emph{Fit Sky}}{POLKA_FITSKY_EFFECT} item in the
\htmlref{\emph{Effects}}{POLKA_EFFECTS_MENU} menu. This will perform
the fit to the sky background in the currently displayed image, using the
current sky areas, and will display either the sky fit itself, or the sky
subtracted data. Click on the
\htmlref{\emph{Undo All}}{POLKA_UNDO_ALL_EFFECTS} item in the
\htmlref{\emph{Effects}}{POLKA_EFFECTS_MENU} menu to restore the original
displayed image.

If you have dual-beam data, then once the $O$-ray sky areas have been
identified, you can click on the \emph{E-ray sky areas} button in the box
labelled \htmlref{\emph{Current:}}{POLKA_CURRENT}. This will cause default
$E$-ray sky areas to be created by transforming the $O$-ray sky areas
using the current mapping between the $O$ and $E$ ray pictures. You can
then \htmlref{edit}{POLKA_EDITING_POLYGONS} these
areas, if necessary. Note, default sky areas are created using the
current mappings. No attempt is made to modify these areas to take
account of any subsequently changes in the mappings.

\subsubsection {Identifying $O$-ray features in the next input image.}
Now, you need to supply features which allow the next image to be
aligned with the first image. To do this, select the next image by
clicking on the \htmlref{\emph{Images}}{POLKA_IMAGES} menu, and then
clicking on the required image name. The new image will be displayed.
Note, by default, the current zoom factor and image centre are retained
when a new image is displayed, so you may not see all of the new image in
the display area. If you want the display to be unzoomed and centred
automatically each time a new image is displayed, click on the
\htmlref{\emph{View}}{POLKA_VIEW} entry in the \htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu, and select the \emph{Unzoomed} option.

Next, select the \emph{O-ray features} button in the box labelled
\htmlref{\emph{Current:}}{POLKA_CURRENT}. This tells POLKA that you are
about to supply some $O$-ray feature positions. Also, select the
\emph{O-ray features} button in the box labelled
\htmlref{\emph{Reference:}}{POLKA_REFERENCE}. This will cause
a set of green reference markers to be drawn at the positions of the
$O$-ray features from the first image. Note, if you still have the
\htmlref{\emph{Draw Aligned}}{POLKA_DRAW_ALIGNED} button selected, then
you will get a warning message saying that the reference markers cannot
be drawn aligned because the mapping required to align them with the new
image is not yet known. The \emph{Draw Aligned} button will then be
de-selected automatically, and the reference markers will be drawn in the
coordinate frame of the first image.

You can now identify features by positioning the cursor over a feature in
the new image and clicking the left mouse button. You will again be asked
to label the feature, which you can do by pointing and clicking over the
corresponding green reference marker. If you have identified a feature
which does not exist in the first image (i.e. one for which there is no
reference marker) then press the \emph{New} button in the \htmlref{\emph{Select feature label}}{POLKA_GET_LABEL} dialog box to assign it a new
label. Once you have identified two or three positions, you can select
the \htmlref{\emph{Draw Aligned}}{POLKA_DRAW_ALIGNED} button again. Since
some features have now been identified in the new image, the mapping
between the first image and the new image can be determined, and the
entire set of green reference markers will be mapped into the coordinate
frame of the displayed image.

You should find that each green marker falls on top of an image feature
in the new image. If this is not the case, you may have chosen the wrong
label for one or more of the features in the new image. To correct this,
use the \htmlref{\emph{Delete}}{POLKA_DELETE} button to delete the suspect
red markers, and then identify them again, this time assigning the
correct label. Once this is done, press the \htmlref{\emph{Re-draw}}{POLKA_REDRAW} button to re-estimate the mapping and re-draw the
reference markers using the new mapping. If this does not fix the
problem, you may have selected an inappropriate type for the
image-to-image mappings. For instance, if there is rotation between the
images and you have selected \emph{Shift of origin only}, then you will
not be able to get the features to appear in the correct positions. To
correct this select a mapping type with fewer restrictions using the
\htmlref{\emph{Mapping Types}}{POLKA_MAP_TYPES} entry in the \htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu.

Once the green markers are correctly positioned, press the
\htmlref{\emph{Accept}}{POLKA_ACCEPT} button to identify the features
automatically. Pressing this button is equivalent to going
through each of the reference features, identifying the corresponding
feature by hand in the new image. You should then press the \htmlref{\emph{Re-draw}}{POLKA_REDRAW} button again, to check that the final mapping
looks reasonable.

\subsubsection {Identifying $E$-ray features in the next input image.}
This section is only applicable to dual-beam data. If you have
single-beam data pass on to section ``\htmlref{Identifying masks and sky areas in the next input image}
{TUT_NEXT_MASK}''.

In general, you will not need to identify any $E$-ray features in the new
image. This is because the $OE$ mapping for each image is assumed to be
the same as for the first image. If this is not the case, then some
$E$-ray features should be explicitly identified in the new image. The
$OE$ mapping implied by these features will over-ride the default mapping
inherited from the first image. To check the validity of an $OE$
mapping, select the \emph{E-ray features} button in the box labelled
\htmlref{\emph{Current:}}{POLKA_CURRENT}, the \emph{O-ray features} button in
the box labelled \htmlref{\emph{Reference:}}{POLKA_REFERENCE}, and the
\htmlref{\emph{Draw Aligned}}{POLKA_DRAW_ALIGNED} button. This will cause
the $O$-ray features from the first image to be mapped into the $E$-ray
frame of the new image, using the $OE$ mapping. If they are incorrectly
positioned then you probably need to over-ride the default $OE$ mapping
by explicitly identifying some $E$-ray features. To do this, you should
use the same technique as for the $O$-ray features. If the green
reference markers line up well with features in the $E$ ray picture, then
you can simply press the \htmlref{\emph{Accept}}{POLKA_ACCEPT} button to
identify the features automatically.

\subsubsection {\mylabel{TUT_NEXT_MASK}Identifying masks and sky areas in the next input image.}
In general, you will not need to identify any masks or sky areas in the
other images. Default $O$ and $E$ ray masks are created on the assumption
that they are identical for all input frames (i.e. that the masks do not
move relative to the detector between frames). Default sky areas are
created by transforming the sky areas defined in the first image, using
the mapping defined by the features identified in both images. To see
these defaults, select one of the buttons in the box labelled
\htmlref{\emph{Current:}}{POLKA_CURRENT}. The corresponding default mask
or sky area will be drawn in red. This may then be
\htmlref{edited}{POLKA_EDITING_POLYGONS} if necessary using the
usual techniques for adding, deleting or dragging vertices. For instance,
movement of the telescope may have resulted in part of the sky region now
lying outside the usable area, in which case the sky region polygons would
need to be edited to exclude these areas.

Note, default masks and sky areas are based on the mappings current when
they were first displayed. No attempt is made to change them to take
account of any subsequent changes in the mappings.

\subsubsection {Finishing the job.}
Repeat the above three steps for all the input images. Once this is done,
all the information needed to create the output files is available, and
you should have confidence in the mappings. Press the \htmlref{\emph{Exit}}{POLKA_EXIT} button in the \htmlref{\emph{File}}{POLKA_FILE_MENU}
menu. The process of extracting the mask areas, fitting and subtracting
the sky background, re-sampling the intensity images, and calculating the
Stokes vectors will then commence. This can take a significant length of
time for anything other than very small images. For this reason a pop-up
window appears showing what is happening, which images have been
processed, and which remain to be processed. This gives some indication
of how long it may take for the processing to be completed. Once this has
been done, the user will be asked to confirm that it is OK to close down
POLKA. Pressing the \emph{OK} button in the dialog box will cause the
POLKA GUI to be closed down, and the system prompt will re-appear.

Note, the output images are cropped so that they are just big enough to
contain the selected areas from the corresponding input image. In
general, they will all have different pixel origins (i.e. the bottom left
pixel will usually not be pixel [1,1]). Most Starlink software recognises
and uses the pixel origin information stored in the output images, but if
you require the images to have a common pixel origin, then the
\xref{KAPPA}{sun95}{} command \xref{SETBOUND}{sun95}{SETBOUND}
can be used to set the origin for each output image as follows:

\begin{terminalv}
   % kappa
   % setbound ndf='m101_a_O(1:,1:)'
\end{terminalv}

This will pad or trim the image \textbf{m101\_a\_O} so that its bottom left
corner is at pixel [1,1], leaving the top left corner unchanged.

\section {\mylabel{POLKA_CONTROLS}A Tour of the Graphical User Interface}
This section gives detailed descriptions of each control in the POLKA
Graphical User Interface. The controls are divided up into groups on the
basis of their purpose and position with the interface.

\subsection {\mylabel{POLKA_FILE_MENU}The \emph{File} Menu}
The \emph{File} menu provides access to commands which control
temporary interruption of POLKA,
termination of POLKA, and the creation of the output images. They are:

\subsubsection {\mylabel{POLKA_DUMP}\emph{Dump}}
Dumps information describing supplied features and masks to a text file
on disk which can be restore in a subsequent run of POLKA, using the
\htmlref{\emph{Restore}}{POLKA_RESTORE} command. There are three
options:

\begin{description}

\item [\emph{Everything}] - Creates a new text file holding all the current
feature positions, masks, mappings, etc, for all images. This can be useful,
for instance, if you want to interrupt POLKA before the output data files
have been created. You may then re-start POLKA later on, and use the
\htmlref{\emph{Restore}}{POLKA_RESTORE} command to restore the conditions
which existed when the dump file was created.

\item [\emph{Masks Only}] - Creates a new text file holding just the $O$
and $E$ ray masks from the first (reference) image. This can be useful
as a means of saving masks to be re-used in several different runs.

\item [\emph{Displayed image}] - Creates a new text file holding the
feature positions, the $O$ and $E$ ray masks and the sky area masks from the
currently displayed image. This can be useful if you want to re-use the
same image in several runs.

\end{description}

In all cases, you supply the name of the text file in a simple dialog
box (you are asked for confirmation if you specify the name of an
existing file).

\emph{{\center Note, you should not change the contents of the dump file.}}

\subsubsection {\mylabel{POLKA_EXIT}\emph{Exit}} Creates the output images by executing
the \htmlref{\emph{Save}}{POLKA_SAVE} command, and then closes down
POLKA. The user is asked to confirm the operation once the output images
have been saved.

\subsubsection {\mylabel{POLKA_RESTORE}\emph{Restore}}
This restores features lists, masks, mappings, etc, from a text file
created earlier using the \htmlref{\emph{Dump}}{POLKA_DUMP} command.
\htmlref{\emph{Restore}}{POLKA_RESTORE} command. There are three
options:

\begin{description}

\item [\emph{Everything}] - Restores current feature positions, masks,
mappings, etc, for all images, replacing any existing values. If the
supplied dump file contains information for too many images (i.e. more
than is available in the current invocation of POLKA), then the extra
information is ignored. If there are two few images described in the dump
file, then the extra images are left unchanged.

\item [\emph{Masks Only}] - Reads an $O$ and an $E$ ray mask from the supplied
file, and assigns them to all images, replacing any existing masks.

\item [\emph{Displayed Image}] - Restores feature positions, masks, and
sky areas for the currently displayed image, replacing any existing values.

\end{description}

In either case, the file should have been created using the
corresponding option in the \htmlref{\emph{Dump}}{POLKA_DUMP} command.

\subsubsection {\mylabel{POLKA_SAVE}\emph{Save}} Causes the output images to be
created, based on the current set of image feature positions and area masks. If
these have not changed since the last time the output images were saved,
no new images are created. If the required features and masks have not
yet been supplied, then a warning message is displayed, and no images are
created. Unlike the \emph{Exit} command, the \emph{Save} command does not
cause POLKA to close down.

\subsubsection {\mylabel{POLKA_QUIT}\emph{Quit}} Closes down POLKA without first saving the output
images. The user is asked to confirm the operation.

\subsection {\mylabel{POLKA_EDIT_MENU}The \emph{Edit} Menu}
The \emph{Edit} menu provides access to commands which relate to
the changing of information stored within POLKA. They are:

\subsubsection {\mylabel{POLKA_CLEAR_ALL}\emph{Clear All}} Causes all currently defined information to be
erased. This includes all feature positions, masks and mappings. Use it
if you make a real mess of things! It is equivalent to closing down POLKA
and starting it up again with the same options and input images.

\subsubsection {\mylabel{POLKA_CLEAR_CURRENT}\emph{Clear Current}} Causes the
current objects associated with the displayed image to be erased. The
current objects are selected using the buttons in the box labelled
``\htmlref{\emph{Current:}}{POLKA_CURRENT}''. For instance, if the the
\emph{$O$-ray features} button is currently checked, then this menu item
will result in all $O$-ray feature positions being cleared from the
currently displayed image.

\subsubsection {\mylabel{POLKA_CLEAR_IMAGE}\emph{Clear Image}} Causes the
currently defined information relating to the displayed image to be
erased. This includes all feature positions, masks and mappings.

\subsubsection {\mylabel{POLKA_COPY}\emph{Copy}} Stores copies of any
whole polygons enclosed within the selected area. This entry is disabled
if no area is currently selected. \slhyperref{Go here}{See
section}{}{POLKA_AREA_SELECTION} for instructions on selecting areas. Any
copied polygons may subsequently be pasted back into the display using
the \htmlref{\emph{Paste}}{POLKA_PASTE} entry in the \emph{Edit} menu.

\subsubsection {\mylabel{POLKA_DELETE_FEATURES}\emph{Delete}} Deletes any features
or mask vertices contained within the currently selected area on the
displayed image. See \slhyperref{here}{section }{}{POLKA_AREA_SELECTION}
for details of how to select an area. This menu item performs an
identical function to the \htmlref{\emph{Delete}}{POLKA_DELETE} button in
the \htmlref{\emph{Display Controls}}{ POLKA_DISPLAY_CONTROLS} box.

\subsubsection {\mylabel{POLKA_EDIT_MAPPINGS}\emph{Mappings}} Allows the current
mappings associated with a particular image to be examined and optionally
modified. This facility may be used to enforce particular values for the
mapping parameters, rather than allowing their values to be determined by
the identified image features. Selecting this item will display a
sub-menu containing a list of all the supplied images. Clicking on the
required image will cause the \htmlref{\emph{Edit a
mapping}}{POLKA_EDIT_MAPPING_DIALOG} dialog box to be displayed.

\subsubsection {\mylabel{POLKA_PASTE}\emph{Paste}} Pastes any previously
copied polygons onto the display. This entry is disabled unless one or
more polygons have been copied using the \htmlref{\emph{Copy}}{POLKA_COPY}
entry in the \emph{Edit} menu. The new polygon belongs to the class of
object selected in the box labelled ``\htmlref{\emph{Current:}}{POLKA_CURRENT}''. They may be edited or moved as usual
(\slhyperref{go here}{see section }{}{POLKA_EDITING_POLYGONS} for details).

\subsection {\mylabel{POLKA_OPTIONS_MENU}The \emph{Options} Menu}
The \emph{Options} menu provides access to commands which control the
various options which are available to customise the operation of POLKA.
These options may also be set on the command line used to activate
POLKA. The menu items are:

\subsubsection {\mylabel{POLKA_COLOURS}\emph{Colours}}
This allows control of the colours used to represent various objects in
the POLKA GUI. Upon selection, a menu of objects appear including:

\begin{description}

\item [\emph{Cross-hair}] - This sets the colour of the cross-hair which
is used within the \htmlref{image display area}{POLKA_IMAGE_DISPLAY} if
the \htmlref{\emph{Use Cross-hair}}{POLKA_USE_CROSS_HAIR} option is
selected. It defaults to yellow.

\item [\emph{Current Objects}] - This sets the colour of the markers and
lines used to indicate the current objects (image features or masks)
selected in the box labelled ``\htmlref{\emph{Current:}}{POLKA_CURRENT}''.
It defaults to red.

\item [\emph{Missing Pixels}] -  This sets the colour used to represent
missing data in the \htmlref{image display area}{POLKA_IMAGE_DISPLAY}.
It defaults to cyan.

\item [\emph{Reference Objects}] - This sets the colour of the markers and
lines used to indicate the reference objects (image features or masks)
selected in the box labelled ``\htmlref{\emph{Reference:}}{POLKA_REFERENCE}''.
It defaults to green.

\item [\emph{Selection Box}] - This sets the colour of the box
which indicates an area of the image to be zoomed, or from which objects
are to be deleted. It defaults to red. \slhyperref{Go here}{See
section }{}{POLKA_AREA_SELECTION} for instructions on selecting areas.

\end{description}

When one of these items is selected, a menu of colours appears from which
a selection may be made. The available colours are red, blue, green,
cyan, magenta, yellow, black.

\subsubsection {\mylabel{POLKA_FEATURE_SIZE}\emph{Feature Size}} This option
controls the centroiding process which is used to find accurate image
feature positions from the initial guesses supplied by the user. It
should be set to an estimate of the typical width (in pixels) of the
features which will be used to determine the mappings. The size of the
box used to estimate the centroid is set to twice the supplied figure,
and the maximum shift allowed from the initial position is set to four
times the supplied figure.\footnote{Successive estimates of the centroid
are made, with the box centred on the previous estimate.} If the feature
size is set to zero, then no centroiding is performed. In this case the
initial positions supplied by the user are used directly.

Note, the centroiding process is performed on the selected image, \textbf{after the application of any effects selected using the \htmlref{\emph{Effects}}{POLKA_EFFECTS_MENU} menu}, and assumes that the image features
are positive.

\subsubsection {\mylabel{POLKA_INTERPOLATION_METHOD}\emph{Interpolation Method}}
This determines the method to use when interpolating between the pixel
values in the input images to determine the pixel values in the output
images. It can be either:

\begin{description}
\item [Linear] - Use bi-linear interpolation between the four nearest
input pixels.
\item [Nearest Neighbour] - Use the value of the closest input pixel.
\end{description}

\subsubsection {\mylabel{POLKA_MAP_TYPES}\emph{Mapping Types}} This displays a
list of the types of mappings which can be used to align the input
images. Selecting the \emph{O-E Mapping Type} entry (at the bottom of the
menu) causes a similar menu to be posted which allows the selection of
the mapping to be used between the $O$ and $E$ rays.

The available mappings are all linear, the most general one being the
\emph{Full 6 parameter fit}. This is a mapping of the form:

\begin{eqnarray*}
XX = C_{1} + C_{2}*X + C_{3}*Y \\
YY = C_{4} + C_{5}*X + C_{6}*Y
\end{eqnarray*}

where the co-efficients $C_{1}$ to $C_{6}$ are all independent, and free
to take any value ($(X,Y)$ are the supplied pixel coordinates, and
$(XX,YY)$ are the corresponding mapped pixel coordinates). This type of
mapping can produce shift, rotation, magnification and shear (i.e. the
rotation may be different for the two axes). This is very general,
and it is usually better to choose one of the other constrained linear
mappings. These allow
combinations of shift, rotation and magnification, but no shear (i.e. the
rotation is the same for both axes). In addition, the magnification
produced by these constrained mappings is always the same on both axes.

NOTE, for polarimeter data, any rotation between images
effectively changes the analyser angle. The algorithm used by
\xref{POLCAL}{sun223}{POLCAL} to create Stokes vectors can take account
of this rotation, but only in single-beam mode. For this reason, mappings
which include rotation are not available in dual-beam mode. The full,
unrestricted six co-efficiwent fit can produce shear and should only
be used with non-polarimetric data.

The constrained mappings are specified in terms of the shift, rotation and
magnification which they produce. Using this description, the original
axes are first rotated about their original origin. Each rotated axis is
then magnified, and finally the origin is shifted.

Each mapping type has several free parameters (shifts, rotations, etc)
which can take different values for each input image. These are usually
determined by the image features identified by the user. For each input
image, the parameter values are chosen to minimise the sum of the squared
residuals between the mapped image features and the corresponding image
features in the first input image. The parameter values may be inspected
and edited using the \htmlref{\emph{Mappings}}{POLKA_EDIT_MAPPINGS} item
in the \htmlref{\emph{Edit}}{POLKA_EDIT_MENU} menu.

Mapping parameters are evaluated only when a mapping is required to
perform some operation. For instance, pressing the \htmlref{\emph{Draw
Aligned}}{POLKA_DRAW_ALIGNED} button will cause the parameters to be
evaluated so that the selected reference features can be drawn
aligned with the displayed image. Similarly, \htmlref{saving}{POLKA_SAVE}
the output images, or using the \htmlref{\emph{Mappings}}{POLKA_EDIT_MAPPINGS}
item in the \htmlref{\emph{Edit}}{POLKA_EDIT_MENU} menu, will cause the
parameters to be evaluated. If the image features required to evaluate
the parameters have not changed since the last time the mapping was used
(i.e. if no new ones have been added or existing ones deleted), then the
previous mapping parameters are used. If the required mapping parameters
cannot be evaluated (usually because the user has not yet identified
sufficient image features), then the user is warned, and the selected
operation is canceled.

The current mapping type may be changed at any time, but such a change
does not force the re-calculation of any existing mappings. Mappings
remain unchanged until the user supplies new image features, or deletes
existing ones. The mappings which depend on the image features are then
marked as being out-of-date and will subsequently be re-calculated using
the new mapping type when they are next accessed (eg when displaying
aligned reference features or creating the output images).

\subsubsection {\mylabel{POLKA_POLMODE}\emph{polarimetry Mode}} This is used
to select circular or linear polarimetry mode, and it controls the
contents of the final Stokes cube created when the output data files are
saved. Note, circular polarization can only be measured in dual-beam mode.
This option is disabled if Stokes vectors are not being produced.

\subsubsection {\mylabel{POLKA_SKYORDER}\emph{Sky Order}} This is used to control
the flexibility of the surfaces fitted to the sky background areas. It is
an integer which gives the order of the polynomial fit along each axis
(the same value is used for both axes). It is disabled unless the sky
background is being estimated on the basis of identified sky areas within
the input object frames. A value of zero results in a constant sky
background value being used. A value of 1 results in a linear fit, etc.
Higher values allow more flexibility in the fitted surface. The effect of
using a particular order with the current sky areas can be previewed
using the
\htmlref{\emph{Fit Sky}}{POLKA_FITSKY_EFFECT} item in the
\htmlref{\emph{Effects}}{POLKA_EFFECTS_MENU} menu.

\subsubsection {\mylabel{POLKA_STATUS_ITEMS}\emph{Status Items}} This is used to
customise the contents of the \htmlref{status area}{POLKA_STATUS_AREA}
shown below the image display area. Selecting this item will result in the
\htmlref{\emph{Select status items}}{POLKA_STATUS_ITEMS_DIALOG} dialog
box appearing.

\subsubsection {\mylabel{POLKA_VIEW}\emph{View}} Determines how to display new
images selected using the \htmlref{\emph{Images}}{POLKA_IMAGES_MENU}
menu. It may take one of the values:

\begin{description}

\item [Unzoomed] - Each new image is displayed so that it just fills the
image display area in at least one dimension. The previous scale factor
and image centre are ignored.

\item [Zoomed] - The previous scale factor and image centre are retained
so that (in general) only part of the new image is visible. This is the
default mode. In this mode, the \htmlref{\emph{Unzoom}}{POLKA_UNZOOM} can
be used to unzoom the image manually so that it fills the display.

\end{description}

\subsubsection {\mylabel{POLKA_USE_CROSS_HAIR}\emph{Use Cross-hair}}
If this button is selected then a cross-hair will be used instead of a
pointer within the \htmlref{image display area}{POLKA_IMAGE_DISPLAY}.
The default is to use a cross-hair.

\subsubsection {\mylabel{POLKA_REMOVE_SKY}\emph{Remove Sky}}
If this button is selected then the sky background will be estimated and
subtracted from the output images upon completion. The estimation will be
based on the supplied sky frames, or on the identified sky areas if no
sky frames were supplied. If the button is cleared then no sky background
will be subtracted from the output images, and the
\htmlref{\emph{Fit Sky}}{POLKA_FITSKY_EFFECT} item in the
\htmlref{\emph{Effects}}{POLKA_EFFECTS_MENU} menu is inoperative.

\subsubsection {\mylabel{POLKA_DISPLAY_HELP_AREA}\emph{Display Help Area}}
If this button is selected, then the POLKA GUI will include a
\htmlref{help area}{POLKA_HELP_AREA} in which dynamic help information
on the control under the pointer is displayed. Otherwise, the help area
is not displayed.

\subsubsection {\mylabel{POLKA_DISPLAY_STATUS_AREA}\emph{Display Status Area}}
If this button is selected, then the POLKA GUI will include a
\htmlref{status area}{POLKA_HELP_AREA} in which information
describing the current state (such as image names, options values,
feature labels, pointer co-ordinates, etc) is displayed. Otherwise, the
status area is not displayed. The contents of this area may be customised
using the \htmlref{\emph{Status Items}}{POLKA_STATUS_ITEMS} entry in the
\htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu.

\subsubsection {\mylabel{POLKA_SAVE_OPTIONS}\emph{Save Options}}
If this menu item is selected, the current option values (together with
the values shown in the \htmlref{\emph{\% not white}}{POLKA_NOT_WHITE}
and \htmlref{\emph{\% black}}{POLKA_BLACK} controls) will be saved so that
they become the default values for future invocations of
POLKA.\footnote{The current values are passed back to the POLKA A-task
upon completion, and they are then stored in the A-tasks parameter file.}

\subsection {\mylabel{POLKA_IMAGES_MENU}The \emph{Images} Menu}
This is a menu of the input images supplied when POLKA was
activated. When an image is selected from this menu, it is displayed in
the \htmlref{image display area}{POLKA_IMAGE_DISPLAY} in the manner
determined by the \htmlref{\emph{View}}{POLKA_VIEW} option. If any
effects have previously been applied to the image using the \htmlref{\emph{Effects}}{POLKA_EFFECTS_MENU} menu, then the displayed image will
include these effects.

There is also an entry labelled "Transfer..." which is used to transfer
feature positions from the currently displayed image to any number of
other images without the need to display them first. It should only be
used when your images are already aligned (or nearly aligned). Selecting
this item will result in the \htmlref{\emph{Transfer features}}
{POLKA_TRANSFER_DIALOG} dialog box appearing.

\subsection {\mylabel{POLKA_EFFECTS_MENU}The \emph{Effects} Menu}
This menu allows several special effects to be applied to the displayed
image. The purpose of these effects is to enable the image features to be
found more easily. For instance, if you have a negative image you should
use the \htmlref{\emph{Negate}}{POLKA_NEGATE_EFFECT} effect so that the
centroiding process (which requires a positive image) can work properly.
Another example may be the removal of a varying background (which may upset
the centroiding process) using the
\htmlref{\emph{Filter}}{POLKA_FILTER_EFFECT} effect. Note, the output
images are always based on the supplied input images, and are not
influenced by these effects.

If more than one effect is applied to an image, then each effect is
applied to the image resulting from the previous effect. The most recent
effect may be removed using the \htmlref{\emph{Undo}}{POLKA_UNDO_EFFECT}
menu item. All effects may be removed using the \htmlref{\emph{Undo
All}}{POLKA_UNDO_ALL_EFFECT} menu item.

Effects applied to an image remain active until they are canceled using
the \htmlref{\emph{Undo}}{POLKA_UNDO_EFFECT} or
\htmlref{\emph{Undo All}}{POLKA_UNDO_ALL_EFFECTS} items in this menu. Thus
if some effects are applied to an image and then a different input image
is selected (using the \htmlref{\emph{Images}}{POLKA_IMAGES_MENU} menu),
the effects will still be in place when the original image is re-selected.

\subsubsection {\mylabel{POLKA_ALIGN_EFFECT}\emph{Align} }
Re-displays the current image in alignment with another specified image.
This can only be done if the image mappings for both images are
available. All the positions associated with the re-aligned image are
modified so that they refer to the coordinate frame of the second image.

\subsubsection {\mylabel{POLKA_FILL_EFFECT}\emph{Fill} }
Replaces any bad pixels in the displayed image using either a constant
value, or a smooth surface which is continuous with the surrounding good
data.

\subsubsection {\mylabel{POLKA_FILTER_EFFECT}\emph{Filter} }
Applies a high pass filter to the displayed image (i.e. removes any
slowly varying background, leaving only features comparable to or smaller
than a specified size).

\subsubsection {\mylabel{POLKA_FITSKY_EFFECT}\emph{Fit Sky} }
Estimates the sky background in the displayed image based on the current
sky areas or supplied sky frames, using the same method used to fit the
sky when creating the output data files. The displayed image may be
replaced either by the fit itself, or by the difference between the
currently displayed image and the fit. The fit is based on the current
options values (such as \htmlref{\emph{Sky Order}}{POLKA_SKYORDER}).

\subsubsection {\mylabel{POLKA_LOG_EFFECT}\emph{Log} }
Takes the log (base 10) of the difference between each pixel value and the
minimum pixel value in the displayed image.

\subsubsection {\mylabel{POLKA_MATHS_EFFECT}\emph{Maths} }
Combines images on the effects stack using an arbitrary algebraic expression
to combine the pixel values. It is based on the \xref{MATHS}{sun95}{MATHS}
application from \xref{KAPPA}{sun95}{}, which should be consulted for
details of the syntax of the expression. Within the expression, the token IA
refers to the currently displayed image, IB refers to the image before
the previous effect was applied (if any), IC refers to the image before
that, etc. An error is reported if images do not exist for any of the
tokens in the expression (for instance, if you include token IB when no
previous effects have been applied).

As an example, suppose you have previously applied two other effects to
the image, and give the expression:

\begin{terminalv}
   IA - 2.5*LOG( IB - IC )
\end{terminalv}

In this expression IA refers to the currently displayed image (including
both effects), IB refers to the image before the second effect was
applied, and IC refers to the image before the first effect was supplied
(i.e. the original image).

Parameter tokens (PA, PB, etc) and sub-expression tokens (FA, FB, etc) should
not be included in the expression.

\subsubsection {\mylabel{POLKA_NEGATE_EFFECT}\emph{Negate} }
Multiplies every pixel value in the displayed image by minus one.

\subsubsection {\mylabel{POLKA_SMOOTH_EFFECT}\emph{Smooth} }
Applies Gaussian smoothing to the displayed image.

\subsubsection {\mylabel{POLKA_STATS_EFFECT}\emph{Stats} }
This effect does not produce any changes in the displayed image. Instead,
a pop-up window is displayed containing statistics for the pixel values
within the currently selected area of the displayed image. Note, you must
select an area before using this effect, by clicking and dragging across
the image with the left mouse button. \slhyperref{Go here}{See section
}{}{POLKA_AREA_SELECTION} for further details on selecting areas.

\subsubsection {\mylabel{POLKA_THRESHOLD_EFFECT}\emph{Threshold} }
Applies upper and lower limits to the pixel values in the displayed image.
Out-of-bounds pixels can either be removed (i.e. set bad), or set to the
corresponding limit value.

\subsubsection {\mylabel{POLKA_SHOW_EFFECTS}\emph{Show Effects} }
Creates a dialog box containing a list of the effects applied to the
currently displayed image.

\subsubsection {\mylabel{POLKA_UNDO_EFFECT}\emph{Undo} }
Removes the most recently applied effect from the currently displayed
image.

\subsubsection {\mylabel{POLKA_UNDO_ALL_EFFECTS}\emph{Undo All} }
Removes the all effects from the currently displayed image. The original
image as supplied by the user is then displayed.

\subsection {\mylabel{POLKA_HELP_MENU}The \emph{Help} Menu}
This menu provides access to the POLKA hyper-text help information.
\slhyperref{Go here}{See section }{}{POLKA_USING_HELP} for more information
on selecting which browser is to be used. This menu provides several preset
access points for the help information. The \emph{Pointer} item allows the
required help to be specified by pointing at a control on the GUI using the
mouse, and then pressing the left mouse button. A similar effect can be
produced without using this option by positioning the pointer and then
pressing the F1 button on the keyboard. The hyper-text help information
may also be searched for specified keywords using the
\htmlref{\emph{Search for...}}{POLKA_HSEARCH} entry in the \emph{Help} menu.

\subsubsection {\mylabel{POLKA_HSEARCH}\emph{Search for...}}
This entry allows the hyper-text help information to be searched for any
given keyword. A dialog box is created, and the user enters the word to
be searched for into the \emph{Search for:} box. If the \emph{Exact
search?} button is checked, then case is significant and only whole words
matching the supplied string are found. Otherwise, case is insignificant
and sub-strings within words will be matched as well as whole words.

The results of the search are displayed in a hyper-text browser, as a
series of links to the sections of the document containing the matches.
Any section headings containing a match are displayed first, followed by
the headings of any other sections containing a match within the body of
the section (the facilities of the hyper-text browser may be used to
locate the string within the section).

\subsection {\mylabel{POLKA_IMAGE_DISPLAY}The Image Display Area}
The current image is displayed in a square area to the right of the
screen using a monochrome colour table. Various aspects of the display
such as the image scale, the data values corresponding to black and
white, the pixel coordinates at the centre of the display, etc, can be
adjusted using the controls in the \htmlref{\emph{Display
Controls}}{POLKA_DISPLAY_CONTROLS} box, to the left of the image
display. If the \htmlref{\emph{Effects}}{POLKA_EFFECTS_MENU} menu has
been used to apply any special effects to the current image (as selected
using the \htmlref{\emph{Images}}{POLPACK_IMAGES_MENU} menu), then the
results of applying these effects to the supplied image will be
displayed. Otherwise, the supplied image itself will be displayed.

The user can interact with the image in various ways using the mouse. The
details of these interactions depend on the current state of the other
controls, and fall into five different ``modes''. A description of the
current mode is displayed above the image, and the dynamic help
information shown in the \htmlref{\emph{Help Area}}{POLKA_HELP_AREA}
describe the interactions available in the current mode. The available
modes are:

\begin{description}

\item [\mylabel{POLKA_MODE_0} Identify features] - This is the default
mode in which the user identifies the image features on which the
inter-image and $OE$ mappings are based. The available interactions in
this mode are:

\begin{itemize}

\item Single click to identify an image feature. \slhyperref{Go here}{See
section }{}{POLKA_IDENTIFYING_FEATURES} for instructions on identifying
image features.

\item Click and drag to select an area of the image. \slhyperref{Go here}{See
section }{}{POLKA_AREA_SELECTION} for instructions on selecting areas.

\end{itemize}

\item [\mylabel{POLKA_MODE_1} Edit or create a polygon] - In this mode
the user either modifies an existing mask polygon or creates a new
polygon. It is entered when either the \emph{$O$-ray mask} or \emph{$E$-ray
mask} button in the box labelled ``\htmlref{\emph{Current:}}{POLKA_CURRENT}'' is selected. The available interactions in
this mode are:

\begin{itemize}

\item To move a vertex of an existing polygon, position the pointer over
the vertex, press and hold the left mouse button, and then move the
pointer. The vertex and connecting edges will be moved with the pointer
until the mouse button is released.

\item To add another vertex to an existing polygon, position the pointer
over the edge where the new vertex is required, and click the left mouse
button.

\item To commence the definition of a new polygon, position the pointer
away from any existing vertices or edges, and click the left mouse button.
The first vertex of the new polygon will be placed at the selected
position, and the display area will then enter ``\htmlref{Complete a
Polygon}{POLKA_MODE_2}'' mode.

\item Click anywhere else and drag to select an area. \slhyperref{Go here}{See
section }{}{POLKA_AREA_SELECTION} for instructions on selecting areas.

\end{itemize}

\item [\mylabel{POLKA_MODE_2} Complete a polygon] - In this mode, the
user completes the definition of a polygon started in ``\htmlref{Edit or
create a polygon}{POLKA_MODE_1}'' mode. Adjacent vertices around the
polygon are supplied by positioning the pointer and clicking the left
mouse button. The polygon is closed when a vertex is given close to the
first vertex, and the display area then reverts to ``\htmlref{Edit or
create a polygon}{POLKA_MODE_1}'' mode. The available interactions in
this mode are:

\begin{itemize}
\item Click on the first vertex to close the polygon.
\item Click anywhere else to add another vertex to the polygon.
\item Click anywhere else and drag to select an area. \slhyperref{Go here}{See
section }{}{POLKA_AREA_SELECTION} for instructions on selecting areas.
\end{itemize}

\item [\mylabel{POLKA_MODE_3} Select a feature label] - This mode is
entered when the \htmlref{\emph{Select feature label}}{POLKA_GET_LABEL}
dialog box is displayed. This usually happens after each image feature is
identified in ``\htmlref{Identify features}{POLKA_MODE_0}'' mode. The
exception to this is when there are no features currently defined in any
image other than the displayed image, in which case new labels are
automatically assigned (starting at ``1''), and the \emph{Select feature
label} dialog box is not used. The purpose of this mode is to select the
label to be assigned to the new image feature. To do this you should
position the pointer over an existing feature marker. The label
associated with that marker is then displayed in the \htmlref{status
area}{POLKA_STATUS_AREA}, and becomes the currently selected entry in
the list of labels within the \emph{Select feature label} dialog box.
Clicking the left mouse button then causes the currently selected label
to be assigned to the new image feature. The display area then reverts to
``\htmlref{Identify features}{POLKA_MODE_0}'' mode.
The available interactions in this mode are:

\begin{itemize}
\item Position pointer over a feature to highlight the corresponding label
in the list box.
\item Click on a feature to close the dialog box and use the feature's label.
\end{itemize}

\item [\mylabel{POLKA_MODE_4} Identify a new centre] - This mode is
entered when the \htmlref{\emph{Centre}}{POLKA_CENTRE} button is pressed.
The cursor changes to a circle to indicate the change of mode. The cursor
should then be positioned over the image, and the left mouse button
pressed. The image will then be re-displayed with the same scale factor,
but with the selected image position in the centre of the display window.

The available interactions in this mode are:
\begin{itemize}
\item Click to re-display the image centred on the pointer position.
\end{itemize}

\end{description}

\subsection {\mylabel{POLKA_DISPLAY_CONTROLS}The \emph{Display Controls} Box}
This box is situated to the left of the \htmlref{image display
area}{POLKA_IMAGE_DISPLAY} and contains controls related to the image
display.

\subsubsection {\mylabel{POLKA_ZOOM}The \emph{Zoom} Button}
This button is enabled when an area of the image is selected by clicking
and dragging over the image. Pressing the \emph{Zoom} button will then
result in the selected area of the image being re-displayed so that it
fills the display window in at least one dimension. The button will then
be disabled until another image area is selected. Several zoom operations
may be applied in sequence, and may be undone in reverse sequence by
repeated use of the \htmlref{\emph{Unzoom}}{POLKA_UNZOOM} button.

\subsubsection {\mylabel{POLKA_UNZOOM}The \emph{Unzoom} Button}
This button is enabled when one or more zoom or centre operations have
been applied to the image. Single clicking on this button will undo the
most recent zoom or centre operation, and double clicking will undo
all zoom and centre operations.

\subsubsection {\mylabel{POLKA_CENTRE}The \emph{Centre} Button}
This button is used to re-display the current image putting a specified
position at the centre of the display window. When the button is pressed
the pointer or cross-hair will change to a circle within the image display
area. Position this circular cursor at the position which is to be
located at the centre of the display window, and press the left mouse
button. The image will be re-displayed, and the circular cursor will
revert to its previous form.

\subsubsection {\mylabel{POLKA_DELETE}The \emph{Delete} Button}
This button is used to delete image features or mask vertices. First
select an area by clicking and dragging over the image, and then press
the \emph{Delete} button. Any ``\htmlref{\emph{Current:}}{POLKA_CURRENT}''
image features or mask vertices within the box will be deleted.
Note, any ``\htmlref{\emph{Reference:}}{POLKA_REFERENCE}'' features within
the selected area will \textbf{not} be deleted.

This button is functionally equivalent to the \htmlref{\emph{Delete}}{POLKA_DELETE_FEATURES} item in the \htmlref{\emph{Edit}}{POLKA_EDIT_MENU} menu.

\subsubsection {\mylabel{POLKA_CANCEL}The \emph{Cancel} Button}
Pressing this button will cancel the most recent operation on the display
in the following order:

\begin{itemize}
\item If the \htmlref{\emph{Centre}}{POLKA_CENTRE} button has been
pressed, then the re-centring operation will be canceled.

\item Otherwise, if an area has been selected by clicking and dragging
over the image, then the area selection is canceled.

\item Otherwise, if the user is in the process of
\htmlref{supplying a mask polygon}{POLKA_MODE_2} then the incomplete
polygon is deleted, and the interaction mode within the display window
reverts to ``\htmlref{Edit or create a polygon}{POLKA_MODE_1}''.
\end{itemize}

\subsubsection {\mylabel{POLKA_NOT_WHITE}The \emph{\% not white} Button}
This control specifies the percentage of the pixels within the displayed
part of the image which should be shown as black or grey. Thus, the
difference between $100.0$ and the displayed figure gives the percentage
of the image pixels which are shown as pure white. To enter a new value,
position the pointer over the entry box and type the new value.
Alternatively, the ``up'' and ``down'' arrows at either end of the data
entry box can be pressed, in which case the displayed value will
automatically be incremented or decremented until the arrow is released.
If the RETURN key on the keyboard is pressed while the pointer is
over the data entry box, then the image will be re-displayed immediately
with the new value. Otherwise, the image will be re-displayed 2.5 seconds
after the value has changed (unless a new value is entered for the \emph{\% not white} or \htmlref{\emph{\% black}}{POLKA_BLACK} control in
the mean-time). This delay allows a new value to be entered in the \emph{\% black} control before the image is re-displayed.

The current value of this control is saved along with the current options
values when the \htmlref{\emph{Save Options}}{POLKA_SAVE_OPTIONS} item in
the \htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu is selected.

\subsubsection {\mylabel{POLKA_BLACK}The \emph{\% black} Button}
This control specifies the percentage of the pixels within the displayed
part of the image which should be shown as pure black. To enter a new value,
position the pointer over the entry box and type the new value.
Alternatively, the ``up'' and ``down'' arrows at either end of the data
entry box can be pressed, in which case the displayed value will
automatically be incremented or decremented until the arrow is released.
If the RETURN key on the keyboard is pressed while the pointer is
over the data entry box, then the image will be re-displayed immediately
with the new value. Otherwise, the image will be re-displayed 2.5 seconds
after the value has changed (unless a new value is entered for the \emph{\% not white} or \htmlref{\emph{\% black}}{POLKA_BLACK} control in
the mean-time). This delay allows a new value to be entered in the \emph{\% not white} control before the image is re-displayed.

The current value of this control is saved along with the current options
values when the \htmlref{\emph{Save Options}}{POLKA_SAVE_OPTIONS} item in
the \htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu is selected.

\subsubsection {\mylabel{POLKA_LOCK_SCALING}The \emph{Lock Scaling} Button}
The pixel values shown as pure black and pure white in the displayed
image are specified indirectly as percentage points in the histogram of
displayed pixel values (see the \htmlref{\emph{\% not
white}}{POLKA_WHITE} and \htmlref{\emph{\% black}}{POLKA_BLACK}
controls). This means that the grey scale will, in general, change when a
different section of the image is displayed (for instance, when using the
\htmlref{\emph{Zoom}}{POLKA_ZOOM} button). To prevent this happening, the
\emph{Lock Scaling} button can be selected. The current data values
implied by the \htmlref{\emph{\% not white}}{POLKA_WHITE} and
\htmlref{\emph{\% black}}{POLKA_BLACK} values will then be used
directly for all subsequent image displays until the \emph{Lock Scaling}
button is de-selected. Any changes made to the \htmlref{\emph{\% not
white}}{POLKA_WHITE} and \htmlref{\emph{\% black}}{POLKA_BLACK}
values will be ignored until the \emph{Lock Scaling} button is
de-selected.

\subsection {\mylabel{POLKA_CURRENT}The ``\emph{Current:}'' Box}
The buttons in this box select the objects which the user is currently
entering in the \htmlref{image display area}{POLKA_IMAGE_DISPLAY}:

\begin{description}
\item [$O$-ray features] - These are point-like features within the
$O$-ray areas of the input image. They are used to derive the mappings
needed to align the output images.
\item [$E$-ray features] - These are point-like features within the
$E$-ray areas of the input image. These are also used to derive the mappings
needed to align the output images.
\item [$O$-ray mask] - This consists of one or more closed polygonal curves
containing all the $O$-ray areas in the input image.
\item [$E$-ray mask] - One or more closed polygonal curves
containing all the $E$-ray areas in the input image.
\item [$O$-ray sky area] - This consists of one or more closed polygonal curves
containing the regions within the $O$-ray area in which the sky
background is to be estimated. This button will be disabled if
separate sky frames were supplied when POLKA was run, or if the
\htmlref{\emph{Remove Sky}}{POLKA_REMOVE_SKY} entry in the \htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu is not selected.
\item [$E$-ray sky area] - The $E$-ray sky areas - equivalent to the
\emph{O-ray sky} button.
\end{description}

\subsection {\mylabel{POLKA_REFERENCE}The ``\emph{Reference:}'' Box}
The controls in this box control the display of ``reference objects''
within the \htmlref{image display area}{POLKA_IMAGE_DISPLAY}. These
objects cannot be modified, and are intended only to facilitate the location
and labelling of the current objects selected in the box labelled
``\htmlref{\emph{Current:}}{POLKA_CURRENT}''. Reference objects are
shown in a different colour, and use a different marker to the current
objects.

The top seven buttons have the following effects:

\begin{description}

\item [$O$-ray features] - Causes the $O$-ray features from the image
selected using the \htmlref{\emph{Ref. Image}}{POLKA_REF_IMAGE} menu to
be displayed as reference objects.

\item [$E$-ray features] - Causes the $E$-ray features from the image
selected using the \htmlref{\emph{Ref. Image}}{POLKA_REF_IMAGE} menu to
be displayed as reference objects.

\item [$O$-ray mask] - Causes the $O$-ray mask from the image
selected using the \htmlref{\emph{Ref. Image}}{POLKA_REF_IMAGE} menu to
be displayed as reference object.

\item [$E$-ray mask] - Causes the $E$-ray mask from the image
selected using the \htmlref{\emph{Ref. Image}}{POLKA_REF_IMAGE} menu to
be displayed as reference object.

\item [$O$-ray sky area] - Causes the $O$-ray sky areas from the image
selected using the \htmlref{\emph{Ref. Image}}{POLKA_REF_IMAGE} menu to
be displayed as reference object.

\item [$E$-ray sky area] - Causes the $E$-ray sky areas from the image
selected using the \htmlref{\emph{Ref. Image}}{POLKA_REF_IMAGE} menu to
be displayed as reference object.

\item [None] - Causes no reference objects to be displayed.

\end{description}

Note, the ``\emph{current}'' objects cannot also be used as ``\emph{reference}'' objects, and one of the above buttons will in general be
disabled to prevent this from happening. If the current reference objects are
selected in the ``\htmlref{\emph{Current:}}{POLKA_CURRENT}'' box, then the
reference objects will automatically revert to \emph{None}.

\subsubsection {\mylabel{POLKA_DRAW_ALIGNED}The \emph{Draw Aligned} Button}
If this button is pressed, then the reference objects will be temporarily
mapped into the co-ordinate frame of the current objects (selected within
the ``\htmlref{\emph{Current:}}{POLKA_CURRENT}'' box). This provides a
way of checking the current mappings, but will not be possible if the
image features required to determine the mappings have not yet been
supplied. In this case, a warning message will be displayed and the \emph{Draw Aligned} button will be automatically de-selected. The reference
features will then be drawn in their own co-ordinate frame.

Note, if any image features are added or deleted, the mappings implied by
the these features may change. However, the reference features will not
automatically be re-drawn if this happens. Instead, the \htmlref{\emph{Re-draw}}{POLKA_REDRAW} button should be used to re-estimate the
mappings and re-draw the reference features.

\subsubsection {\mylabel{POLKA_REDRAW}The \emph{Re-draw} Button}
This button is only enabled if the \htmlref{\emph{Draw
Aligned}}{POLKA_DRAW_ALIGNED} button is currently selected. If it is
pressed, the mappings will be re-estimated and the reference objects will
be re-drawn using the new mappings. This button should be pressed after
adding or deleting image features which may have changed the current
mappings.

\subsubsection {\mylabel{POLKA_REF_IMAGE}The \emph{Ref. Image} Button}
This button displays a menu of the supplied input images. The selected
image becomes the source of the reference objects selected by the other
controls in the ``\emph{Reference}'' box.

\subsubsection {\mylabel{POLKA_ACCEPT}The \emph{Accept} Button}
Pressing this button causes an image feature to be identified for each
of the displayed reference features. For each reference position, a search
is made for a corresponding image feature, taking the displayed position of the
reference feature as the initial guess. This is equivalent to the user
positioning the pointer over each reference feature in turn and pressing
the left hand mouse button. The label for each new image feature is
inherited from the reference feature.

This button is disabled unless both current and reference object type
are $O$ or $E$ ray features.

\subsection {\mylabel{POLKA_STATUS_AREA}The Status Area}
This is a horizontal strip underneath the displayed image and is used to
display various items of information about the current state of the
program. The exact contents of this area can be customised using the
\htmlref{\emph{Status Items}}{POLKA_STATUS_ITEMS} entry in the
\htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu. It can also be removed
entirely from the GUI by de-selecting the \htmlref{\emph{Display Status
Area}}{POLKA_DISPLAY_STATUS_AREA} button in the \htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu.

\subsection {\mylabel{POLKA_HELP_AREA}The Help Area}
This is an area at the bottom of the GUI in which is displayed brief help
information on the control currently under the pointer. It is updated
dynamically as the pointer is moved around the GUI. More detailed help
can be obtained using the \htmlref{\emph{Help}}{POLKA_HELP_MENU} menu.
This area can be removed entirely from the GUI by de-selecting the
\htmlref{\emph{Display Help Area}}{POLKA_DISPLAY_HELP_AREA} button in the
\htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu.

\subsection {\mylabel{POLKA_GET_LABEL_DIALOG}The \emph{Select feature label} Dialog Box}
This dialog box appears when an image feature has been identified by
clicking over the \htmlref{image display area}{POLKA_IMAGE_DISPLAY}. It
is used to assign a numerical label to the feature so that corresponding
features in different images and rays can be identified. A specific object
on the sky should be assigned the same label in all images and rays.
Failure to do this will result in the mappings being inaccurate.

The dialog box does not appear if there are currently no image features
identified in any image other than the displayed image. In this case a
new label is automatically assigned to the feature.

The dialog box contains a list of all the labels currently in use. To
select a label, click on its entry in the list and then press the \emph{OK} button (or just double-click on its entry in the list). An
alternative way to select a feature label is to position the pointer over
the feature's reference marker in the \htmlref{image display
area}{POLKA_IMAGE_DISPLAY} and click the left mouse button. As the
pointer is moved over features in the image, the corresponding label
is always highlighted in the list in the dialog box, and shown in the
\htmlref{status area}{POLKA_STATUS_AREA}.

Pressing the \emph{New} button will assign a new (i.e. previously unused)
label to the image feature.

Pressing the \emph{Cancel} button will close the dialog box and delete the
candidate image feature.

Pressing the \emph{Help} button displays this information in a hyper-text
browser.

\subsection {\mylabel{POLKA_EDIT_MAPPING_DIALOG}The \emph{Edit a mapping}
Dialog Box}
This dialog box is displayed when the \htmlref{\emph{Mappings}}
{POLKA_EDIT_MAPPINGS} entry in the \htmlref{\emph{Edit}}{POLKA_EDIT_MENU}
menu is selected. It allows the user to examine and edit the current
mappings associated with an image. The specific mapping being examined is
described at the top of the dialog box. This may be an ``image mapping''
which maps pixel coordinates from the frame of the selected input image
to the frame of the first input image, or an ``$OE$ mapping'' which maps
positions in the $E$-ray picture to the corresponding positions in the
$O$-ray picture. The image mapping associated with the selected image is
shown by default. To examine the $OE$ mapping, click on the \emph{OEmap}
button at the bottom left of the dialog box.

The mapping is described in two ways:

\begin{itemize}
\item In terms of the rotation, magnification and shift produced
by the mapping on each axis. The original pixel co-ordinate frame
is first rotated about its origin (the displayed rotations are measured
clockwise, in degrees). Each axis is then magnified, and finally the
origin is shifted.

\item In terms of linear equations connecting the mapped pixel
coordinates to the original pixel coordinates.
\end{itemize}

The two descriptions are shown in two separate panels, each consisting of
six numerical values with associated labels. The displayed values will be
blank if the mapping is not currently defined. New values may in general
be entered by positioning the pointer over a value box and typing in the
new value. The other mapping description will then be modified to reflect
these new values. The exception to this is when a value is protected, in
which case the value may not be changed by the user. This occurs if the
\emph{Protect Mapping} button has been pressed (towards the bottom of the
dialog box), or if the current mapping type does not allow the value to
be changed.\footnote{The current mapping type is set using the \htmlref{\emph{Mapping Types}}{POLKA_MAP_TYPES} item in the
\htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu, and is displayed just
below the two mapping description panels in the dialog box.} The values
in the lower panel, which give the co-efficients of the linear equations
describing the mapping, may only be modified if the mapping type is
``Full 6 parameter fit''. For all other mapping types, these values are
protected, and the mapping may only be changed by entering selected
shift, rotation and magnification values in the upper panel, depending on
the mapping type. The specific restrictions imposed by the various
mapping types are:


\begin{description}

\item[Shift of origin only] - Only the \emph{Shift} values can be changed.
The \emph{Rotation} and \emph{Magnification} values are set to 0.0 and 1.0
respectively, and may not be changed.

\item[Shift of origin and rotation] - Both the \emph{Shift} and the X axis \emph{Rotation} values may be changed. The Y axis \emph{Rotation} value is
automatically set to equal the X axis value and may not be changed by the
user. The \emph{Magnification} values are set to 1.0 and may not be changed.

\item[Shift of origin and magnification] - Both the \emph{Shift} and the X
axis \emph{Magnification} values may be changed. The Y axis \emph{Magnification} value is automatically set to equal the X axis value and
may not be changed by the user. The \emph{Rotation} values are set to 0.0 and
may not be changed.

\item[Shift of origin, rotation and magnification] - The  \emph{Shift},
X axis \emph{Magnification} and X axis \emph{Rotation} values may all be set.
The Y axis \emph{Magnification} and \emph{Rotation} are automatically set
to equal the X axis values and may not be changed by the user.

\item[Full 6 parameter fit] - All values may set independently for each
axis by the user.
\end{description}

Either the forward or inverse mapping may be inspected and edited. Use
the buttons just below the mapping type in the dialog box to select the
required direction. By default, the forward mapping is shown. Forward
image mappings go from the selected image, to the first input image.
Forward $OE$ mappings go from the $E$-ray to the $O$-ray.

If the \emph{Protect Mapping} button is selected, then the current mapping
may not be changed until the button is cleared. This prevents the user
form changing the mapping, but it also prevents the mapping from being
changed as a result of the addition or deletion of image features.

At the bottom of the dialog box is a row of buttons with the following
functions:

\begin{description}
\item [\emph{OK}] - Saves the currently displayed mapping values so that
they will be used in future to perform any required mappings.
\item [\emph{Clear}] - Clears all the mapping values so that the mapping
becomes undefined. This button is disabled if the mapping is protected.
\item [\emph{Cancel}] - Restores the original mapping values, and closes
the dialog box.
\item [\emph{Restore}] - Restores the original mapping values, but does not
close the dialog box. This button is disabled if the mapping is protected.
\item [\emph{Help}] - Displays hyper-text help information for the dialog
box.
\item [\emph{OEMap}] - Replaces the current dialog box with another
describing the $OE$ mapping. This button is disabled if the $OE$ mapping
is currently displayed.
\end{description}

\subsection {\mylabel{POLKA_STATUS_ITEMS_DIALOG}The \emph{Select status items} Dialog Box}
This dialog box displays a list of all the available items of information
which can be displayed in the \htmlref{status area}{POLKA_STATUS_AREA}.
Against each is a check-button which will be lit up if the corresponding
item is currently included in the list of items to be displayed. These
check-buttons can be toggled by clicking on them, thus removing or adding
items from the list of items to be displayed. The buttons at the bottom
of the dialog box have the following purposes:

\begin{description}
\item [OK] - Closes the dialog box, and re-displays the status area.
Only those items which were selected when the OK button was pressed are
included in the re-displayed status area.
\item [Apply] - Re-displays the status area, but does not close the
dialog box.
\item [Cancel] - Closes the dialog box, ignoring any changes which have
been made to the display list.
\item [ClearAll] - Clears all the check-buttons (does not close the dialog box).
\item [SetAll] - Sets all the check-buttons (does not close the dialog box).
\item [Help] - Displays this help.
\end{description}

\subsection {\mylabel{POLKA_TRANSFER_DIALOG}The \emph{Transfer features} Dialog Box}
This dialog box may be used to copy image feature positions from one
image to any number of other images, without the need to display each
image. It is assumed that such images are already aligned, (or nearly
aligned).

It displays a list of the images supplied when POLKA was activated, with
a check button against each. The user may select images by pressing the
check buttons, or by using the \emph{Setall} or \emph{ClearAll} buttons at
the bottom of the box. When the \emph{OK} button is pressed, any images
features currently defined for the displayed image (for either the $E$ or
the $O$ ray) are copied to all the selected images, replacing any
existing ones (a confirmation is required before replacing any existing
features). Images which already have features defined for them are
indicated by ticks. The check button for the currently displayed image is
disabled.

Each position within the current image is used as the initial guess for
the position of a feature in each of the selected images. These initial
guesses are refined by finding the centroid of the feature in the
selected image (using the current value of the \htmlref{\emph{Feature
Size}}{POLKA_FEATURE_SIZE} option from the \htmlref{\emph{Options}}
{POLKA_OPTIONS_MENU} menu). Thus, slight mis-alignments (of the order of
the feature size) can be tolerated.

If the features are copied to an image, any masks or sky areas associated
with the image are deleted. New ones will be created when necessary based
on those in the currently displayed image. These default masks may be
edited as usual if necessary.

\section {\mylabel{POLKA_HOW_DO_I}How do I...}
This section provides instructions for performing some common tasks
within the POLKA Graphical User Interface.

\subsection {\mylabel{POLKA_USING_HELP}Use the Help System}
Information on the use and state of the POLKA GUI are available on-line
in various ways:

\begin{itemize}

\item An indication of what is happening, or what the user should
probably be doing, is displayed above the displayed image. This is a very
broad indication, primarily intended to indicate what is going on during
any long pauses (for instance, while the output images are being
created).

\item The \htmlref{status area}{POLKA_STATUS_AREA} situated below
the image display, displays various items of information describing the
current option values, pointer position, feature labels, etc. The
contents of this area can be customised using the \htmlref{\emph{Status
Items}}{POLKA_STATUS_ITEMS} entry in the \htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu.

\item A brief description of the control, or controls, currently under the
pointer is displayed in the \htmlref{help area}{POLKA_HELP_AREA} at the
bottom of the GUI (under the status area). This information is
dynamically updated as the pointer is moved around the screen.

\item More detailed hyper-text help information is also available, and a
separate hyper-text browser will automatically be created to display it
when required. Either $netscape$ or $Mosaic$ can be used by
assigning the name of the required browser to the HTX\_BROWSER
environment variable. If HTX\_BROWSER is not defined, then $netscape$
is used.

This hyper-text help information may be accessed in several ways:

\begin{enumerate}

\item The \htmlref{\emph{Help}}{POLKA_HELP_MENU} menu, situated at the
far right of the menu bar can be used to access various preset points in
the help text.

\item A description of a specific control in the GUI can be obtained by
positioning the pointer over the control, and pressing the F1
button on the keyboard.

\item A description of a specific control may also be obtained by clicking
on the \emph{Pointer...} entry in the \htmlref{\emph{Help}}{POLKA_HELP_MENU} menu, positioning the cursor over the control,
and clicking the left mouse button.

\end{enumerate}

\end{itemize}

\subsection {\mylabel{POLKA_IMAGE_SCALING}Select the Displayed Data Range}
The \htmlref{\emph{\% not white}}{POLKA_WHITE} and \htmlref{\emph{\% black}}
{POLKA_BLACK} controls in the \htmlref{\emph{Display Controls}}
{POLKA_DISPLAY_CONTROLS} box (to the left of the image) can be used to
change the data values corresponding to black and white in the displayed
image. These first specifies the percentages of the displayed pixels
which are to be shown as black, and the second gives the percentages of the
displayed pixels which are to be shown as grey (i.e. anything other than
pure white). For instance, if you give values of 4 and 92 for these, then
4 \% of the displayed pixels will be pure black, and 8 \% (i.e. $100-92$)
will be pure white. The rest will be somewhere in between.

Note, these values give percentages of the \emph{displayed} pixels.
Therefore, changing the pixels included in the display (for instance by
zooming, or changing the centre position) will in general change the data
values corresponding to the specified percentages, resulting in a
different grey-scale. To prevent this happening, the actual data values
used for black and white can be locked at the current values using the
\htmlref{\emph{Lock Scaling}}{POLKA_LOCK_SCALING} button. If this is done,
the \emph{\% black} and \emph{\% not white} widgets have no effect until the
\emph{Lock Scaling} button is released.

\subsection {\mylabel{POLKA_AREA_SELECTION}Select an Area of the Image}
Several operations (such as the \htmlref{\emph{Zoom}}{POLKA_ZOOM} and
\htmlref{\emph{Delete}}{POLKA_DELETE} buttons, and the \htmlref{\emph{Stats}}{POLKA_STATS_EFFECT} effect) expect an area of the displayed image
to be ``selected'' before the operation is used. A selected area is a
rectangular region of the image, chosen by pressing the left mouse button
over the image and then dragging the mouse while holding the button down.
The area is marked by a box (the colour is normally red, but can be
changed using the \htmlref{\emph{Options}}{POLKA_OPTIONS_MENU} menu).

Any operation which uses a selection box will remove it upon completion,
but it may also be removed by pressing the \htmlref{\emph{Cancel}}{POLKA_CANCEL}
button in the \htmlref{\emph{Display Controls}}{POLKA_DISPLAY_CONTROLS} area
(useful if you decide not to proceed with the operation).

An area which extends beyond the edges of the displayed image can be
selected by dragging the pointer outside the display area. The selection
box is not drawn beyond the boundaries of the display, but its full extent
will be used never-the-less.

\subsection {\mylabel{POLKA_BIGGER_IMAGE}Make the Image Display Bigger}
The re-sizing facilities of the window manager cannot be used to change
the size of the image display area. The only way to make the display
bigger is to re-run POLKA, giving a larger value for the
\xref{DPI}{sun223}{POLKA} DPI parameter. Reducing the contents of the
\htmlref{status area}{POLKA_STATUS_AREA} (or even remove it altogether)
can reduce the area occupied by the rest of the GUI, thus making it
possible to use a larger value of DPI.

\subsection {\mylabel{POLKA_IDENTIFYING_FEATURES}Identify Image Features}
To identify a star-like feature within the displayed image, position the
pointer or cross-hair over the feature and click the left button. If
necessary the imaged can be \htmlref{zoomed}{POLKA_ZOOM} first to make the
feature position easier to identify. If the \htmlref{\emph{Feature
Size}}{POLKA_FEATURE_SIZE} has been set to a non-zero value in the
the \htmlref{\emph{Options}} {POLKA_OPTIONS_MENU} menu, then the supplied
feature position will be refined using a centroiding process.

To facilitate identification of image features, the features from another
image (or ray) can be displayed as \htmlref{reference}{POLKA_REFERENCE}
markers.

You will be required to supply a numerical label for the feature unless
no other images yet have any features (in which case a label will be
generated automatically). The simplest way to do this is to click on
the corresponding reference marker. The new feature will then inherit the
label of the reference marker.

\subsection {\mylabel{POLKA_SAME_MASKS}Use the Same Mask for Several Runs}
Create the $O$ and $E$ ray masks for the first (reference) image, and
then use the \htmlref{\emph{Dump}}{POLKA_DUMP}/\emph{Mask Only} and
\htmlref{\emph{Restore}}{POLKA_RESTORE}/\emph{Mask Only} commands in the
\htmlref{\emph{File}}{POLKA_FILE_MENU} menu. \emph{Dump} creates a text file
containing the current $O$ and $E$ ray masks from the first image. This
file can then be restored at the start of each subsequent run of POLKA to
re-establish the $O$ and $E$ ray masks.

\subsection {\mylabel{POLKA_MULTI_RUN}Align Data from Several Runs}
If you want to process your data using POLKA in several batches, you will
need to take care to ensure that the results of each batch are aligned on
the sky. To do this, follow this procedure:

\begin{enumerate}

\item Process the first batch. Give your chosen reference image as the
first input image when specifying parameter IN, and give a null (!) value
for parameter OUT\_S (we will create Stokes vectors later using POLCAL
directly). Once you have identified all the feature positions, masks and
sky areas in the reference image, save them in a file using the
\htmlref{\emph{Dump}} {POLKA_DUMP}/\emph{Displayed Image} command in the
\htmlref{\emph{File}}{POLKA_FILE_MENU} menu. Then carry on to identify the
required features and masks in the other images, and create the
aligned extracted images using the \htmlref{\emph{File}}
{POLKA_FILE_MENU}/\emph{Exit} command as usual.

\item Process each subsequent batch. Assign the name of the reference
image (i.e. the first image used in the first batch) to the POLKA
parameter REFIN, and assign the names of the new images to be processed
to parameter IN. The reference image will be displayed initially when the
Polka GUI is created. Restore the image features, masks and sky areas
from the saved file using the \htmlref{\emph{Restore}}{POLKA_RESTORE}/\emph{Displayed Image} command in the \htmlref{\emph{File}}{POLKA_FILE_MENU}
menu. Then carry on to identify the required features and masks in the
other images, and create the aligned extracted images using the
\htmlref{\emph{File}} {POLKA_FILE_MENU}/\emph{Exit} command as usual. Note,
the reference image will not be processed again, because it was not
specified using the IN parameter.

\item Once all batches have been processed, run POLCAL to create the
Stokes vectors from the aligned extracted files created by each run of
Polka.

\end{enumerate}

\subsection {\mylabel{POLKA_STOP_START}Stop and Re-start POLKA}
Use the \htmlref{\emph{Dump}}{POLKA_DUMP}/\emph{Everything} and
\htmlref{\emph{Restore}}{POLKA_RESTORE}/\emph{Everything} commands in the
\htmlref{\emph{File}}{POLKA_FILE_MENU} menu. \emph{Dump} creates a text file
containing all the features positions, masks, mappings, etc, which you
have supplied so far. After using \emph{Dump}, you can use \htmlref{\emph{Quit}}{POLKA_QUIT} to terminate execution of POLKA without creating the
output images. You can then re-start POLKA later, and use \emph{Restore}
to read the text file created by \emph{Dump}. This puts POLKA into the
state it was in when the dump file was created.

\subsection {\mylabel{POLKA_PREALIGNED_IMAGES}Use pre-aligned images}
If your images are already in alignment (or nearly in alignment), then
you do not need to identify feature positions, masks, etc, for every image.
Instead, just identify features and masks within one of the images and then
use the \emph{Transfer} command in the \htmlref{\emph{Images}}{POLKA_IMAGES_MENU}
menu to transfer them to the other images.

\subsection {\mylabel{POLKA_EDITING_POLYGONS}Edit polygons}
Polygons are displayed when one of the \emph{mask} or \emph{sky
area} buttons is selected in the ``\htmlref{\emph{Current:}}{POLKA_CURRENT}''
box). Completed polygons may be edited in any of the following ways:

\begin{itemize}

\item To move a single vertex, position the pointer over the vertex (the
cursor changes to a pointing hand), press and hold the left mouse button,
and then move the pointer. The vertex and connecting edges will be moved
with the pointer until the mouse button is released.

\item To move an entire polygon retaining its shape, position the pointer
over any vertex, press and hold the left mouse button together with the
SHIFT key on the keyboard, and then move the pointer. The polygon will be
moved with the pointer until the mouse button is released.

\item To add another vertex to an existing polygon, position the pointer
over the edge where the new vertex is required (the cursor changes to a
pencil), and click the left mouse button.

\item To commence the definition of a new polygon, position the pointer
away from any existing vertices or edges, and click the left mouse button.
The first vertex of the new polygon will be placed at the selected
position, and the display area will then enter ``\htmlref{Complete a
Polygon}{POLKA_MODE_2}'' mode.

\end{itemize}

\end{document}
