\documentstyle[twoside,11pt]{article}
\pagestyle{myheadings}

% -----------------------------------------------------------------------------
% ? Document identification
\newcommand{\stardoccategory}  {Starlink User Note}
\newcommand{\stardocinitials}  {SUN}
\newcommand{\stardocsource}    {sun\stardocnumber}
\newcommand{\stardocnumber}    {109.9}
\newcommand{\stardocauthors}   {Peter W. Draper and Nicholas Eaton}
\newcommand{\stardocdate}      {8 April 1998}
\newcommand{\stardoctitle}     { {\Huge PISA} \\ [2.5ex]
                      {\huge Position Intensity and Shape Analysis}}
\newcommand{\stardocversion}   {2.4-1}
\newcommand{\stardocmanual}    {[manual-type]}
\newcommand{\stardocabstract}  {[Text of abstract]}
% ? End of document identification

% -----------------------------------------------------------------------------

\newcommand{\stardocname}{\stardocinitials /\stardocnumber}
\markright{\stardocname}
\setlength{\textwidth}{160mm}
\setlength{\textheight}{230mm}
\setlength{\topmargin}{-2mm}
\setlength{\oddsidemargin}{0mm}
\setlength{\evensidemargin}{0mm}
\setlength{\parindent}{0mm}
\setlength{\parskip}{\medskipamount}
\setlength{\unitlength}{1mm}

% -----------------------------------------------------------------------------
%  Hypertext definitions.
%  ======================
%  These are used by the LaTeX2HTML translator in conjunction with star2html.

%  Comment.sty: version 2.0, 19 June 1992
%  Selectively in/exclude pieces of text.
%
%  Author
%    Victor Eijkhout                                      <eijkhout@cs.utk.edu>
%    Department of Computer Science
%    University Tennessee at Knoxville
%    104 Ayres Hall
%    Knoxville, TN 37996
%    USA

%  Do not remove the %\begin{rawtex} and %\end{rawtex} lines (used by
%  star2html to signify raw TeX that latex2html cannot process).
%\begin{rawtex}
\makeatletter
\def\makeinnocent#1{\catcode`#1=12 }
\def\csarg#1#2{\expandafter#1\csname#2\endcsname}

\def\ThrowAwayComment#1{\begingroup
    \def\CurrentComment{#1}%
    \let\do\makeinnocent \dospecials
    \makeinnocent\^^L% and whatever other special cases
    \endlinechar`\^^M \catcode`\^^M=12 \xComment}
{\catcode`\^^M=12 \endlinechar=-1 %
 \gdef\xComment#1^^M{\def\test{#1}
      \csarg\ifx{PlainEnd\CurrentComment Test}\test
          \let\html@next\endgroup
      \else \csarg\ifx{LaLaEnd\CurrentComment Test}\test
            \edef\html@next{\endgroup\noexpand\end{\CurrentComment}}
      \else \let\html@next\xComment
      \fi \fi \html@next}
}
\makeatother

\def\includecomment
 #1{\expandafter\def\csname#1\endcsname{}%
    \expandafter\def\csname end#1\endcsname{}}
\def\excludecomment
 #1{\expandafter\def\csname#1\endcsname{\ThrowAwayComment{#1}}%
    {\escapechar=-1\relax
     \csarg\xdef{PlainEnd#1Test}{\string\\end#1}%
     \csarg\xdef{LaLaEnd#1Test}{\string\\end\string\{#1\string\}}%
    }}

%  Define environments that ignore their contents.
\excludecomment{comment}
\excludecomment{rawhtml}
\excludecomment{htmlonly}
%\end{rawtex}

%  Hypertext commands etc. This is a condensed version of the html.sty
%  file supplied with LaTeX2HTML by: Nikos Drakos <nikos@cbl.leeds.ac.uk> &
%  Jelle van Zeijl <jvzeijl@isou17.estec.esa.nl>. The LaTeX2HTML documentation
%  should be consulted about all commands (and the environments defined above)
%  except \xref and \xlabel which are Starlink specific.

\newcommand{\htmladdnormallinkfoot}[2]{#1\footnote{#2}}
\newcommand{\htmladdnormallink}[2]{#1}
\newcommand{\htmladdimg}[1]{}
\newenvironment{latexonly}{}{}
\newcommand{\hyperref}[4]{#2\ref{#4}#3}
\newcommand{\htmlref}[2]{#1}
\newcommand{\htmlimage}[1]{}
\newcommand{\htmladdtonavigation}[1]{}

%  Starlink cross-references and labels.
\newcommand{\xref}[3]{#1}
\newcommand{\xlabel}[1]{}

%  LaTeX2HTML symbol.
\newcommand{\latextohtml}{{\bf LaTeX}{2}{\tt{HTML}}}

%  Define command to re-centre underscore for Latex and leave as normal
%  for HTML (severe problems with \_ in tabbing environments and \_\_
%  generally otherwise).
\newcommand{\latex}[1]{#1}
\newcommand{\setunderscore}{\renewcommand{\_}{{\tt\symbol{95}}}}
\latex{\setunderscore}

%  Redefine the \tableofcontents command. This procrastination is necessary
%  to stop the automatic creation of a second table of contents page
%  by latex2html.
\newcommand{\latexonlytoc}[0]{\tableofcontents}

% -----------------------------------------------------------------------------
%  Debugging.
%  =========
%  Remove % on the following to debug links in the HTML version using Latex.

% \newcommand{\hotlink}[2]{\fbox{\begin{tabular}[t]{@{}c@{}}#1\\\hline{\footnotesize #2}\end{tabular}}}
% \renewcommand{\htmladdnormallinkfoot}[2]{\hotlink{#1}{#2}}
% \renewcommand{\htmladdnormallink}[2]{\hotlink{#1}{#2}}
% \renewcommand{\hyperref}[4]{\hotlink{#1}{\S\ref{#4}}}
% \renewcommand{\htmlref}[2]{\hotlink{#1}{\S\ref{#2}}}
% \renewcommand{\xref}[3]{\hotlink{#1}{#2 -- #3}}
% -----------------------------------------------------------------------------
% ? Document specific \newcommand or \newenvironment commands.

% Internal cross-reference to labels.
\newcommand{\iref} [1]{\htmlref{#1}{#1}}
\newcommand{\iiref}[2]{\htmlref{#1}{#2}}

% ? End of document specific commands
% -----------------------------------------------------------------------------
%  Title Page.
%  ===========
\renewcommand{\thepage}{\roman{page}}
\begin{document}
\thispagestyle{empty}

%  Latex document header.
%  ======================
\begin{latexonly}
   CCLRC / {\sc Rutherford Appleton Laboratory} \hfill {\bf \stardocname}\\
   {\large Particle Physics \& Astronomy Research Council}\\
   {\large Starlink Project\\}
   {\large \stardoccategory\ \stardocnumber}
   \begin{flushright}
   \stardocauthors\\
   \stardocdate
   \end{flushright}
   \vspace{-4mm}
   \rule{\textwidth}{0.5mm}
   \vspace{5mm}
   \begin{center}
   {\Large\bf  \stardoctitle \\ [2.5ex]}
   \end{center}
   \vspace{5mm}

% ? Heading for abstract if used.
%   \vspace{10mm}
%   \begin{center}
%      {\Large\bf Abstract}
%   \end{center}
% ? End of heading for abstract.

% Include a PISAPLOT picture to show what the packages is about.
% The postscript file sun109fig.ps is an encapsulated output from
% PISAPLOT which is produced with the following commands
%
% PISAFIND $PISA_DIR/frame(80:210,115:260) reset accept
%
% PISAPLOT device=pscript_p pltitl="\fr Objects located by PISAFIND" -
%          abslab="\fr X position (pixels)" -
%          ordlab="\fr Y position (pixels)" thick=2 annoscale=2.5.
%
% it will be necessary to scale the output in some fashion to a
% width of around 5 inches. This may be performed using an AGI picture.
%
   \setlength{\unitlength}{1in}
   \begin{center}
      \begin {picture}(5,5)
         \put(0,0){\special{psfile=sun109fig.ps}}
      \end {picture}
   \end{center}
\end{latexonly}

%  HTML documentation header.
%  ==========================
\begin{htmlonly}
   \xlabel{}
   \begin{rawhtml} <H1> \end{rawhtml}
      \stardoctitle
   \begin{rawhtml} </H1> \end{rawhtml}

% ? Add picture here if required.
   \htmladdimg{main.gif}
% ? End of picture

   \begin{rawhtml} <P> <I> \end{rawhtml}
   \stardoccategory \stardocnumber \\
   \stardocauthors \\
   \stardocdate
   \begin{rawhtml} </I> </P> <H3> \end{rawhtml}
      \htmladdnormallink{CCLRC}{http://www.cclrc.ac.uk} /
      \htmladdnormallink{Rutherford Appleton Laboratory}
                        {http://www.cclrc.ac.uk/ral} \\
      \htmladdnormallink{Particle Physics \& Astronomy Research Council}
                        {http://www.pparc.ac.uk} \\
   \begin{rawhtml} </H3> <H2> \end{rawhtml}
      \htmladdnormallink{Starlink Project}{http://star-www.rl.ac.uk/}
   \begin{rawhtml} </H2> \end{rawhtml}
   \htmladdnormallink{\htmladdimg{source.gif} Retrieve hardcopy}
      {http://star-www.rl.ac.uk/cgi-bin/hcserver?\stardocsource}\\

%  HTML document table of contents.
%  ================================
%  Add table of contents header and a navigation button to return to this
%  point in the document (this should always go before the abstract \section).
  \label{stardoccontents}
  \begin{rawhtml}
    <HR>
    <H2>Contents</H2>
  \end{rawhtml}
  \renewcommand{\latexonlytoc}[0]{}
  \htmladdtonavigation{\htmlref{\htmladdimg{contents_motif.gif}}
        {stardoccontents}}

% ? New section for abstract if used.
%  \section{\xlabel{abstract}Abstract}
% ? End of new section for abstract
\end{htmlonly}

% -----------------------------------------------------------------------------
% ? Document Abstract. (if used)
%  ==================
%\stardocabstract
% ? End of document abstract
% -----------------------------------------------------------------------------
% ? Latex document Table of Contents (if used).
%  ===========================================
 \newpage
 \begin{latexonly}
   \setlength{\parskip}{0mm}
   \latexonlytoc
   \setlength{\parskip}{\medskipamount}
   \markright{\stardocname}
 \end{latexonly}
% ? End of Latex document table of contents
% -----------------------------------------------------------------------------
\newpage
\renewcommand{\thepage}{\arabic{page}}
\setcounter{page}{1}

\section{Introduction}

The acronym PISA stands for Position, Intensity and Shape Analysis, and
is the group name for a package of routines that deal with the location
and parameterisation of objects on an image frame.

The core of this package is the routine \iref{PISAFIND} which performs
image analysis on a 2-dimensional data frame. The program searches the
data array for objects that have a minimum number of connected pixels
above a given threshold and extracts the image parameters (position,
intensity, shape) for each object. The image parameters can be
determined using thresholding techniques or an analytical stellar
profile can be used to fit the objects. In crowded regions deblending
of overlapping sources can be performed.

\iref{PISAFIND} is based on the APM IMAGES routine. The algorithms are
the same as in IMAGES but the interface has been adapted to
\htmladdnormallink{Starlink}{http://star-www.rl.ac.uk}, so that for
instance the input data is now expected to be an NDF (see
\xref{[1]}{sg4}{} which also describes other features of the Starlink
Software Environment).  The APM object finding and analysis package
IMAGES was originally written by Mike Irwin at the University of
Cambridge to analyse output from the Automated Photographic Measuring
system. The background to the APM image analysis package is given in
\iref{[2]}.

In addition to its object detection capability PISA can also perform
simple object classification. The classification is performed by the
simple thresholding of an additionally generated `peakedness' measure,
or by the multivariate analysis of a set of intensity corrected
variables.

\begin{htmlonly}
{\em Snapshots of a
\htmladdnormallink{demonstration}{pisa_demo.html}
of PISA are available. You can also run this
\htmlref{interactively}{pisa_demo}.}
\end{htmlonly}


\section{Classified listing of routines}

The package routines (other than \iref{PISAFIND}) are:
\begin{description}

\item [\iref{PISAPLOT}] plots the results of \iref{PISAFIND} as a
series of ellipses on a graphics device, it allows the ellipses to be
overlaid onto displayed images.

\item [\iref{PISAFIT}] fits the PISA analytic stellar profile to a list of
objects.

\item [\iref{PISAGEN}] generates analytic objects and places them in an NDF
data array.

\item [\iref{PISAPEAK}] modifies the \iref{PISAFIND} parameterisations so as to
produce variables which are nearly intensity independent. The variables
are further modified so that they have values in proportion to those of
an equivalent stellar profile.

\item [\iref{PISAKNN}] performs non-parametric (distribution free)
multivariate discriminant analysis on the results from \iref{PISAPEAK}.

\item [\iref{PISACUT}] is a utility routine for separating any file
into two given a threshold value for a particular variable.

\item [\iref{PISAMATCH}] is a utility program for matching indices between
files. It included primarily to match classification indices
against the \iref{PISAFIND} parameterisations.

\item [\iref{PISA2CAT}] converts any of the PISA results files into
catalogues that can be used by the CURSA[5] or CATPAC[8] application
packages.

\item [\iref{PISA2ARD}] converts the results file from the
\iref{PISAFIND} routine into an \xref{ARD}{sun183}{} description of
(possibly scaled) ellipses -- one for each detected object.

\item [\iref{PISAGREY}] plots an NDF data array as a greyscale.
\end{description}

\section{Running the PISA software}

PISA is available as part of the
\htmladdnormallink{Starlink Software Collection}{http://star-www.rl.ac.uk}
and can be used from \xref{ICL}{sg5}{} and the C-shell. The package is always
initialised by the command
\begin{verbatim}
   # pisa
\end{verbatim}

after performing the required Starlink initialisations. Note that in this
document the \verb+#+ sign is used as a generic prompt and should not be typed.

When using PISA from the C-shell care needs to be taken with special
characters, some of which may be required by the parameter system. In
these cases (such as quoted strings \verb+""+, and vector braces
\verb+[]+) the characters must be protected from interpretation by the
use of the escape character \verb+\+ or by use of single quotes.

\subsection{Getting Help}

On-line help is available using the
\begin{verbatim}
   # pisahelp
\end{verbatim}
command from the C-shell. From \xref{ICL}{sg5}{} use the command
\begin{verbatim}
   ICL> help pisa
\end{verbatim}
Help can also be obtained at any prompt by specifying ? or ??. Program
execution can be halted at a prompt by returning the abort command (!!).

\begin{latexonly}
As an alternative to these approaches this document can be viewed
on-line using a hypertext browser (such as
\htmladdnormallink{NCSA Mosaic}
{http://www.ncsa.uiuc.edu/SDG/Software/Mosaic/Docs/help-about.html}
or
\htmladdnormallink{the Netscape Navigator}{http://home.netscape.com/}
) using the command
\begin{verbatim}
   # pisawww [browser]
\end{verbatim}
where \verb+[browser]+ is optional and is the command used to start
a browser, \verb+Mosaic+ is the default.
\end{latexonly}

\section{Object detection and parameterisation -- PISAFIND}

\iref{PISAFIND} performs image analysis on a 2-dimensional data frame. It has
two basic modes of operation. The first is isophotal analysis in
which pixels with data values above a given threshold are examined for
connectivity and combined into objects. This type of analysis should be
used on images that contain a heterogeneous collection of objects such
as a mixture of stars and galaxies.

The second mode of operation is profile fitting in which an analytical
stellar profile is fitted to the objects found by a preliminary
isophotal analysis. This latter option should only be used in
situations where all the images on a data frame have the same shape,
such as in a star cluster. This type of analysis is also performed by
the \xref{DAOPHOT [3]}{sun42}{} package which specializes in analysing
crowded stellar fields.  The determination of the best fit model
parameters is performed by \iref{PISAFIT}.

In crowded regions deblending of overlapping sources can be performed.
The isophotal analysis does this by examining each object at a number of
higher isophotes to see if the object splits into more than one
component. The profile fitting does this by modelling the data with the
analytic profiles and seeing if the fit can be improved by decreasing or
increasing the number of objects, as well as altering their position and
brightness. In both cases the intensity of the combined image is
partitioned between the components to ensure conservation of flux.

If the objects have extensive wings to their intensity profiles then the
simple isophotal analysis can underestimate the total intensity in an
object; two options for estimating the total intensity are available.
The first uses a circular aperture of specified radius within which you
know the total light to be contained. The second uses an automatic
curve of growth analysis in which the intensity within elliptical
apertures of increasing size is measured until a maximum is reached.
This is similar to a Kron-style analysis.

For the profile fitting case the intensity of an object is obtained by
integrating under the analytic profile using the relevant parameters
(the actual functions are described in appendix \ref{funcparms}). The
analytic profile is made up of three components. The core of the profile
is a Gaussian but below a given level an exponential function
takes over. The two functions are under-pinned by a Lorentzian function
which is summed over all regions. If the results of the analysis are to
be compared to other frames then the magnitudes from the profile fitting
have to be related to total magnitudes by analysing at least one object
on the frame by both methods. The rest of the measurements can then be
suitably scaled to give total magnitudes.

It is always a good idea to run the isophotal analysis on a frame before
running any of the other options to check that there are no
peculiarities, and in the case of deblending to check that the objects
do not fragment too much. If the data is significantly oversampled (the
point-spread function covers many pixels) then the data should be binned
into a smaller array. There will be no significant loss of accuracy, but
a great improvement in execution time.

A full list of the \iref{PISAFIND} parameters is given in appendix
\ref{fulldescriptions} which should be consulted before running the
application.

\subsection{Pre-processing of the image}

\iref{PISAFIND} expects there to be no background variation in the
image array.  Any such variations should be removed in advance with a
suitable application, such as \xref{SURFIT}{sun95}{SURFIT} in
\xref{KAPPA [6]}{sun95}{}. The frame should also be clean of any
defects and bad pixels.

\subsection{Restriction on input data}
Currently \iref{PISAFIND} works with INTEGER data in the range 0 to 32766. An
array of real data in this range will be accepted by the routine but the
following message will appear:
\begin{quote}
\begin{verbatim}
   Input NDF is of type _REAL - this application can only process at
   _WORD precision; significance may be lost
\end{verbatim}
\end{quote}
If the array contains data outside this range the program will abort
with the following message:
\begin{quote}
\begin{verbatim}
   ! The input NDF contains "bad" pixels or values outside the range of
     _WORD, these cannot be correctly handled by this application.
\end{verbatim}
\end{quote}

A previous restriction on the size of the input data has been removed,
however, other limitations still apply. The maximum length of the {\em
first} dimension of any input data is 10240 pixels. Objects cannot
fragment into more than 200 pieces.

\subsection{Content\label{RESULTS} of the results files}
The results of the parameterisation analysis are written into two
files.

The first file name is defined by the RESULTS parameter. There are
eleven columns in the output file containing the following information
:-

\begin{center}
\begin{tabbing}
xxxxx \= xxxxxxxx \= xxxxxxxxxxxxx \= \kill
\> Column \> Name  \> Description \\
\> 1 \> INDEX \> Index number of object.\\
\> 2 \> XPOS \> X position of object in pixels.\\
\> 3 \> YPOS \> Y position of object in pixels.\\
\> 4 \> INTENSITY \> Integrated intensity of object.\\
\> 5 \> NPIX \> Number of pixels above threshold.\\
\> 6 \> PEAK \> Peak intensity of object in one pixel.\\
\> 7 \> ELLIPT \> Ellipticity of object.\\
\> 8 \> ANGLE \> Orientation of object, anti-clockwise from y-axis.\\
\> 9 \> SXX \> Second moment of data in x.\\
\> 10 \> SYY \> Second moment of data in y.\\
\> 11 \> SXY \> Cross moment of data in x and y.\\
\end{tabbing}
\end{center}

The SXX, SYY and SXY moments are defined as:
\begin{center}
\begin{displaymath}
SXX = \frac{\sum{x^{2}I_{i}}}{\sum{I_{i}}}, \, \,
SYY = \frac{\sum{y^{2}I_{i}}}{\sum{I_{i}}}, \, \,
SXY = \frac{\sum{xyI_{i}}}{\sum{I_{i}}}
\end{displaymath}
\end{center}
Where $x$ and $y$ are offsets from the centre of the object (determined
by the centroid) and $I_{i}$ is the intensity in a pixel, corrected for
the background contribution.

The ellipticity is defined by the equation:
\begin{center}
\begin{displaymath}
ell = \frac{a-b}{a}
\end{displaymath}
\end{center}
Where $a$ and $b$ are the semimajor and semiminor axes:
\begin{center}
\begin{displaymath}
a^{2} = 2\,(SXX + SYY) +2\,\sqrt{(SXX - SYY)^{2} +4\,SXY^{2}}
\end{displaymath}
\end{center}
\begin{center}
\begin{displaymath}
b^{2} = 2\,(SXX + SYY) -2\,\sqrt{(SXX - SYY)^{2} +4\,SXY^{2}}
\end{displaymath}
\end{center}
Note that these are intensity weighted rms-like distances. If you 
want to calculate values that go out to say the detection isophote
then you should use the geometric formulae:
\begin{center}
\begin{displaymath}
a = \sqrt{\frac{NPIX}{(\pi\,(1-ELLIPT))}}
\end{displaymath}
\end{center}
\begin{center}
\begin{displaymath}
b = a\,(1-ELLIPT)
\end{displaymath}
\end{center}

The results of the areal thresholding analysis are written to the
file whose name is given by the SIZES parameter.  There are nine
columns in the output file, the last seven contain the number of pixels
within the intensity thresholds : -
\begin{center}
\begin{displaymath}
 I_{i} = I_{t} + 2^{(i+2)},\; i=2,8
\end{displaymath}
\end{center}
where $I_{t}$ is the threshold intensity and $I_{i}$ is the object
intensity above the threshold :-

\begin{center}
\begin{tabbing}
xxxxx\=xxxxxxxx \= xxxxxxxxxxxxx \= \kill
\>Column \> Name  \> Description \\
\> 1 \> INDEX \> Index number of object.\\
\> 2 \> A1 \> Number of object pixels within threshold.\\
\> 3 \> A2 \> Number of object pixels within i=2 threshold.\\
\> 4 \> A3 \> Number of object pixels within i=3 threshold.\\
\> 5 \> A4 \> Number of object pixels within i=4 threshold.\\
\> 6 \> A5 \> Number of object pixels within i=5 threshold.\\
\> 7 \> A6 \> Number of object pixels within i=6 threshold.\\
\> 8 \> A7 \> Number of object pixels within i=7 threshold.\\
\> 9 \> A8 \> Number of object pixels within i=8 threshold.\\
\end{tabbing}
\end{center}

The RESULTS output of \iref{PISAFIND} can be used as input to the
aperture photometry program \xref{PHOTOM [4]}{sun45}{}. This could be
exploited to automate the photometry of standard stars on CCD frames.

\section{Visual inspection -- PISAPLOT}

\iref{PISAPLOT} plots the results of the \iref{PISAFIND} analysis as a
series of ellipses which reflect the size and shape of the objects as
defined by their RESULTS parameters. The ellipses can be annotated
with their index number to provide a cross-reference to the object
list. The plot may be overlaid on an existing image for a direct
comparison of the results.

The program uses \xref{AGI [7]}{sun48}{} the graphics database so that
suitable tasks, such as the \xref{KAPPA [6]}{sun95}{} routine
\xref{CURSOR}{sun95}{CURSOR}, can be used to get positional
information. \iref{PISAPLOT} has many parameters which control such things as
the line thickness, line colour, the upper and lower bounds of the
plot axis, so that the output can be modified for presentation and
comparison purposes.

Perhaps the most likely use of \iref{PISAPLOT} is to overlay a results
file over a previously displayed image. This is achieved using the
OVERLAY parameter
\begin{verbatim}
   # pisaplot overlay
\end{verbatim}

If the plotting device has an overlay plane then the present contents of
it may be cleared using the CLEAR parameter
\begin{verbatim}
   # pisaplot overlay clear
\end{verbatim}

The colours of the plotted ellipses are controlled using the PALNUM
parameter. If the graphics device allows colour then different pen
numbers may be used for successive plots using the OVERLAY option. So for
instance a group of objects separated from the main results by some
criterion (being stellar) may be plotted in one colour and the others in
another colour. The pen colours are set by \xref{PGPLOT}{sun15}{} and are:
\begin{center}
\begin{tabular}{|c|c|}
\hline
Pen Number & Colour \\
\hline
\hline
0 & background colour \\
1 & foreground colour \\
2 & red \\
3 & green \\
4 & blue \\
5 & cyan \\
6 & magenta \\
7 & yellow \\
8 & orange \\
\hline
\end{tabular}
\end{center}
and so on up to pen 16.

After \iref{PISAPLOT} has been run these colours can be superseded by
using the \xref{KAPPA}{sun95}{} palette facilities
\xref{PALDEF}{sun95}{PALDEF} and \xref{PALENTRY}{sun95}{PALENTRY}, but
note that any subsequent runs of \iref{PISAPLOT} will reinstate the
PGPLOT default colours so using the \xref{KAPPA}{sun95}{} facilities
should be delayed until all different sets of objects have been
displayed. The \xref{KAPPA}{sun95}{} palette pen numbers correspond to
PALNUM values (hence the parameter name).


\section{Determining a profile model -- PISAFIT}
\iref{PISAFIT} fits the radially symmetric mixed Gaussian -
Exponential - Lorentzian function (appendix \ref{funcparms}) as used
by \iref{PISAFIND} in its profile fitting mode. It fits objects whose
{\em accurate} positions are given in a formatted list. The objects
should be stars which are well separated on the frame and which are
not saturated. The list of positions may contain the usual PISA format
of identifier (an integer) followed by the X and Y positions, or may
just contain the X and Y positions as returned by the \xref{KAPPA [6]
CENTROID}{sun95}{CENTROID} routine.

The PISA profile fitting function is described by three separate
parameters; the gaussian sigma (GSIGM); the cross over point (CROSS),
as a fraction of the peak intensity, from the gaussian core to an
exponential wing; and the fractional mix (COMIX) of a Lorentzian to
these two functions at each point.
The parameters resultant from the functional fit are stored as the
global values, PISA\_GSIGM, PISA\_CROSS and PISA\_COMIX (global values
are stored in the global parameter file (\$HOME/adam/GLOBAL.sdf or
\$ADAM\_USER/GLOBAL.sdf, if you've set the \$ADAM\_USER environment variable).
These will be accessed automatically by \iref{PISAFIND},
\iref{PISAGEN} and \iref{PISAPEAK}.

The fit produced by this routine is displayed on a graphics device,
together with the residuals (derived from the variance of data
contributing to each point), so that the quality of fit can be
assessed.  Extra data, displayed with a different point type, is shown
beyond the fitting radius.  After the plot and fitting statistics are
shown, you are prompted about your satisfaction with the fit, if you
are not happy then it is possible to re-do the fit using a different
radius. This cycle can be repeated until you are satisfied.
Experience shows that the first fit is rarely the best.

Different constraints can be placed on the ranges of values that the
three fit parameters can take. Type APM sets up the range bounds so
that a minimisation as performed by the original APM version of this
routine is done. Type USER allows you to specify the ranges within
which the fit parameters can vary.  Type NONE frees the minimisation
routine to fit the function as it can, the only restriction being that
the parameters must have values greater than zero.  The fit can be
done using a weighted scheme (this uses the residuals displayed in the
plot).

\iref{PISAFIT} uses the graphics database \xref{AGI [7]}{sun48}{}, so
plots can be made within predefined pictures on the chosen graphics
device and values can read directly using a suitable cursor
program. AGI pictures can be defined by the program \xref{PICDEF in KAPPA
[6]}{sun95}{PICDEF}.

\section{Model data generation --- PISAGEN \& ADDNOISE}

\iref{PISAGEN} generates model data using the PISA profile fitting function
(appendix \ref{funcparms}). The objects are formed using the positions
and integrated intensities output by \iref{PISAFIND} in its profile
fitting mode (or any other data of the same form for the first four
columns):-
\begin{itemize}
\item Object number
\item X position
\item Y position
\item Integrated intensity.
\end{itemize}
Extra parameters not available in the other PISA routines allow \iref{PISAGEN}
output objects to be elliptical. The image output from \iref{PISAGEN} can have
noise added of either gaussian form or of a pseudo-poissonian type. The
noise levels are recorded in the variance component of the output NDF.
The resultant model image can then be subtracted from the original data
and the difference frame may be inspected, for missed objects, the
goodness of the profile fit etc.

\iref{PISAGEN} can also perform the generation of model data for test purposes,
the program accepts integrated intensities and can generate very
accurate model objects by integrating the flux within each pixel. It is
also possible to generate mixed frame data, i.e. data with objects of
differing model parameters (and ellipticities). This is done by running
\iref{PISAGEN} multiply with the different parameters (with a zero background,
except for one frame) and then combining the frames by addition. Noise
can be added to this `mixed' frame (which could for instance mimic a
frame of stars and elliptical objects with extended wings (galaxies!
although not $R^{1/4}$ ones)) by an ancillary program \iref{ADDNOISE}, which is
available with the PISA package.

\section{\sloppy Using the PISA parameters --- PISAPEAK, PISAKNN, PISA2CAT \&
                 PISA2ARD}

Other packages exist which can be used to perform selections,
transform values, and generally analyse and categorise the
\iref{PISAFIND} parameterisations.
With sufficient effort they may be used to classify objects.
Catalogue manipulations can be done using the \xref{CURSA
[5]}{sun190}{} and \xref{CATPAC[8]}{sun120}{} packages.
More general plotting packages also be used to investigate the various
results; \xref{PONGO [12]}{sun137}{} and \htmlref{SM [13]}{SM}
both plot data points and allow mathematical transformations of
columns.
Using CLUSTAN you could investigate the natural clustering of objects
in parameter space (with the aim of classification in mind).

\subsection{PISA data in CURSA and CATPAC}

Any of the PISA output files (from \iref{PISAFIND} and
\iref{PISAPEAK}) can be converted for use by the \xref{CURSA
[5]}{sun190}{} and the \xref{CATPAC [8]}{sun120}{} packages.
The easiest way to convert a PISA results file into a catalogue is to
use the
\begin{verbatim}
   # pisa2cat
\end{verbatim}
routine. CURSA and CATPAC can be used to perform simple manipulations
--- operations such as, sorting and subsetting according to various
criteria.

\subsection{Getting the PISA output files into CLUSTAN}

It is possible to get PISA format data into CLUSTAN and do analyses
based on the `natural' clustering of the RESULTS.
The analyses are highly dependent on the similarity measure (the
distance in the parameter space) and consequently the clustering which
is found is more often than not due to the measure rather than the
physical attributes of the objects.
In runs of CLUSTAN on the test NDF `FRAME' in the PISA directory seem
to select strongly by angle and the sign of the cross moment (SXY),
and very weakly in others (ellipticity for one) which one might expect
to bear more relevance to the real `clustering'.
This problem probably requires careful selection of the variables to
use and may well require the production of new hybrid variables
(things like intensity/peak) as performed by \iref{PISAPEAK}.

A description of the entry of PISA data into CLUSTAN is given below and an
analysis using this may be attempted, however, NO significance  should be
ascribed to the results. If you really want to use this method there is no
substitute to a proper understanding.

A file called \verb+clustan.dat+ is found in \$PISA\_DIR, take a copy
of it. It shows how to get data into CLUSTAN, to run it in `batch'
mode simply change the file names to those of your \iref{PISAFIND}
data files and type.
\begin{verbatim}
   # clustan < clustan.dat
\end{verbatim}

\subsection{Object classification}

It should, in principle, be possible to classify objects using the
\iref{PISAFIND} parameterisations of a {\em single} frame, but, this will only
be possible provided that the apparent morphology of subject objects
allow it (faint noise-limited objects are unlikely to be distinguishable
from stars, and you shouldn't be too disappointed when they are not).

However, given a set of distinguishable objects a classification can be
performed. Before such a task can be undertaken it is first necessary to
remove the intensity dependency of the parameters. This allows the
`shape' for a class of objects to remain reasonably constant. The
quality `shape', in this context, really refers to a multivariate
function. Usually the only objects on any single frame which have a
constant shape are the stars. So the approach adopted in PISA is to
`normalize' the \iref{PISAFIND} parameterisations so that they are referenced
to an ideal star. This is the first stage of classification using PISA.

\subsection{Transforming PISA parameters to intensity invariant form}

\iref{PISAPEAK} transforms the \iref{PISAFIND} RESULTS
parameterisations so that the variables are intensity invariant,
assuming a stellar profile. The output from \iref{PISAPEAK} is
intended for use in star-galaxy separation, either by applying direct
cuts in variable values (\iref{PISACUT}) or by discrimination analysis
routines such as \iref{PISAKNN}. A fit to stars on a frame can be
performed by \iref{PISAFIT}, which should be used prior to
\iref{PISAPEAK}. The output from \iref{PISAPEAK} is a list of four
parameters:
\begin{itemize}
\item A `peakedness' measure.
\item The total intensity to peak intensity ratio, normalised to the
analytical function.
\item The unmodified ellipticity.
\item The absolute value of the intensity weighted cross moment (SXY).
\end{itemize}

The peakedness measure is the ratio of the semi-major axis of the
detected object (at the detection threshold) to the radius of the
analytic function which has the same peak value (averaged with the
central 9 pixels). Thus it specifies how more extended the object is
than a star with the same peak value. This should select strongly
between galaxies and stars. Indeed very good separation can be performed
by using cuts of this value.

The model profile is used to scale the object peakedness and intensity
peak ratio to values around one. This only works well if the PISA
profiling function is a good fit to the stars on your frame. If it is
not a good fit or you cannot determine the model parameters then
inaccurate values can be used, the only criterion being that the GSIGM
value is about the FWHM seeing of your data (this is important for
resampling the peak of the object). The results file will now contain
values `normalised' to this `imaginary' object. The stars will still
form a group of objects with similar values, although they may not be as
tightly clustered as with a good fit.

\subsection {Distribution free classification}

\iref{PISAKNN} use the results of \iref{PISAPEAK} to discriminate
objects into two classes. \iref{PISAKNN} uses KNN (k nearest
neighbours) distribution-free multivariate discrimination to classify
objects into two classes. The classes are seeded by supplying two
files which contain the indices of objects typical to the class in
question ($>5$, approximately equal numbers of each). Each object then
propagates its class to the other objects on the basis of which class
of the 2*k nearest neighbours (in the parameter space of the
\iref{PISAPEAK} results) of each of the unclassified objects is most
common. This procedure is iterated until all objects are assigned and
have a stable class or until a maximum number of iterations is
exceeded. The results of the discrimination are written to two output
files, one for each class.

KNN relies on good seed statistics as propagation is essentially linear
(but remember that this is in a multivariate sense). If the seed
subjects do not reasonably span the whole of the object parameter space
improper incursion can occur, leading to misclassification. The
classification in boundary areas between the objects will depend on the
size of the nearest neighbour count, larger values will help the
investigation of the `fuzzy' areas. If a very small value is chosen then
this will act almost as a thresholding (but of all the parameters not
just one).

KNN has the advantage over classical discriminant analysis in that it
does not relies on the classes of objects having multinomial
distributions. The assumption of the normality of the objects
contributing to each class relies all classes having a random spread
across a particular part of parameter space. It is unlikely that this
requirement can be met for small galaxy populations, although this may
work well for large statistical samples.

The ellipticity is included in the analysis, however, this may not
always help selection. If some smallish round galaxies are present using
this variable will increase the weight of selecting them as stars. In
this case it may be profitable to switch off the ellipticity.
Ellipticity can be used for other purposes, say if you want a complete
sample of stars, all stars will have ellipticities below a given
threshold and can be selected thus. Further refinement can then be
applied to the list by thresholding in peakedness to remove objects with
large wings.

\subsection{PISA2ARD}

The \iref{PISA2ARD} application converts the results file output from
\iref{PISAFIND} into an \xref{`ARD description'}{sun183}{}. This description
consists of a series of ellipses -- one for each detected object. The
\xref{ARD description}{sun183}{} can be
used by suitable applications to remove or analyse the areas within the
ellipses. So for instance to remove all the detected objects from a
frame, convert the results file into an \xref{ARD description}{sun183}{}
(with the ellipses possibly scaled by some small amount to remove outlying
parts) and use an \xref{ARD}{sun183}{} masking routine, such as
KAPPA \xref{ARDMASK}{sun95}{ARDMASK}. \xref{ARD}{sun183}{}
is also used by the packages \xref{ESP [10]}{sun180}{} and
\xref{CCDPACK [11]}{sun139}{}.

\section{List manipulation utilities --- PISACUT \& PISAMATCH}
\iref{PISACUT} separates a file of variables into two. The separation is
performed by thresholding the values in a single column. The routine
works on any formatted data files, applying a threshold to one of the
variables. File entries with the selected variable value above or below
the threshold are written out to separate files. It is intended for use
in separating any PISA package results files.

\iref{PISAMATCH} matches the first column of values (the object indices) of two
input files. When a match is located between the indices the complete
entry in the second file is copied to the output file. The routine is
primarily intended for matching the indices output from \iref{PISACUT} or
\iref{PISAKNN} to those of the original \iref{PISAFIND} data file, thus the new
classes can have their properties analysed, or can be displayed using
\iref{PISAPLOT}.

\section{Examples of running the PISA software}

This section shows examples of how the PISA package may be used. Most
applications have more capabilities than are shown here. Refer to the
appendix with the complete descriptions if the sort of task which you
want to perform is not shown here.

The examples as shown are intended to be `platform independent'. No
items specific to running PISA from the C-shell or
\xref{ICL}{sg5}{} are shown.  All the application parameters are
identical; the main differences are due to special character
interpretation. In \xref{ICL}{sg5}{}
the continuation character is \verb+`~'+
and in the C-shell \verb+`\'+.  No continuation character
is shown in the examples. When using the C-shell double quotes around
\verb+""+ strings will be stripped as will vector braces \verb+[]+, so
it is necessary to protect them by using the escape character or by
using single quotes around the complete parameter value i.e. use
\verb+'"a parameter string"'+ or \verb+\"a parameter string\"+ not
\verb+"a parameter string"+, and
\verb+'[1,2,3,4]'+  or \verb+\[1,2,3,4\]+ not \verb+[1,2,3,4]+

\subsection{Isophotal analysis with deblending}

This example performs isophotal analysis with deblending of overlapped
images on a frame containing a mixture of stars and galaxies.
The results are then plotted on a hardcopy device.
\begin{verbatim}
   # pisafind
   IN - NDF containing input image > frame
     Analysing whole image
   MINPIX - Minimum pixel size for images (typically 4-16) > 6
   METHOD - Intensity analysis ( 0=Isophotal, 1=Total, 2=Profile ) > 0
     Estimated background level =   492.2
     Background standard deviation =     7.4
   BACKGROUND - Background (global sky) value /492.17/ >
   THRESH - Threshold for analysis (data units) > 11.5

     Total number of positive images = 141
     The results have been written to pisafind.dat
         and pisasize.dat

   # pisaplot
   RESULTS - File of PISAFIND parameterised data /@pisafind/ >
   DEVICE - Name of graphics device > postscript_p
\end{verbatim}

\subsection{Plotting overlaid ellipses}
Using \iref{PISAPLOT} to overlay ellipses is achieved using the OVERLAY and
CLEAR parameters. The image over which the plot is to be overlaid should
have been displayed using the \xref{KAPPA DISPLAY}{sun95}{DISPLAY} or a
routine which uses \xref{AGI}{sun48}{} to store its graphics information
(such as \iref{PISAGREY}).
\begin{verbatim}
   # display in=frame mode=per percentiles=[1,99] device=xw
   # pisaplot results=pisafind.dat overlay device=xw
\end{verbatim}

If a device with a suitable overlay is used then the overlay plane may
be erased prior to the plotting of the ellipses using the CLEAR
parameter.
\begin{verbatim}
   # pisaplot results=pisafind.dat overlay clear device=xov
\end{verbatim}

The colour of the ellipses is controlled using the PALNUM parameter. So
for instance if one had two lists of results which are separated into
stars and galaxies for instance (or one could have \iref{PISAFIND} results
files separated by intensity, ellipticity etc.)
\begin{verbatim}
   # pisaplot results=stars.dat overlay palnum=3
   # pisaplot results=galaxies.dat overlay palnum=4
\end{verbatim}
This sequence of commands would result in the data in file
\verb+stars.dat+ being overlaid and coloured green. The data in file
\verb+galaxies.dat+ would also be overlaid on the same image and
coloured blue. The colours of these could then be altered using the
\xref{KAPPA}{sun95}{} palette facilities for pens \verb+3+ and \verb+4+.

\subsection{Performing profile fitting analyses}

To perform a profile fit a list of the accurate positions of good well
separated stars are required. One way to get such a list is too use
the \xref{KAPPA CENTROID}{sun95}{CENTROID} routine to select objects
from a displayed image.
\begin{verbatim}
   # centroid coout=stars.acc mode=cursor mark
\end{verbatim}
The output file \verb+stars.acc+ is of a format suitable for input to
\iref{PISAFIT}. Running \iref{PISAFIT} allows the determination of the
best fit to the stars.
\begin{verbatim}
   # pisafit
   IN - NDF containing input image /@frame/ >
    Analysing whole image
    Estimated background level =   492.2
    Background standard deviation =     7.4
   BACKGROUND - Background (global sky) value /492.2/ >
   POSITIONS - File containing star positions / / > stars.acc
   MINMODE - Minimisation bounds mode /'APM'/ >
   RADIUS - Limiting Radius > 10
    Number of points in curve fit = 28

    May be having problems with the minimisation, check plot.
    RMS of fit                 = 2.0545775E-02
    Gaussian Sigma      (GSIGM)=  2.17
    % Cross Over        (CROSS)= 30
    Mixture Coefficient (COMIX)= 0.087
   AGAIN - Do fit again /TRUE/ > f

\end{verbatim}
The parameters controlling other various options are detailed in the
routine description appendix. Usually the default options (as shown) are
all that are necessary.

\iref{PISAFIT} writes the model parameterisations into the
application's parameter file. These values are then automatically
picked up by any other PISA application which requires them. So for
instance running \iref{PISAFIND} in its profile fitting mode is
straight-forward after running \iref{PISAFIT}.
\begin{verbatim}
   # pisafind
   IN - NDF containing input image /@frame/ >
    Analysing whole image
   MINPIX - Minimum pixel size for images (typically 4-16) / / > 4
   METHOD - Intensity analysis ( 0=Isophotal, 1=Total, 2=Profile ) /0/ > 2
   GSIGM - Gaussian sigma (pixels) /2.17146/ >
   CROSS - Crossover point % of peak /30/ >
   COMIX - Mixture coefficient /8.7035753E-02/ >
   UPLIM - Upper intensity limit to use in analysis (saturation) /32767/ >
   IFULL - Do you want full surface modelling /FALSE/ >
    Estimated background level =   492.2
    Background standard deviation =     7.4
   BACKGROUND - Background (global sky) value /492.17/ >
   THRESH - Threshold for analysis (data units) /20/ >

    Total number of positive images = 119
    The results have been written to pisafind.dat
        and pisasize.dat
\end{verbatim}

\subsection{Fancy plots}

\iref{PISAPLOT} allows the use of \xref{PGPLOT}{sun15}{} text escape
sequences.
It also has parameters controlling the size of the annotations, the
presence of annotations, the number of tick mark and the thickness of
the lines. So for instance the plot on the front page of this document
was produced using the commands.
\begin{verbatim}
   # pisafind frame(80:210,115:260) reset accept
   # pisaplot device=pscript_p pltitl="\fr Objects located by PISAFIND"
              abslab="\fr X position (pixels)"
              ordlab="\fr Y position (pixels)" thick=2 annoscale=2.5
\end{verbatim}

Hence the labels were written using a Roman font.

\subsection{Simple object classification}

PISA contains routines which when used co-operatively can separate
objects into lists of stars and `other' objects. If the objects have
been located using \iref{PISAFIND} and a suitable profile fit has been
made using \iref{PISAFIT}, then using \iref{PISAPEAK} produces a set
of `intensity invariant' measures. Basically what we're looking for
here are some transformations of the original \iref{PISAFIND} RESULTS
measurements which are not different simply because the objects are of
different apparent brightnesses. The transformations chosen try to
have the same values for a star of any brightness. Try the following
sequence of commands.

\begin{verbatim}
   # pisapeak in=frame finddata=pisafind.dat results=pisapeak.dat
   # pisacut input=pisapeak.dat column=2 thresh=0.85 lower=stars.indices
             higher=gals.indices
   # pisamatch one=stars.indices two=pisafind.dat out=stars.dat
   # pisamatch one=gals1.indices two=pisafind.dat out=gals.dat
\end{verbatim}

This example transforms the \iref{PISAFIND} RESULTS file using a model
stellar profile fit, writing the results to
\verb+pisapeak.dat+. \iref{PISACUT} is then used to separate the
\iref{PISAPEAK} results, thresholding the data using a cut of
0.85\footnote{The value 0.85 is decided basically by trial and
error. Ideally objects with peakedness measure less than 1 would
always be stars, however, the actual value depends strongly on the
quality of the profile fit.}  in the peakedness measure (this strongly
selects for stars). The indices of the objects in file
\verb+stars.indices+ and \verb+gals.indices+ are then matched against
those of the original \iref{PISAFIND} RESULTS file, giving two files
which contain the \iref{PISAFIND} RESULTS for the separated objects.

\subsection{Comprehensive example}
\label{pisa_demo}

A more comprehensive example of PISA usage \verb+`pisa_demo'+ can be
found in the pisa directory (\$PISA\_DIR). From the C-shell
\verb+pisa_demo+ is defined as a command so just run it as any of the
applications. From \xref{ICL}{sg5}{} the \verb+pisa_demo+ procedure
needs to be loaded before running, this is achieved just by typing the
procedure name \verb+pisa_demo+ followed by the invocation
\verb+pisa_demo `device_name'+.

\section{Acknowledgements}

Thanks go to Mike Irwin and Steve Maddox for explaining some of the
secrets of the APM IMAGES package, and to Malcolm Currie for supplying
the original version of \iref{PISAPLOT}.

\section{References}

 1 --- \xref{SG/4: ADAM - The Starlink Software Environment.}{sg4}{}

 2 --- Irwin, M.J., 1985, \label{[2]}Automatic analysis of crowded fields,
       Mon.Not.R.astr.Soc., {\bf 214}, 575-604.

 3 --- \xref{SUN/42: DAOPHOT - Stellar Photometry Package.}{sun42}{}

 4 --- \xref{SUN/45: PHOTOM - An aperture photometry routine.}{sun45}{}

 5 --- \xref{SUN/190: CURSA - Catalogue and Table Manipulations Applications}
       {sun190}{}

 6 --- \xref{SUN/95: KAPPA - Kernel Application Package.}{sun95}{}

 7 --- \xref{SUN/48: AGI - Applications Graphics Interface Programmers Guide.}
       {sun48}{}

 8 --- \xref{SUN/120: CATPAC - Catalogue Applications Package.}{sun120}{}

 9 --- \xref{SUN/15: PGPLOT - Graphics Subroutine Library.}{sun15}{}

10 --- \xref{SUN/180: ESP - The extended surface photometry package.}{sun180}{}

11 --- \xref{SUN/139: CCDPACK - CCD data reduction package.}{sun139}{}

12 --- \xref{SUN/137: PONGO - A Set of Applications for Interactive
             Data Plotting.}{sun137}{}

13 --- MUD/159/160:\label{SM} SM - interactive graphics package.

\newpage
\appendix
\section{Full routine descriptions}
\label{fulldescriptions}

%+
%  Name:
%     SST.TEX

%  Purpose:
%     Define LaTeX commands for laying out Starlink routine descriptions.

%  Language:
%     LaTeX

%  Type of Module:
%     LaTeX data file.

%  Description:
%     This file defines LaTeX commands which allow routine documentation
%     produced by the SST application PROLAT to be processed by LaTeX and
%     by LaTeX2html. The contents of this file should be included in the
%     source prior to any statements that make of the sst commnds.

%  Notes:
%     The style file html.sty provided with LaTeX2html needs to be used.
%     This must be before this file.

%  Authors:
%     RFWS: R.F. Warren-Smith (STARLINK)
%     PDRAPER: P.W. Draper (Starlink - Durham University)

%  History:
%     10-SEP-1990 (RFWS):
%        Original version.
%     10-SEP-1990 (RFWS):
%        Added the implementation status section.
%     12-SEP-1990 (RFWS):
%        Added support for the usage section and adjusted various spacings.
%     8-DEC-1994 (PDRAPER):
%        Added support for simplified formatting using LaTeX2html.
%     {enter_further_changes_here}

%  Bugs:
%     {note_any_bugs_here}

%-

%  Define length variables.
\newlength{\sstbannerlength}
\newlength{\sstcaptionlength}
\newlength{\sstexampleslength}
\newlength{\sstexampleswidth}

%  Define a \tt font of the required size.
\newfont{\ssttt}{cmtt10 scaled 1095}
\begin{htmlonly}
   \newcommand{\ssttt}{\tt}
\end{htmlonly}

%  Define a command to produce a routine header, including its name,
%  a purpose description and the rest of the routine's documentation.
\newcommand{\sstroutine}[3]{
   \goodbreak
   \rule{\textwidth}{0.5mm}
   \vspace{-7ex}
   \newline
   \settowidth{\sstbannerlength}{{\Large {\bf #1}}}
   \setlength{\sstcaptionlength}{\textwidth}
   \setlength{\sstexampleslength}{\textwidth}
   \addtolength{\sstbannerlength}{0.5em}
   \addtolength{\sstcaptionlength}{-2.0\sstbannerlength}
   \addtolength{\sstcaptionlength}{-5.0pt}
   \settowidth{\sstexampleswidth}{{\bf Examples:}}
   \addtolength{\sstexampleslength}{-\sstexampleswidth}
   \parbox[t]{\sstbannerlength}{\flushleft{\Large {\bf #1}}}
   \parbox[t]{\sstcaptionlength}{\center{\Large #2}}
   \parbox[t]{\sstbannerlength}{\flushright{\Large {\bf #1}}}
   \begin{description}
      #3
   \end{description}
}

%  Format the description section.
\newcommand{\sstdescription}[1]{\item[Description:] #1}

%  Format the usage section.
\newcommand{\sstusage}[1]{\item[Usage:] \mbox{}
\\[1.3ex]{\raggedright \ssttt #1}}

%  Format the invocation section.
\newcommand{\sstinvocation}[1]{\item[Invocation:]\hspace{0.4em}{\tt #1}}

%  Format the arguments section.
\newcommand{\sstarguments}[1]{
   \item[Arguments:] \mbox{} \\
   \vspace{-3.5ex}
   \begin{description}
      #1
   \end{description}
}

%  Format the returned value section (for a function).
\newcommand{\sstreturnedvalue}[1]{
   \item[Returned Value:] \mbox{} \\
   \vspace{-3.5ex}
   \begin{description}
      #1
   \end{description}
}

%  Format the parameters section (for an application).
\newcommand{\sstparameters}[1]{
   \item[Parameters:] \mbox{} \\
   \vspace{-3.5ex}
   \begin{description}
      #1
   \end{description}
}

%  Format the examples section.
\newcommand{\sstexamples}[1]{
   \item[Examples:] \mbox{} \\
   \vspace{-3.5ex}
   \begin{description}
      #1
   \end{description}
}

%  Define the format of a subsection in a normal section.
\newcommand{\sstsubsection}[1]{ \item[{#1}] \mbox{} \\}

%  Define the format of a subsection in the examples section.
\newcommand{\sstexamplesubsection}[2]{\sloppy
\item[\parbox{\sstexampleslength}{\ssttt #1}] \mbox{} \vspace{1.0ex}
\\ #2 }

%  Format the notes section.
\newcommand{\sstnotes}[1]{\item[Notes:] \mbox{} \\[1.3ex] #1}

%  Provide a general-purpose format for additional (DIY) sections.
\newcommand{\sstdiytopic}[2]{\item[{\hspace{-0.35em}#1\hspace{-0.35em}:}]
\mbox{} \\[1.3ex] #2}

%  Format the implementation status section.
\newcommand{\sstimplementationstatus}[1]{
   \item[{Implementation Status:}] \mbox{} \\[1.3ex] #1}

%  Format the bugs section.
\newcommand{\sstbugs}[1]{\item[Bugs:] #1}

%  Format a list of items while in paragraph mode.
\newcommand{\sstitemlist}[1]{
  \mbox{} \\
  \vspace{-3.5ex}
  \begin{itemize}
     #1
  \end{itemize}
}

%  Define the format of an item.
\newcommand{\sstitem}{\item}

%% Now define html equivalents of those already set. These are used by
%  latex2html and are defined in the html.sty files.
\begin{htmlonly}

%  sstroutine.
   \renewcommand{\sstroutine}[3]{
      \subsection{#1\xlabel{#1}-\label{#1}#2}
      \begin{description}
         #3
      \end{description}
   }

%  sstdescription
   \renewcommand{\sstdescription}[1]{\item[Description:]
      \begin{description}
         #1
      \end{description}
   }

%  sstusage
   \renewcommand{\sstusage}[1]{\item[Usage:]
      \begin{description}
         {\ssttt #1}
      \end{description}
   }

%  sstinvocation
   \renewcommand{\sstinvocation}[1]{\item[Invocation:]
      \begin{description}
         {\ssttt #1}
      \end{description}
   }

%  sstarguments
   \renewcommand{\sstarguments}[1]{
      \item[Arguments:]
      \begin{description}
         #1
      \end{description}
   }

%  sstreturnedvalue
   \renewcommand{\sstreturnedvalue}[1]{
      \item[Returned Value:]
      \begin{description}
         #1
      \end{description}
   }

%  sstparameters
   \renewcommand{\sstparameters}[1]{
      \item[Parameters:]
      \begin{description}
         #1
      \end{description}
   }

%  sstexamples
   \renewcommand{\sstexamples}[1]{
      \item[Examples:]
      \begin{description}
         #1
      \end{description}
   }

%  sstsubsection
   \renewcommand{\sstsubsection}[1]{\item[{#1}]}

%  sstexamplesubsection
   \renewcommand{\sstexamplesubsection}[2]{\item[{\ssttt #1}] \\ #2}

%  sstnotes
   \renewcommand{\sstnotes}[1]{\item[Notes:]
      \begin{description}
         #1
      \end{description}
   }

%  sstdiytopic
   \renewcommand{\sstdiytopic}[2]{\item[{#1}]
      \begin{description}
         #2
      \end{description}
   }

%  sstimplementationstatus
   \renewcommand{\sstimplementationstatus}[1]{\item[Implementation Status:]
      \begin{description}
         #1
      \end{description}
   }

%  sstitemlist
   \newcommand{\sstitemlist}[1]{
      \begin{itemize}
         #1
      \end{itemize}
   }
\end{htmlonly}

%  End of "sst.tex" layout definitions.
%.



\small
\sstroutine{
   ADDNOISE
}{
   Adds noise to model data
}{
   \sstdescription{
      ADDNOISE, adds noise to model data. The noise can be either
      poissonian or gaussian. If gaussian a constant noise level,
      described by a given standard deviation, is introduced. If
      poissonian the data is scaled by a factor to change data values
      into counts. The counts are then used as estimates of the mean
      value in that pixel and noise is added on this basis. Note that
      the poissonian noise is pseudo gaussian and so the count levels in
      the frame need to be greater than 10.
   }
   \sstusage{
      ADDNOISE IN NOISE OUT
        \newline\hspace*{1.5em}
        $\left\{ {\begin{tabular}{l}
                                      ADU=? \\
                                      SIGMA=? \\
                  \end{tabular} }
        \right.$
        \newline\hspace*{1.9em}
        \makebox[0mm][c]{\small noise}
   }
   \sstparameters{
      \sstsubsection{
         IN = NDF (Read)
      }{
         The input NDF containing the data to which noise needs to be
         added.
      }
      \sstsubsection{
         NOISE = LITERAL (Read)
      }{
         The noise type to introduce into the data. Either Gaussian or
         Poissonian, which may be abbreviated to G and P. [P]
      }
      \sstsubsection{
         ADU = REAL (Read)
      }{
         The scaling factor to convert the data values in the input NDF
         to counts for which Poisson statistics are assumed valid.
         [1.0]
      }
      \sstsubsection{
         SIGMA = REAL (Read)
      }{
         The standard deviation of the gaussian noise. [1.0]
      }
      \sstsubsection{
         OUT = NDF (Write)
      }{
         The output NDF to contain the data with noise added.
      }
   }
   \sstexamples{
      \sstexamplesubsection{
         ADDNOISE IN=MODEL NOISE=G SIGMA=20 OUT=MODEL\_WITH\_NOISE
      }{
         This adds gaussian noise to the input NDF model. The noise has
         a standard deviation of 20 units.
      }
      \sstexamplesubsection{
         ADDNOISE IN=MODEL NOISE=P ADU=10 OUT=MODEL\_WITH\_NOISE
      }{
         This adds poissonian noise to the input NDF model. The data
         values are scaled by a factor of 10 before the noise is
         calculated.
      }
   }
}
\newpage
\sstroutine{
   PISA2ARD
}{
   Creates an ARD description of detected objects
}{
   \sstdescription{
      This routine converts the RESULTS output from PISAFIND into an ARD
      description. The ARD description consists of a series of ellipses,
      one for each detected object, which can be used to identify the
      area of the images on a frame.

      The scale of the ellipses can be changed allowing the effective
      areas to be modified.
   }
   \sstusage{
      PISA2ARD RESULTS ARDFILE SCALE
   }
   \sstparameters{
      \sstsubsection{
         ARDFILE = LITERAL (Read)
      }{
         The name of a text file to contain the ARD description.
         [PISA2ARD.DAT]
      }
      \sstsubsection{
         RESULTS = LITERAL (Read)
      }{
         The name of the file containing the RESULTS from a run of the
         PISAFIND application.
         [PISAFIND.DAT]
      }
      \sstsubsection{
         SCALE = \_REAL (Read)
      }{
         The scale factor to apply to the ellipse major and minor axes.
         This value must be in the range 0.01 to 100.0.
         [1.0]
      }
   }
   \sstexamples{
      \sstexamplesubsection{
         PISA2ARD PISAFIND.DAT PISA2ARD.DAT 1.0
      }{
         In this example an ARD description is written to file
         PISA2ARD.DAT. The ellipses cover exactly the same area as the
         ellipses fitted to the detected objects.
      }
      \sstexamplesubsection{
         PISA2ARD PISAFIND.DAT PISA2ARD.DAT 2.0
      }{
         In this example an ARD description is written to file
         PISA2ARD.DAT. The ellipses have major and minor axes which are
         twice as long as those which fitted the detected objects. This
         gives four times as much area.
      }
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         The input to the parameter RESULTS must have the same format as
         the output from the PISAFIND parameter RESULTS.
      }
   }
}
\newpage
\sstroutine{
   PISA2CAT
}{
   Converts a PISA formatted data file into a catalogue
}{
   \sstdescription{
      PISA2CAT converts PISAFIND and PISAPEAK results files into
      catalogues. The output catalogues can be used by CURSA
      or CATPAC applications.
   }
   \sstusage{
      pisa2cat datatype data cat
   }
   \sstparameters{
      \sstsubsection{
         DATATYPE = LITERAL (Read)
      }{
         The type of PISA data. Either FIND, SIZE or PEAK. FIND
         indicates that the input data is a results file produced by
         PISAFIND (RESULTS parameter) and that it contains the main
         object parameterisations (ie.  position, total intensity, peak
         intensity etc. ). SIZE indicates that the input file is a
         results file from PISAFIND, but which contains the pixel sums
         within different intensity thresholds (from the SIZES
         parameter). Finally PEAK indicates that the input is a results
         file from the PISAPEAK routine. [FIND]
      }
      \sstsubsection{
         DATA = FILENAME (Read)
      }{
         Name of the file containing the PISA results to be converted
         into a catalogue.
         [PISAFIND.DAT]
      }
      \sstsubsection{
         CAT = FILENAME (Write)
      }{
         Name of the output catalogue.
         [FIND]
      }
   }
   \sstexamples{
      \sstexamplesubsection{
         pisa2cat find pisafind.dat find
      }{
         This example converts the results file containing the object
         parameterisations from PISAFIND to FITS table format. It writes
         the results to the file find.FIT
      }
      \sstexamplesubsection{
         pisa2cat peak pisapeak.dat peak.sdf
      }{
         This example converts the output from a run of PISAPEAK into
         an HDS catalogue that can be used with the CATPAC applications.
      }
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         The output format of the catalogue can be manipulated by
            changing the file extension. Without a file extension
            a binary FITS table is produced. If you add a {\tt "}.sdf{\tt "} extension
            then an HDS catalogue that can be used by CATPAC will
            be created.
      }
   }
   \sstdiytopic{
      Column\_names
   }{
      The column names used in the output catalogues are.

      \sstitemlist{

         \sstitem
            DATATYPE = FIND \\
                 INDEX XPOS YPOS INTENSITY NPIX PEAK ELLIPT ANGLE SXX SYY SXY

         \sstitem
            DATATYPE = SIZE \\
                 INDEX A1 A2 A3 A4 A5 A6 A7 A8

         \sstitem
            DATATYPE = PEAK \\
                 INDEX RRATIO IRATIO ELLIP ABSSXY
      }
   }
}

\newpage
\sstroutine{
   PISACUT
}{
   Separates a formatted file into two parts
}{
   \sstdescription{
      This routine works on any formatted data files, applying a
      threshold to one of the variables. The variable is specified by a
      column number. File entries with variable value above and below
      the threshold are written out to separate files.
   }
   \sstusage{
      PISACUT INPUT COLUMN THRESH LOWER HIGHER
   }
   \sstparameters{
      \sstsubsection{
         INPUT = FILENAME (Read)
      }{
         Name of a file containing the data to be separated by applying
         a threshold value to the variable in the specified column.
      }
      \sstsubsection{
         COLUMN = \_INTEGER (Read)
      }{
         The column which contains the data which is to be thresholded.
         [1]
      }
      \sstsubsection{
         THRESH = \_REAL (Read)
      }{
         The threshold value for variable in the given column. Entries
         with this variable value above the threshold will be entered
         to file HIGHER. Entries with a value less than or equal to
         this variable value will be entered into file LOWER. [0.0]
      }
      \sstsubsection{
         LOWER = FILENAME (Write)
      }{
         Name of a file to contain the entries with selected variable
         value less than equal to the threshold.
      }
      \sstsubsection{
         HIGHER = FILENAME (Write)
      }{
         Name of a file to contain the entries with selected variable
         value greater than the threshold.
      }
   }
   \sstexamples{
      \sstexamplesubsection{
         PISACUT INPUT=PISAPEAK.DAT COLUMN=2 THRESH=1.5 LOWER=STARS HIGHER=GALS
         }{
            This separates the results from a run of the PISAPEAK program,
            whose results are stored in file PISAPEAK.DAT, into two
            different files STARS and GALS. The variable selected is the
            one found in column 2 (the object peakedness). Entries,
            in file PISAPEAK, with the variable value in column 2 greater
            than 1.5 are written into file GALS, those with selected
            variable value less than equal to 1.5 are written to file
            STARS.
      }
   }
}
\newpage
\sstroutine{
   PISAFIND
}{
   Locate and parameterise objects on an image frame
}{
   \sstdescription{
      PISAFIND performs image analysis on a 2-dimensional data frame.
      The program searches the data array for objects that have a
      minimum number of connected pixels above a given threshold and
      extracts the image parameters (position, intensity, shape) for
      each object. The image parameters can be determined using
      thresholding techniques or an analytical stellar profile can be
      used to fit the objects. In crowded regions deblending of
      overlapping sources can be performed.

      It is important the frame supplied to the program is clean of all
      defects and has a flat background. The data values should be in
      the range 0 to 32766.
   }
   \sstparameters{
      \sstsubsection{
         BACKGROUND = \_REAL (Read)
      }{
         The actual background value to be used. The intensities used in
         any analysis are background subtracted using this value.
         [Dynamic]
      }
      \sstsubsection{
         COMIX = \_REAL (Read)
      }{
         The mixture coefficient, as a fraction of the Gaussian peak,
         of a Lorentzian function use to model the wings of the stellar
         profile. At each point in the analytical profile the Lorentzian
         function is added to the Gaussian/exponential core scaled by
         the mixture coefficient. The profile is used to fit the data
         and the intensity is obtained by integrating under the
         profile. [Global]
      }
      \sstsubsection{
         CROSS = \_REAL (Read)
      }{
         The crossover point, as a percentage of the Gaussian peak,
         where an exponential fall-off in the analytical stellar profile
         takes over from the Gaussian core. The exponential function is
         joined on smoothly to the Gaussian. The profile is used to fit
         the data and the intensity is obtained by integrating under the
         profile. [Global]
      }
      \sstsubsection{
         DEBLEND = \_LOGICAL (Read)
      }{
         Separate overlapping images or not.

         If this is true then all objects which are connected at the
         threshold level are examined to see if they comprise more than
         one object at a higher level. If this is so the signal in the
         object is apportioned between the components and the parameters
         calculated accordingly.

         If this is false the image parameters are calculated for those
         objects which are connected at the threshold level. [TRUE]
      }
      \sstsubsection{
         GSIGM = \_REAL (Read)
      }{
         The standard deviation, in pixels, of the Gaussian core of the
         analytical stellar profile. The profile is used to fit the data
         and the intensity is obtained by integrating under the
         profile. [Dynamic]
      }
      \sstsubsection{
         IBREF = \_LOGICAL (Read)
      }{
         Perform background refinement or not if full surface modelling
         has been requested.

         If this is true then during the full surface modelling
         procedure the background is allowed to vary, over a blend of
         objects, in addition to the object{\tt '}s position and intensity, to
         best fit the data.

         If this is false then the background is held constant during
         the full surface modelling procedure. [FALSE]
      }
      \sstsubsection{
         ICIRC = \_LOGICAL (Read)
      }{
         The total intensity is to be estimated from a circular aperture
         of fixed size, or from an asymptotic curve of growth analysis.

         If this is true a fixed sized circular aperture is used. If
         this is false the total intensity is estimated from the curve
         of growth using elliptical apertures that match the shape of
         the objects. [FALSE]
      }
      \sstsubsection{
         IFULL = \_LOGICAL (Read)
      }{
         Perform full surface modelling or not when analysing profile
         intensities.

         If this is true the program examines a difference map of the
         raw data minus the fitted profiles to see if any other objects
         are present. The fitting procedure is repeated until a stable
         solution is reached. This option is very time consuming.

         If this is false the program uses the images found from an
         isophotal analysis as a basis for the profile fitting, and does
         not examine the difference map for additional objects. Some
         objects may be merged together if they are too close, or if the
         fit is better in a least squares sense. [FALSE]
      }
      \sstsubsection{
         IMNEG = \_LOGICAL (Read)
      }{
         Search for negative going images or not.

         If this is true then negative going images (those below the
         background level) will be searched for, as well as the usual
         positive going images. The same threshold and minimum
         connectivity is used for both directions. If the negative going
         images are assumed to be due to random fluctuations in the
         background then the number of negative images will indicate the
         proportion of false detections that may be present amongst the
         positive going images. Only isophotal analysis is applied to
         the negative images. Negative going images are indicated in the
         results file with minus signs in the first field.

         If this is false then only positive going images are sought.
         [FALSE]
      }
      \sstsubsection{
         IN = NDF (Read)
      }{
         An NDF data structure containing the 2-dimensional image on
         which the image analysis will be performed.
      }
      \sstsubsection{
         ISMOO = \_LOGICAL (Read)
      }{
         Smooth the data before searching for objects with the isophotal
         analysis or not.

         If this is true then the data is smoothed with a 3 x 3 Hanning
         filter before the isophotal analysis is performed. This is
         useful if the deblending is fragmenting the data too much. The
         object parameters are calculated using the unsmoothed data.

         If this is false the raw data is used for the object searches.
         [FALSE]
      }
      \sstsubsection{
         METHOD = \_INTEGER (Read)
      }{
         The type of intensity analysis to be performed on the objects.
         This is an integer code which can be one of the following
         choices :-
         \begin{description}

         \item[0 ---] Isophotal intensities. The intensity above the threshold
               is summed for each object.
         \item[1 ---] Total intensities. For each object the total intensity is
               estimated. This is done by one of two methods: A circular
               aperture of fixed size is specified and the intensity is
               summed within it. Otherwise the program automatically
               estimates the total light within an object using an
               asymptotic curve of growth analysis with elliptical
               apertures that match the shape of the object.
         \item[2 ---] Profile intensities. This uses an analytical stellar
               profile to fit the individual objects. All pixels above
               the threshold are used in the fit. The fit is made in the
               least-squares sense and the intensity is obtained from
               the integrated profile.
        \end{description}
      }
      \sstsubsection{
         MINPIX = \_INTEGER (Read)
      }{
         Minimum number of connected pixels an object needs to have to
         qualify for further analysis. Only those pixels with data
         values above the specified threshold are considered.
      }
      \sstsubsection{
         PRALL = \_LOGICAL (Read)
      }{
         Analyse the whole array or select a subset of the data.

         If this is true the whole data array is analysed. If this is
         false the pixel coordinates defining a subset of the data to be
         analysed is requested. [TRUE]
      }
      \sstsubsection{
         RCIRC = \_REAL (Read)
      }{
         The radius in pixels of the circular aperture to be used for
         the total intensity analysis.
      }
      \sstsubsection{
         RESULTS = FILENAME (Write)
      }{
         The name of the file to receive the results of the analysis.
         [PISAFIND.DAT]
      }
      \sstsubsection{
         SIZES = FILENAME (Write)
      }{
         The name of the file to receive the areal sum results.
         Note that -1. indicates that no measurement has been made
         either because the object is part of a blend, or because the
         profiling analysis has been requested. [PISASIZE.DAT]
      }
      \sstsubsection{
         THRESH = \_REAL (Read)
      }{
         The threshold above which a pixel is considered as a potential
         member of a larger object. An object has to contain a minimum
         number of connected pixels above this threshold to be accepted.
         The threshold is defined in data units above the background
         level.
      }
      \sstsubsection{
         UPLIM = \_INTEGER (Read)
      }{
         The upper limit, in data units, for a pixel to be included in
         the profile fitting procedure. If the stellar profiles are
         saturated then this can be used to constrain the profile
         fitting to the unsaturated pixels. [Dynamic]
      }
      \sstsubsection{
         XPIXS = \_INTEGER (Read)
      }{
         Initial and final pixel coordinates of the subset of the data
         array to be analysed. [Dynamic]
      }
      \sstsubsection{
         YPIXS = \_INTEGER (Read)
      }{
         Initial and final pixel coordinates of the subset of the data
         array to be analysed. [Dynamic]
      }
   }
   \sstexamples{
      \sstexamplesubsection{
         PISAFIND ARP199
      }{
         Performs image analysis on the 2-dimensional NDF data structure
         ARP199.
      }
      \sstexamplesubsection{
         PISAFIND PRALL=F
      }{
         Requests that a sub-section of the input data array is
         analysed.
      }
      \sstexamplesubsection{
         PISAFIND ISMOO=T
      }{
         Smooths the data with a Hanning filter before searching for
         objects with the isophotal analysis.
      }
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         The data input to PISAFIND can be any size (within system
         limits), however, the length of the first dimension is restricted
         to less than 10241 pixels.

         \sstitem
         The output in the RESULTS file contains the following
         information:
\begin{tabbing}
xxxxx \= xxxxxxxx \= xxxxxxxxxxxxx \= \kill
\> Column \> Name  \> Description \\
\> 1 \> INDEX \> Index number of object.\\
\> 2 \> XPOS \> X position of object in pixels.\\
\> 3 \> YPOS \> Y position of object in pixels.\\
\> 4 \> INTENSITY \> Integrated intensity of object.\\
\> 5 \> NPIX \> Number of pixels above threshold.\\
\> 6 \> PEAK \> Peak intensity of object in one pixel.\\
\> 7 \> ELLIPT \> Ellipticity of object.\\
\> 8 \> ANGLE \> Orientation of object, anti-clockwise from y-axis.\\
\> 9 \> SXX \> Second moment of data in x.\\
\> 10 \> SYY \> Second moment of data in y.\\
\> 11 \> SXY \> Cross moment of data in x and y.\\
\end{tabbing}

         \sstitem
         The output in the RESULTS file contains the following
         information:
\begin{tabbing}
xxxxx\=xxxxxxxx \= xxxxxxxxxxxxx \= \kill
\>Column \> Name  \> Description \\
\> 1 \> INDEX \> Index number of object.\\
\> 2 \> A1 \> Number of object pixels within threshold.\\
\> 3 \> A2 \> Number of object pixels within i=2 threshold.\\
\> 4 \> A3 \> Number of object pixels within i=3 threshold.\\
\> 5 \> A4 \> Number of object pixels within i=4 threshold.\\
\> 6 \> A5 \> Number of object pixels within i=5 threshold.\\
\> 7 \> A6 \> Number of object pixels within i=6 threshold.\\
\> 8 \> A7 \> Number of object pixels within i=7 threshold.\\
\> 9 \> A8 \> Number of object pixels within i=8 threshold.\\
\end{tabbing}

      The SIZES thresholds are determined by the equation. \\
      \begin{displaymath}
         I_{i} = I_{t} + 2^{(i+2)},\; i=2,8
      \end{displaymath} \\
      where $I_{t}$ is the threshold intensity.

      }
   }
}
\newpage
\sstroutine{
   PISAFIT
}{
   Fits a mixed Gaussian - Exponential - Lorentzian profile to
   STELLAR images
}{
   \sstdescription{
      PISAFIT fits a radially symmetric mixed Gaussian - Exponential -
      Lorentzian function to STELLAR type objects. The function is
      described by three separate parameters, the gaussian sigma, the
      cross over point, as a fraction of the peak intensity, from the
      gaussian core to an exponential wing and the fractional mix of a
      Lorentzian to these two functions at each point. The parameters
      describing the resultant functional fit are stored in the GLOBAL
      file and can be subsequently accessed by PISAFIND if the profile
      fitting option is chosen, or by PISAGEN for generating a model
      data frame of the detected objects. The fit produced by this
      routine is displayed on a graphics device, together with the
      residuals (derived from the variance of data contributing to
      each point), so that the quality of fit can be assessed. The
      user is prompted as to their satisfaction with the displayed fit,
      and can re-do the fit, out to a specified radius. This cycle can
      repeat until the user indicates that he is satisfied with the
      fit. Experience shows that the first fit is rarely the best.

      The fit parameters can be controlled, within certain limitations,
      by the user. Three different forms of minimisation parameter
      bounding are available. Type APM sets up the bounds so that a
      minimisation as used in the original APM specification of this
      routine can be performed. Type USER allows the user to directly
      specify the ranges within which the fitting parameters can vary,
      and type NONE freely allows the minimisation routine to fit the
      function with the only restriction that the values are greater
      than zero. Finally the user can specify that the fit is done
      using a weighted scheme, using the shown residuals.
   }
   \sstusage{
      PISAFIT IN POSITIONS [DEVICE] [LINEW] [MINMODE]
         AGAIN=? RADIUS=?
   }
   \sstparameters{
      \sstsubsection{
         AGAIN = \_LOGICAL (Read)
      }{
         Controls whether another refinement of the fit takes place or
         not. [TRUE]
      }
      \sstsubsection{
         BACKGROUND = \_REAL (Read)
      }{
         The background (sky) value. Used across whole frame. [Dynamic]
      }
      \sstsubsection{
         COMIX = \_REAL (Write)
      }{
         The value found for the mixture ratio between the Lorentzian
         and the other functions, on exit from the program.
      }
      \sstsubsection{
         COMIXRANGE = \_REAL (Read)
      }{
         The range of values between which COMIX is allowed to vary
         during the minimisation. Only used if MINMODE = USER. [0,1]
      }
      \sstsubsection{
         CROSS = \_REAL (Write)
      }{
         The value found for the percentage cross over point, from the
         gaussian core to the exponential wings, on exit from the
         program.
      }
      \sstsubsection{
         CROSSRANGE = \_REAL (Read)
      }{
         The range of values between which CROSS is allowed to vary
         during the minimisation. Only used if MINMODE = USER. [0,100]
      }
      \sstsubsection{
         DEVICE = DEVICE (Read)
      }{
         A character string specifying a valid device name.
      }
      \sstsubsection{
         GSIGM = \_REAL (Write)
      }{
         The value found for the gaussian sigma on exit from the
         program.
      }
      \sstsubsection{
         GSIGMRANGE = \_REAL (Read)
      }{
         The range of values between which GSIGM is allowed to vary
         during the minimisation. Only used if MINMODE = USER.
         [0.5,5,5]
      }
      \sstsubsection{
         IN = NDF (Read)
      }{
         The Input NDF containing the objects to be fitted.
      }
      \sstsubsection{
         LINEW = \_INTEGER (Read)
      }{
         The relative width of the lines plotted ( greater than equal
         to 1 ). [1]
      }
      \sstsubsection{
         MINMODE = LITERAL (Read)
      }{
         String defining which type of bounds are to be applied to the
         minimisation parameters. The allowed returns are any string
         beginning with the characters {\tt '}A{\tt '},{\tt '}U{\tt '} or {\tt '}N{\tt '}. These represent
         {\tt '}A{\tt '}PM (default) {\tt '}U{\tt '}SER or {\tt '}N{\tt '}ONE. If return is APM then the
         bounds for the minimisation are as in the original APM version
         of this routine (0.5 to 5.5 for GSIGM, 0.0 to 1.0 for CROSS
         and 0.0 to approximately 0.12 for COMIX). If the return
         selects USER then the user will be prompted for the limitations
         to be applied during the minimisation. If the returns selects
         NONE then the parameters will be allowed to vary to any value
         greater than 0.0. [APM]
      }
      \sstsubsection{
         POSITIONS = FILENAME (Read)
      }{
         ASCII file containing the positions of the objects to be
         fitted. The file may be of the type produced by PISAFIND or
         just of list of either
         \begin{description}
            \item Object-number  X-position  Y-position etc.,
         \end{description}
         or
         \begin{description}
            \item X-position  Y-position.
         \end{description}
         [PISAFIND.DAT]
      }
      \sstsubsection{
         PRALL = \_LOGICAL (Read)
      }{
         Analyse the whole array ( to derive the background value )
         or select a subset of the data.

         If this is true the whole data array is analysed. If this is
         false the pixel coordinates defining a subset of the data to be
         analysed are requested. [TRUE]
      }
      \sstsubsection{
         RADIUS = \_REAL (Read)
      }{
         The radius out to which the fit will be attempted. This should
         be at least a few stellar radii. [10.0]
      }
      \sstsubsection{
         WEIGHTED = \_LOGICAL
      }{
         Set to true if a weighted fit is to be attempted. The weighting
         is based on the distribution of errors of values contributing
         to a bin in the mean profile. Note that under certain
         conditions weighting can seem to bias fit unfairly to the
         central bins (usually seen as a very poor fit to the outer
         values). If this situation occurs then an unweighted fit is
         the best option. [FALSE]
      }
      \sstsubsection{
         XPIXS = \_INTEGER (Read)
      }{
         Initial and final pixel coordinates of the subset of the data
         array to be analysed. [Dynamic]
      }
      \sstsubsection{
         YPIXS = \_INTEGER (Read)
      }{
         Initial and final pixel coordinates of the subset of the data
         array to be analysed. [Dynamic]
      }
   }
   \sstexamples{
      \sstexamplesubsection{
         PISAFIT FRAME FRAME.STARS\_ACC CANON\_PORTRAIT 3 NONE AGAIN=F
                 RADIUS=15
      }{
         Performs the radial fit on the stars contained in the list
         FRAME.STARS\_ACC. It directs the graphical output to a laser
         printer whose lines are printed at three times normal density.
         The bounds on the minimisation are freed to be any value
         greater than 0. The interactive, recursive, fitting loop is
         disabled by setting AGAIN=F and the fit is done out to a
         radius of 15 pixels.
      }
      \sstexamplesubsection{
         PISAFIT FRAME FRAME.STARS\_ACC
      }{
         Performs the production of the radial profile. Enters into an
         interactive session allowing the user to modify the radius of
         the data used in the fit.
      }
   }
   \sstnotes{
      The potential quality of the fit is very dependent on the objects
      chosen to produce the radial profile. The best results should be
      obtained from a range of unsaturated, well separated objects. The
      list of objects used for the fit can be passed directly from
      PISAFIND or by a list of object x,y positions produced by the
      user, say by using the KAPPA routine CENTROID. Note that any
      input lists of the latter type should be of the form
      object\_number, X\_position, Y\_position in the first
      three columns or X\_position, Y\_position ) only. This means
      that output from many KAPPA routines will require editing.
   }
   \sstdiytopic{
      Timing
   }{
      The timing for the initial processing (i.e. radial profile
      production) is proportional to the number of objects given.
      The latter processing (the fitting loop) is dependent only on
      the number of points in the fit .
   }
   \sstdiytopic{
      Functional Forms
   }{
      The basic functional forms of the fitting equations are described in
      appendix \ref{funcparms}.

   }
   \sstimplementationstatus{
      The present status of the program has 4 main drawbacks.
      \begin{itemize}

       \item The data must lie within the range of signed word reasonably
       approximated by integers.

       \item There is no bad pixel handling.

       \item The input arrays cannot be any larger than 10240 pixels in
       any axis.

       \item A maximum of 1000 input objects is allowed.
      \end{itemize}
   }
}
\newpage
\sstroutine{
   PISAGEN
}{
   Generates a frame of model objects
}{
   \sstdescription{
      PISAGEN generates objects using the PISA profile model function.
      Input data are a list which should have been generated by
      PISAFIND in the profiling mode, or be of the same general form,
      for at least the first four columns (i.e. index, X position,
      Y position and integrated intensity).  An optional input frame
      can be given, this is used to determine the size of the output
      frame. If this is not given then the input list is scanned to
      generate a suitable default size for the output frame. The
      output objects from PISAGEN can have the flux within each pixel
      integrated to give a improved estimate of the actual flux.

      The PISA profiling function model parameters can be read from
      GLOBAL parameters as set up by the program PISAFIT. Additional
      parameters allow the output stars to be elliptical. The model may
      be generated on a background value and can be saturated. Noise
      can be added to the data to simulate real data for test purposes.
   }
   \sstusage{
      PISAGEN INPUT POSITIONS OUTPUT GSIGM CROSS COMIX NOISE
        \newline\hspace*{1.5em}
        $\left\{ {\begin{tabular}{l}
                                      ADU=? \\
                                      SIGMA=? \\
                  \end{tabular} }
        \right.$
        \newline\hspace*{1.9em}
        \makebox[0mm][c]{\small method}
   }
   \sstparameters{
      \sstsubsection{
         ADU = REAL (Read)
      }{
         The scaling factor to convert the data output values into
         counts for which Poisson statistics are required.  This is the
         analogue to data units conversion factor for unmodified CCD
         frames. [1.0]
      }
      \sstsubsection{
         ANGLE = \_REAL (Read)
      }{
         The positional angle of the major axis of the stellar ellipses
         measured in degrees anti-clockwise from the y-axis
         (ie. as per PISAFIND). [0.0]
      }
      \sstsubsection{
         BACKGROUND = \_REAL (Read)
      }{
         The background value for the output frame. [0.0]
      }
      \sstsubsection{
         COMIX = \_REAL (Read)
      }{
         The mixture coefficient, as a fraction, which defines how the
         Lorentzian function, at each point in the analytical profile
         is added to the Gaussian or Exponential. [Global]
      }
      \sstsubsection{
         CROSS = \_REAL (Read)
      }{
         The crossover point, as a percentage of the Gaussian peak,
         where an exponential fall-off in the analytical stellar
         profile takes over from the Gaussian core. The exponential
         function is joined on smoothly to the Gaussian. [Global]
      }
      \sstsubsection{
         ELLIP = \_REAL (Read)
      }{
         The ellipticity of the output objects. [0.0]
      }
      \sstsubsection{
         GSIGM = \_REAL (Read)
      }{
         The standard deviation, in pixels, of the Gaussian core of the
         analytical stellar profile. [Global]
      }
      \sstsubsection{
         INPUT = NDF (Read)
      }{
         An NDF containing a data array which is the same size as the
         required output data array.
      }
      \sstsubsection{
         NOISE = LITERAL (Read)
      }{
         The noise contribution to be added to output data. Can be
         Poisson, Gaussian or None. [NONE]
      }
      \sstsubsection{
         NSIGMA = \_REAL (Read)
      }{
         The number of gaussian sigma to generate the output objects
         to. [10.0]
      }
      \sstsubsection{
         OUTPUT = NDF (Write)
      }{
         The output NDF to contain the model objects.
      }
      \sstsubsection{
         POSITIONS =  FILENAME (Read)
      }{
         Input list of star positions and intensities (see
         description). [PISAFIND.DAT]
      }
      \sstsubsection{
         SAT = \_REAL (Read)
      }{
         The saturation value for output stars. [32767]
      }
      \sstsubsection{
         SCALE = \_INTEGER (Read)
      }{
         if scale is greater than one then each output object pixel
         value is determined by the integration of the function values
         at scale$*$scale equidistant parts within the pixel. This
         simulates an integration of the flux within each pixel. Using
         this option increases the accuracy of the output pixel
         intensities, this may be important in areas with large
         intensity gradients. [Dynamic]
      }
      \sstsubsection{
         SIGMA = REAL (Read)
      }{
         The standard deviation of the Gaussian noise contribution.
         [1.0]
      }
      \sstsubsection{
         TITLE = LITERAL (Read)
      }{
         Title for the output frame. [Output from PISAGEN]
      }
      \sstsubsection{
         XHIGH = \_INTEGER (Read)
      }{
         If an input frame is not given then this value defines the
         upper limit of the output data array X-axis. [Dynamic]
      }
      \sstsubsection{
         XLOW = \_INTEGER (Read)
      }{
         If an input frame is not given then this value defines the
         origin of the output data array X-axis. [Dynamic]
      }
      \sstsubsection{
         YHIGH = \_INTEGER (Read)
      }{
         If an input frame is not given then this value defines the
         upper limit of the output data array Y-axis. [Dynamic]
      }
      \sstsubsection{
         YLOW = \_INTEGER (Read)
      }{
         If an input frame is not given then this value defines the
         origin of the output data array Y-axis. [Dynamic]
      }
   }
   \sstexamples{
      \sstexamplesubsection{
         PISAGEN INPUT=FRAME POSITIONS=FRAME.STARS\_ACC
                 OUTPUT=STARS BACKGROUND=100.0 SAT=32767
                 NOISE=NONE
      }{
         Generates an output NDF STARS of the same size as FRAME. The
         objects are placed at the positions defined in
         FRAME.STARS\_ACC. The model parameterisations are accessed
         as the global parameters PISA\_GSIGM,
         PISA\_CROSS and PISA\_COMIX, these values were probably
         generated by PISAFIT.
      }
   }
   \sstimplementationstatus{
      This program will not handle bad pixels.
   }
}
\newpage
\sstroutine{
   PISAGREY
}{
   Plots an NDF as a greyscale
}{
   \sstdescription{
      This routine displays a greyscale representation of the data
      component of an NDF.
   }
   \sstparameters{
      \sstsubsection{
         ABSLAB  =  LITERAL (Read)
      }{
         Label for the plot abscissa, may include PGPLOT escape
         sequences.  This parameter is only used when the axes option
         is selected. [X]
      }
      \sstsubsection{
         AXES = \_LOGICAL (Read)
      }{
         True if annotated axes are to be drawn around the displayed
         image. This parameter is ignored in the overlay mode, since
         there is no guarantee that the axes would lie entirely
         within the current picture. [TRUE]
      }
      \sstsubsection{
         DEVICE = DEVICE (Read)
      }{
         The name of the graphics device on which to plot the map
         of images found. If the overlay mode is required it is
         recommended that the image be displayed in KAPPA on an
         image display{\tt '}s base plane, then run this application using
         the device{\tt '}s overlay plane. [Current graphics device]
      }
      \sstsubsection{
         MAJTIC( 2 ) = \_REAL (Read)
      }{
         The parameter controlling the numbers of major tick marks for
         the x and y axes.  A negative value for an axis makes the
         graphics package decide an appropriate value.  This parameter
         is only used when the axes option is selected. [-1.,-1.]
      }
      \sstsubsection{
         MINTIC( 2 ) = \_INTEGER (Read)
      }{
         The number of minor tick marks between each major tick mark
         for the x and y axes.  A negative value forces the graphics
         package to compute appropriate values.   This parameter is
         only used when the axes option is selected. [-1.,-1.]
      }
      \sstsubsection{
         ORDLAB  =  LITERAL (Read)
      }{
         Label for the plot ordinate, may include PGPLOT escape
         sequences.  This parameter is only used when the axes option
         is selected. [Y]
      }
      \sstsubsection{
         OUTTIC = \_LOGICAL (Read)
      }{
         True if the axis tick marks are to appear on the outside of
         the axes instead of inside.   This parameter is only used
         when the axes option is selected. [TRUE]
      }
      \sstsubsection{
         PLTITL = CHAR (Read)
      }{
         The title of the plot, may include PGPLOT escape sequences.
         Up to about 40 characters can be accommodated.  This parameter
         is only used when axes option is selected. [PISAGREY]
      }
      \sstsubsection{
         XPIXS = \_REAL (Read)
      }{
         Initial and final pixel coordinates of plot in x-direction.
      }
      \sstsubsection{
         YPIXS = \_REAL (Read)
      }{
         Initial and final pixel coordinates of plot in y-direction.
      }
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         UNIX specific. Only supplied on UNIX machines
      }
   }
}
\newpage
\sstroutine{
   PISAKNN
}{
   Uses the results of PISAPEAK to discriminate objects
   into two classes
}{
   \sstdescription{
      PISAKNN uses KNN (k nearest neighbours) distribution-free
      multivariate discrimination to classify objects into two classes.
      The classes are seeded by supplying two files which contain the
      indices of objects typical to the class in question ($>$5,
      approximately equal numbers of each). Each object then propagates
      its class to the other objects on the basis of which class of the
      2$*$k nearest neighbours (in the parameter space of the PISAPEAK
      results) of each of the unclassified objects is most common. This
      procedure is iterated until all objects are assigned and have a
      stable class or until a maximum number of iterations is exceeded.
      The results of the discrimination are written into two output
      files, one for each class.
   }
   \sstusage{
      PISAKNN PEAKDATA SEED1 SEED2 K CLASS1 CLASS2 NITER
   }
   \sstparameters{
      \sstsubsection{
         CLASS1 = FILENAME (Write)
      }{
         Name of a file to contain the indices of the objects selected
         for membership of class 1. [CLASS1.DAT]
      }
      \sstsubsection{
         CLASS2 = FILENAME (Write)
      }{
         Name of a file to contain the indices of the objects selected
         for membership of class 2. [CLASS2.DAT]
      }
      \sstsubsection{
         ELLIP = \_LOGICAL (Read)
      }{
         If `true{\tt '} then the ellipticities are used in the analysis. If
         `false{\tt '} then they are excluded. Using ellipticities may
         increase the weighting of some (small) round galaxies as
         stars. [TRUE]
      }
      \sstsubsection{
         K = \_INTEGER (Read)
      }{
         The number of nearest neighbours about the current values
         which are to be used in classifying an object. The class
         used is the most frequently encountered in this range of
         objects. If classes 1 and 2 are equally frequent then the
         object classification is not changed. [1]
      }
      \sstsubsection{
         NITER = \_INTEGER (Read)
      }{
         The maximum number of iterations allowed to classify and
         reclassify objects. [10]
      }
      \sstsubsection{
         PEAKDATA = FILENAME (Read)
      }{
         Name of a file containing the results of the PISAPEAK
         parameter transformation. This file must contain at least
         five columns which have the values:
         \begin{itemize}
         \item object index
         \item radius ratio
         \item intensity-peak ratio
         \item ellipticity
         \item absolute value of intensity weighted cross moment
         \end{itemize}
         in that order. [PISAPEAK.DAT]
      }
      \sstsubsection{
         SEED1 = FILENAME (Read)
      }{
         Name of a file containing the indices of the objects to seed
         class1. The file can contain any number of columns but must
         have the object indices in column one. [SEED1.DAT]
      }
      \sstsubsection{
         SEED2 = FILENAME (Read)
      }{
         Name of a file containing the indices of the objects to seed
         class2. The file can contain any number of columns but must
         have the object indices in column one. [SEED2.DAT]
      }
   }
   \newpage
   \sstexamples{
      \sstexamplesubsection{
         PISAKNN PISAPEAK S1 S2 3 C1 C2 5
      }{
         This performs a KNN analysis on file PISAPEAK, using the
         indices in files S1 and S2 as seeds for classes 1 and 2
         respectively. The new classifications are assigned using the
         nearest 6 neighbours (2K). The maximum number of iterations
         allowed is 5. After the maximum number of iterations is
         exceeded or the classifications become stable the indices of
         the class 1 objects are written to file C1 and class 2 to C2.
      }
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         The seed objects are always returned in their initial classes.

         \sstitem
         The maximum number of objects allowed in any input file is
            10000
      }
   }
}
\newpage
\sstroutine{
   PISAMATCH
}{
   Matches the indices in one file against those in a second file
}{
   \sstdescription{
      This routine matches the first column of values (the object
      indices) of the two input files. When a match is located between
      the indices the complete entry in the second file is copied to the
      output file. It is intended primarily to match a list of object
      indices (such as those produced by PISAKNN or possibly a PISACUT
      list of PISAPEAK results).
   }
   \sstusage{
      PISAMATCH ONE TWO OUT
   }
   \sstparameters{
      \sstsubsection{
         ONE = FILENAME (Read)
      }{
         Name of the file containing the indices to match to those of
         file TWO.
      }
      \sstsubsection{
         TWO = FILENAME (Read)
      }{
         Name of the file containing the entries whose indices are to be
         matched to those of file ONE. Entries with a matched index will
         be written to file OUT.
      }
      \sstsubsection{
         OUT = FILENAME (Write)
      }{
         Name of a file to contain the entries from file TWO which have
         the same indices as those specified in file ONE.
         [PISAMATCH.DAT]
      }
   }
   \sstexamples{
      \sstexamplesubsection{
         PISAMATCH CLASS1 PISAFIND STARS
      }{
         This matches the indices in file CLASS1 to those of file
         PISAFIND. The PISAFIND entries with indices found in file
         CLASS1 are written to file STARS.
      }
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         The maximum number of entries allowed in file ONE is 10000. No
         restriction applies to file TWO.

         \sstitem
         The indices in both files must be in the first column.
      }
   }
}
\newpage
\sstroutine{
   PISAPEAK
}{
   Transforms the PISAFIND parameterisations so that the
   variables are intensity invariant
}{
   \sstdescription{
      PISAPEAK reads in the object parameterisations file produced by
      PISAFIND. Using the PISA profiling function it then transforms
      certain of the variables into values which are intensity
      invariant for a radial stellar profile. Two of the output
      variables may have values of around 1.0 for objects which are
      well represented by the given PISA profiling parameters. The
      variables produced are the ratio of the semi-major axis of the
      object fit to the radius of an object whose peak intensity is the
      same, but whose size is determined by the PISA profiling function
      (a peakedness measure). The ratio of the integrated intensity to
      the peak intensity and the model object ratio. The ellipticity
      (unmodified) and the absolute value of the intensity weighted
      cross moment (ABS(SXY)).

      The output from PISAPEAK can be used in star-galaxy separation,
      either by applying direct cuts in variable values or by
      discrimination analysis routines such as PISAKNN.
   }
   \sstusage{
      PISAPEAK IN FINDDATA RESULTS GSIGM CROSS COMIX BACKGROUND THRESH
   }
   \sstparameters{
      \sstsubsection{
         BACKGROUND = \_REAL (Read)
      }{
         The frame background value (sky) as used by PISAFIND. [Global]
      }
      \sstsubsection{
         COMIX = \_REAL (Read)
      }{
         The mixture coefficient, as a fraction of the Gaussian peak,
         of a Lorentzian function used to model the wings of the stellar
         profile. At each point in the analytical profile the Lorentzian
         function is added to the Gaussian/exponential core scaled by
         the mixture coefficient. [Global]
      }
      \sstsubsection{
         CROSS = \_REAL (Read)
      }{
         The crossover point, as a percentage of the Gaussian peak,
         where an exponential fall-off in the analytical stellar profile
         takes over from the Gaussian core. The exponential function is
         joined on smoothly to the Gaussian. [Global]
      }
      \sstsubsection{
         FINDDATA = FILENAME (Read)
      }{
         Name of the file containing the PISAFIND parameterisations.
         [PISAFIND.DAT]
      }
      \sstsubsection{
         GSIGM = \_REAL (Read)
      }{
         The standard deviation, in pixels, of the Gaussian core of the
         analytical stellar profile. [Global]
      }
      \sstsubsection{
         IN = NDF (Read)
      }{
         The NDF containing the objects which have been parameterised by
         PISAFIND.
      }
      \sstsubsection{
         RESULTS = FILENAME (Write)
      }{
         Name of a file to contain the PISAPEAK results. [PISAPEAK.DAT]
      }
      \sstsubsection{
         THRESH = \_REAL (Read)
      }{
         The detection threshold as used by PISAFIND. [Global]
      }
   }
   \sstexamples{
      \sstexamplesubsection{
          PISAPEAK IN=FRAME FINDDATA=PISAFIND.DAT
          RESULTS=PISAPEAK.DAT BACKGROUND=255 THRESH=12
      }{
         This example shows PISAPEAK using the objects found in NDF
         FRAME with parameters stored in file PISAFIND.DAT. The results
         are stored in file PISAPEAK.DAT. Note that the model parameters
         GSIGM CROSS and COMIX are defaulted to those which have been
         stored in GLOBAL. These values were probably written by the
         routine PISAFIT which uses a list of stars to fit the PISA
         profiling function. The background value and threshold are
         those used by PISAFIND when detecting and parameterising the
         objects.
      }
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         The model profile is used to scale the object values to those
         around unity. This only works well if the PISA profiling function
         is a good fit to the stars on your frame. If it is not a good fit
         or you cannot determine the model parameters then inaccurate
         values can be used, the only criterion being that the GSIGM value
         is about the FWHM seeing of your data. The results file will now
         contain values {\tt '}normalised{\tt '} to this {\tt '}imaginary{\tt '} object. The stars
         will still form a group of objects with similar values, although
         they will not be as tightly clustered as with a good fit.
      }
   }
}
\newpage
\sstroutine{
   PISAPLOT
}{
   Plots an ellipse map of the objects found by PISAFIND
}{
   \sstdescription{
      This application shows the positions, shapes and sizes of the
      objects located by PISAFIND via a plot of ellipses, one per
      object. Optional annotation of the ellipses provide
      cross-referencing with the object list. The plot may be overlaid
      on an existing image for a direct comparison. In this case the
      plot appears within the last DATA picture in the graphics
      database, otherwise it is situated within the current picture.

      Control of the plot allows labelled axes whose extent may be
      defined and the selection of the colour of the ellipses
   }
   \sstparameters{
      \sstsubsection{
         ABSLAB  =  LITERAL (Read)
      }{
         Label for the plot abscissa, may include PGPLOT escape
         sequences.  This parameter is only used when the axes option
         is selected. [X]
      }
      \sstsubsection{
         ANNOTA = \_LOGICAL (Read)
      }{
         If true the ellipses are annotated with the object
         identification number to the top right. [TRUE]
      }
      \sstsubsection{
         ANNOSCALE = REAL (Read)
      }{
         The scale height of the annotations. This value is a multiple
         of the normal text height. [1.0]
      }
      \sstsubsection{
         AXES = \_LOGICAL (Read)
      }{
         True if annotated axes are to be drawn around the displayed
         image. This parameter is ignored in the overlay mode, since
         there is no guarantee that the axes would lie entirely
         within the current picture. [TRUE]
      }
      \sstsubsection{
         CLEAR = \_LOGICAL (Read)
      }{
         True if the device is to be cleared first when in overlay mode.
         Useful if displaying different classes of objects successively.
         This flag acts as a switch retaining its last value. [FALSE]
      }
      \sstsubsection{
         DEFAXES = \_LOGICAL (Read)
      }{
         If set true then prompting for the axis bounds will occur,
         otherwise the program generated defaults will be used. [FALSE]
      }
      \sstsubsection{
         DEVICE = DEVICE (Read)
      }{
         The name of the graphics device on which to plot the map
         of images found. If the overlay mode is required it is
         recommended that the image be displayed in KAPPA on an
         image display{\tt '}s base plane, then run this application using
         the device{\tt '}s overlay plane. [Current graphics device]
      }
      \sstsubsection{
         MAJTIC( 2 ) = \_REAL (Read)
      }{
         The parameter controlling the numbers of major tick marks for
         the x and y axes.  A negative value for an axis makes the
         graphics package decide an appropriate value.  This parameter
         is only used when the axes option is selected. [-1.,-1.]
      }
      \sstsubsection{
         MINTIC( 2 ) = \_INTEGER (Read)
      }{
         The number of minor tick marks between each major tick mark
         for the x and y axes.  A negative value forces the graphics
         package to compute appropriate values.   This parameter is
         only used when the axes option is selected. [-1.,-1.]
      }
      \sstsubsection{
         ORDLAB  =  LITERAL (Read)
      }{
         Label for the plot ordinate, may include PGPLOT escape
         sequences.  This parameter is only used when the axes option
         is selected. [Y]
      }
      \sstsubsection{
         OUTTIC = \_LOGICAL (Read)
      }{
         True if the axis tick marks are to appear on the outside of
         the axes instead of inside.   This parameter is only used
         when the axes option is selected. [TRUE]
      }
      \sstsubsection{
         OVERLAY = \_LOGICAL (Read)
      }{
         True if the plot is to be overlaid on the last DATA picture
         in the graphics database.  This is used to compare a displayed
         2-d image with the objects detected. This flag acts as a switch
         retaining its last value. [FALSE]
      }
      \sstsubsection{
         PALNUM = \_INTEGER (Read)
      }{
         PISAPLOT allows the user to specify which pen number to use
         when plotting. Thus different classifications of objects can
         be identified on the same plot using different colours. The
         colours associated with these pens are the default PGPLOT
         pens (see the PGPLOT manual for a complete description).
         These are:
         \begin{description}
          \item [0] background colour
          \item [1] foreground colour
          \item [2] red
          \item [3] green
          \item [4] blue
          \item [5] cyan
          \item [6] magenta
          \item [7] yellow
          \item [8] orange
         \end{description}
         and so on up to pen 16 (up to the number available on the
         current graphics device). After PISAPLOT has been run these
         colours can be superseded by using the KAPPA palette
         facilities PALDEF and PALENTRY, but note that any subsequent
         runs of PISAPLOT will reinstate the PGPLOT default colours so
         using the KAPPA facilities should be delayed until all object
         classifications have been displayed. The KAPPA palette pen
         numbers correspond to PALNUM values (hence the parameter name).
         [3]
      }
      \sstsubsection{
         PLTITL = CHAR (Read)
      }{
         The title of the plot, may include PGPLOT escape sequences.
         Up to about 40 characters can be accommodated.  This parameter
         is only used when axes option is selected. [Images Detected]
      }
      \sstsubsection{
         RESULTS = FILENAME (Read)
      }{
         The ASCII file produced by the PISAFIND application containing
         the parameterised data for the various objects it detected.
         [PISAFIND.DAT]
      }
      \sstsubsection{
         THICK = \_REAL (Read)
      }{
         The thickness of the lines in the plot, where 1.0 is the
         normal thickness. It should be between 0.5 and 5. This
         feature is only available on some devices. This parameter is
         only used when axes option is selected. [1.0]
      }
      \sstsubsection{
         XPIXS = \_REAL (Read)
      }{
         Initial and final pixel coordinates of plot in x-direction.
         [Dynamic]
      }
      \sstsubsection{
         YPIXS = \_REAL (Read)
      }{
         Initial and final pixel coordinates of plot in y-direction.
         [Dynamic]
      }
   }
   \sstexamples{
      \sstexamplesubsection{
         PISAPLOT OVERLAY
      }{
         Using the overlay parameter allows ellipses to be plotted over
         a previously displayed image.
      }
      \sstexamplesubsection{
         PISAPLOT OVERLAY CLEAR
      }{
         Including the clear parameters clears a plot before overlaying.
         This is useful when displaying the overlaid ellipses in an
         overlay.
      }
      \sstexamplesubsection{
         PISAPLOT RESULTS=STARS.DAT PALNUM=3 OVERLAY
      }{
         Using this combination of parameters would use a green pen to
         plot the ellipse overlaying them on the displayed picture.
         Using sequences of this example with difference results files
         and palnums would result in a display which had different
         colours for each results file displayed over the current
         picture.
      }
   }
   \sstnotes{
      \sstitemlist{

         \sstitem
         The following pictures are stored in the graphics database: a
         FRAME encompassing annotated axes and the plot itself, provided
         the overlay option is not selected; a DATA picture for the plot
         itself.  The latter uses the standard Starlink co-ordinate
         system.
      }
   }
}
\normalsize

\newpage
\section{The PISA profiling function}
\label{funcparms}
The PISA profiling function is made up of three functions, a Gaussian,
an exponential and a Lorentzian. Inside a radius $R_{c}$
fixed proportions of the Gaussian and Lorentzian functions are used,
outside of $R_{c}$ the exponential replaces the Gaussian and
is added to the continuing Lorentzian. The exponential is joined
smoothly to the Gaussian. Inside of $R_{c}$ the function
takes the form:-

\begin{displaymath}
\begin{array}{c}
 1\\
 \overline{\pi\sigma^{2}(1+(\frac{\tau}{2\ln(\frac{1}{\tau})}))}
\end{array}
    \left( \begin{array}{c} Q \\
    \overline{(1+\frac{r^{2}}{\sigma^{2}\ln(2)} )}\\
    \end{array}
      \begin{array}[b]{c}
         + (1-Q)\exp(\frac{-r^{2}}{\sigma^{2}})\\
      \end{array} \right) \\
\end{displaymath}
and outside of $R_{c}$ it takes the form:-
\begin{displaymath}
\begin{array}{c}
 1\\
 \overline{\pi\sigma^{2}(1+(\frac{\tau}{2\ln(\frac{1}{\tau})}))}
\end{array}
    \left( \begin{array}{c} Q \\
    \overline{(1+\frac{r^{2}}{\sigma^{2}\ln(2)} )}\\
    \end{array}
      \begin{array}{cc}
         +\underline{(1-Q)\exp(\frac{-2r}{\sigma}\sqrt{\ln(\frac{1}{\tau}}))}\\
          \tau\\
      \end{array} \right) \\
\end{displaymath}

where:-
\begin{description}
\item[$\tau=$] the fraction of the peak intensity at which to change
from the gaussian to an exponential function (CROSS/100),
\item[$\sigma=$] the gaussian function sigma (GSIGM),
\item[$Q=$] the fraction of the Lorentzian function to add to the
gaussian or exponential function at each point (COMIX).
\end{description}

The radius at which the exponential replaces the gaussian is:-
\begin{displaymath}
   R_{c}=\sigma\sqrt{\ln(\frac{1}{\tau})}
\end{displaymath}

The actual function is that which when multiplied by the {\bf
integrated} intensity gives the intensity at the given radius. Basically the
functional forms from which the above equations are derived are:-
\begin{description}
\item Gaussian --- $\exp(\frac{-r^{2}}{\sigma^{2}})$

\item Lorentzian --- $1/(1+\frac{r^{2}}{\sigma^{2}})$

\item Exponential --- $\exp(-(\frac{r-R_{c}}{\sigma}))$.
\end{description}

\section{Limitations}

The PISA package has various in-built limitations (buffer sizes etc.), This
section details them; if they cause real problems then contact the supporter of
this package.

\begin{itemize}
   \item \iref{PISAFIND}
   \begin{itemize}
      \item The number of fragments per image (i.e. connected pixel groups)
            is limited to 200. Hence blends of objects cannot fragment into
            more than 200 pieces.
      \item The number of pixels per image allowed during surface modelling
            is 10000.
      \item The length of the first side of input image cannot be more than
            10240 pixels.
      \item The input data is processed using an HDS type of \_WORD so the input
            data range must lie within the bounds -32768 to +32767,
            although \iref{PISAFIND} itself only processes positive data up to
            the value 32766. This limitation is fundamental.
      \item There are no other known restrictions. Input NDFs are now accessed
            via file mapping. There is no restriction on the number of detected
            objects.
    \end{itemize}
    \item PISAFIT
    \begin{itemize}
       \item As in \iref{PISAFIND} the length of first side of the input image
             has to be less than 10240 pixels.
       \item The input data is processed using an HDS type of \_WORD so the input
             data range must lie within the bounds -32768 to +32767.
    \end{itemize}
    \item \iref{PISAMATCH}
    \begin{itemize}
       \item The maximum number of input records is 10000.
    \end{itemize}
    \item \iref{PISAKNN}
    \begin{itemize}
       \item The maximum number of input records is 10000.
    \end{itemize}
\end{itemize}

\section{Changes in release: 2.3-0}

\begin{itemize}
  \item The PISAFIND application has been changed so that the ISMOO
        parameter works as described. Previously detection was always
        based on smoothed data. This change may increase the number of
        falsely detected objects.
  \item A new application \iref{PISA2CAT} has been introduced. This
        allows any of the PISA results files to be converted into
        catalogues that can be used by the CURSA and CATPAC packages.
  \item A bug in the \iref{PISA2ARD} application has been fixed. This
        produced incorrect orientations for the ellipses.
\end{itemize}

\section{Changes in release: 2.4-0}

\begin{itemize}
   \item PISA no longer relies on any NAG routines. This changes the 
    applications \iref{PISAGEN}, \iref{ADDNOISE}, \iref{PISAKNN} and 
    \iref{PISAFIT}. There should be no significant effects due to
    these changes. NAG removal has been performed to allow PISA to run
    on Linux based PCs.

    \item SUN/109 has been changed to show the
     \htmlref{formulae}{RESULTS} involved in the calculation of the 
     image moments and ellipticity.
\end{itemize}

\section{Changes in release: 2.4-1}

\begin{itemize}
    \item SUN/109 has been changed to show the correct formulae
    for the calculation of the semi-major and semi-minor axes of the
    object ellipse (these were incorrectly shown as $a$ and $b$,
    rather than $a^{2}$ and $b^{2}$). Formulae have also been added 
    showing how to calculate these values out to the detection isophote.
\end{itemize}

\end{document}
% $Id$
