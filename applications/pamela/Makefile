##################################################################
#
# Makefile for ndf version of pamela
#
# 20/11/2009 -- for a while now pamela changes have been handled
# with 'git' so I no longer record changes here.
#
#################################################################
#
# Main targets of this makefile:
#
#    all    -- makes everything you need - pamela, links, pamela_aliases, help
#    pamela -- compiles and links pamela monolith
#    links  -- sets up soft links defining commands.
#    pamela_aliases -- makes script of aliases
#    help   -- uses a perl script to write out html help files
#    clean  -- gets rid of files generated by make.
#    tar    -- makes export tar file
#
#  just 'make' is equivalent to 'make all'
#
###########################################################
#
# To install, you must have STARLINK and have defined the standard environment
# variable STARLINK_DIR required by the JAC release.
#
# You may want to change any/all of these:
#
#  INSTALL    -- installation directory.
#  F77        -- F77 compiler. Should be either g95 or gfortran, depending
#                upon what your starlink installation was compiled with.
#  FFLAGS     -- any special flags for the compiler
#
# Then type 'make' if it is the first time, 'make clean', 'make'
# if you want to completely recompile & reinstall.
#
# At the end, if you are successful, you will get a message 
# telling you how to start pamela. Type "make message" to see it again.

DATE        = $(shell date)
EXPORT_DATE = $(shell cat .export_date)

CURRENT     = $(shell git tag | tail -n 1)
PREVIOUS    = $(shell git tag | tail -n 2 | head -n 1)


INSTALL    = $(TRM_SOFTWARE)/pamela
STAR       = $(STARLINK_DIR)
FC         = g95
FFLAGS     = -Wall -Wno=155 -O -fno-second-underscore -fstatic -I$(STAR)/include
#FC         = gfortran
#FFLAGS     = -Wall -O -fno-second-underscore -fno-automatic -fno-range-check -I$(STAR)/include

# Command search path
PATH      := $(STAR)/bin:${PATH}

# PDA, ADAM/NDF libraries

PDA       = -L$(STAR)/lib   `pda_link`
ADAM_NDF  = -L$(STAR)/lib   `ndf_link_adam`
PGPLOT    = -L$(STAR)/lib   `pgplot_link`

# leave next blank if you have a system libcurses.so
CURSES    = -L$(TRM_SOFTWARE)/lib

# Archive. All object files are stored in this archive for
# speed of later re-compilation. Several similar rules are
# defined to access the various diectories.

ARCH    = pamela
LARCH   = $(INSTALL)/lib$(ARCH).a

$(LARCH)(%.o): src/%.f
	$(FC) $(FFLAGS) -c $< -o $%
	ar cr $@ $%
	rm -f $%

########################################################################
#
# Default target

all: dir links pamela pamela_aliases help message

.PHONY: all dir links pamela help pamela_aliases clean scripts tar message changes

# List of routines needed

PAMELA_OBJ = $(LARCH)(pplot.o track.o get_point.o cdf_loc.o \
             faker.o regpic.o get_lim.o skyfit.o chance.o \
             extnor.o xlims.o extopt.o varsky.o lsquar.o \
             poly.o pglimit.o noise.o ludcmp.o polyfit.o \
             qfactor.o gammln.o plotfit.o pgstart.o pgstop.o \
             pgsetlims.o idtype.o skymov.o profit.o optext.o \
             recomp.o skew.o polfit.o splnfit.o splfit.o heapsort.o \
             picstat.o median.o rebin.o medprf.o medfilt.o ran.o \
             ifind.o shellsort.o medval.o chsubs.o reject.o gauss.o \
             nist.o get_track.o)

# make installation directories

dir:
	-\mkdir $(INSTALL)
	-\mkdir $(INSTALL)/html

# Main targets

pamela: src/pamela.f $(PAMELA_OBJ)
	@which alink pda_link ndf_link_adam
	$(FC) $(FFLAGS) -c -o pamela.o src/pamela.f
	alink pamela.o -o $(INSTALL)/pamela -L$(INSTALL) $(PGPLOT) -l$(ARCH) $(PDA) $(ADAM_NDF) $(CURSES) 
	chmod a+x $(INSTALL)/pamela	
	\rm -f pamela.o

# makes links of commands to pamela monlith and copies equivalent
# ifl files.

links: 
	rm -f $(INSTALL)/*.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/extnor
	\cp -f `pwd`/src/extnor.ifl $(INSTALL)/extnor.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/extopt
	\cp -f `pwd`/src/extopt.ifl $(INSTALL)/extopt.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/faker
	\cp -f `pwd`/src/faker.ifl $(INSTALL)/faker.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/idtype
	\cp -f `pwd`/src/idtype.ifl $(INSTALL)/idtype.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/medprf
	\cp -f `pwd`/src/medprf.ifl $(INSTALL)/medprf.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/noise
	\cp -f `pwd`/src/noise.ifl $(INSTALL)/noise.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/optext
	\cp -f `pwd`/src/optext.ifl $(INSTALL)/optext.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/picstat
	\cp -f `pwd`/src/picstat.ifl $(INSTALL)/picstat.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/polfit
	\cp -f `pwd`/src/polfit.ifl $(INSTALL)/polfit.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/pplot
	\cp -f `pwd`/src/pplot.ifl $(INSTALL)/pplot.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/profit
	\cp -f `pwd`/src/profit.ifl $(INSTALL)/profit.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/recomp
	\cp -f `pwd`/src/recomp.ifl $(INSTALL)/recomp.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/regpic
	\cp -f `pwd`/src/regpic.ifl $(INSTALL)/regpic.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/skew
	\cp -f `pwd`/src/skew.ifl $(INSTALL)/skew.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/skyfit
	\cp -f `pwd`/src/skyfit.ifl $(INSTALL)/skyfit.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/skymov
	\cp -f `pwd`/src/skymov.ifl $(INSTALL)/skymov.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/splfit
	\cp -f `pwd`/src/splfit.ifl $(INSTALL)/splfit.ifl
	ln -sf $(INSTALL)/pamela $(INSTALL)/track
	\cp -f `pwd`/src/track.ifl $(INSTALL)/track.ifl
	chmod 755 $(INSTALL)
	chmod 644 src/*.ifl

pamela_aliases: 
	@echo 'Creating pamela_aliases alias file ...'
	@echo '#' > $(INSTALL)/pamela_aliases
	@echo '# This file was generated by make pamela_aliases' >> $(INSTALL)/pamela_aliases
	@echo '# It defines aliases for the pamela package' >> $(INSTALL)/pamela_aliases
	@echo '# source it to define them.' >> $(INSTALL)/pamela_aliases
	@echo '#' >> $(INSTALL)/pamela_aliases
	@echo ''alias extnor   $(INSTALL)/extnor''  >> $(INSTALL)/pamela_aliases
	@echo ''alias extopt   $(INSTALL)/extopt''  >> $(INSTALL)/pamela_aliases
	@echo ''alias faker    $(INSTALL)/faker''   >> $(INSTALL)/pamela_aliases
	@echo ''alias idtype   $(INSTALL)/idtype''  >> $(INSTALL)/pamela_aliases
	@echo ''alias medprf   $(INSTALL)/medprf''  >> $(INSTALL)/pamela_aliases
	@echo ''alias noise    $(INSTALL)/noise''   >> $(INSTALL)/pamela_aliases
	@echo ''alias optext   $(INSTALL)/optext''  >> $(INSTALL)/pamela_aliases
	@echo ''alias picstat  $(INSTALL)/picstat'' >> $(INSTALL)/pamela_aliases
	@echo ''alias polfit   $(INSTALL)/polfit''  >> $(INSTALL)/pamela_aliases
	@echo ''alias pplot    $(INSTALL)/pplot''   >> $(INSTALL)/pamela_aliases
	@echo ''alias profit   $(INSTALL)/profit''  >> $(INSTALL)/pamela_aliases
	@echo ''alias recomp   $(INSTALL)/recomp''  >> $(INSTALL)/pamela_aliases
	@echo ''alias regpic   $(INSTALL)/regpic''  >> $(INSTALL)/pamela_aliases
	@echo ''alias skew     $(INSTALL)/skew''    >> $(INSTALL)/pamela_aliases
	@echo ''alias skyfit   $(INSTALL)/skyfit''  >> $(INSTALL)/pamela_aliases
	@echo ''alias skymov   $(INSTALL)/skymov''  >> $(INSTALL)/pamela_aliases
	@echo ''alias splfit   $(INSTALL)/splfit''  >> $(INSTALL)/pamela_aliases
	@echo ''alias track    $(INSTALL)/track''   >> $(INSTALL)/pamela_aliases
	@echo ''alias debias      `pwd`/scripts/debias.pl''       >> $(INSTALL)/pamela_aliases
	@echo ''alias fixhead     `pwd`/scripts/fixhead.pl''      >> $(INSTALL)/pamela_aliases
	@echo ''alias fixrun      `pwd`/scripts/fixrun.csh''      >> $(INSTALL)/pamela_aliases
	@echo ''alias whtdiv      `pwd`/scripts/whtdiv.csh''      >> $(INSTALL)/pamela_aliases
	@echo ''alias makebias    `pwd`/scripts/makebias.csh''    >> $(INSTALL)/pamela_aliases
	@echo ''alias listformat  `pwd`/scripts/listformat.csh''  >> $(INSTALL)/pamela_aliases
	@echo ''alias uniqformat  `pwd`/scripts/uniqformat.csh''  >> $(INSTALL)/pamela_aliases
	@echo ''alias loopdisplay `pwd`/scripts/loopdisplay.csh'' >> $(INSTALL)/pamela_aliases
	@echo ''alias reduce      `pwd`/scripts/reduce.pl''       >> $(INSTALL)/pamela_aliases
	@echo ''alias renumber    `pwd`/scripts/renumber.pl''     >> $(INSTALL)/pamela_aliases
	@echo ''alias repet       `pwd`/scripts/repet.pl''        >> $(INSTALL)/pamela_aliases
	@echo ''alias rotate      `pwd`/scripts/rotate.pl''       >> $(INSTALL)/pamela_aliases
	@echo ''alias shiftaux    `pwd`/scripts/shiftaux.py''     >> $(INSTALL)/pamela_aliases
	@echo ''alias loganal     `pwd`/scripts/loganal.pl''      >> $(INSTALL)/pamela_aliases
	@echo ''alias ultradas    `pwd`/scripts/ultradas.csh''    >> $(INSTALL)/pamela_aliases
	@echo ''alias splitbysource `pwd`/scripts/splitbysource.pl'' >> $(INSTALL)/pamela_aliases
	@echo ''alias lsnosdf     `pwd`/scripts/lsnosdf.csh''     >> $(INSTALL)/pamela_aliases
	@echo ''alias ls1d        `pwd`/scripts/ls1d.csh''        >> $(INSTALL)/pamela_aliases
	@echo ''echo 'Welcome to pamela. Version exported $(EXPORT_DATE)''' >> $(INSTALL)/pamela_aliases
	@chmod a+r $(INSTALL)/pamela_aliases

help:
	@echo ''extnor   `pwd`/src/extnor.f''      > help_pointers
	@echo ''extopt   `pwd`/src/extopt.f''     >> help_pointers
	@echo ''faker    `pwd`/src/faker.f''      >> help_pointers
	@echo ''idtype   `pwd`/src/idtype.f''     >> help_pointers
	@echo ''medprf   `pwd`/src/medprf.f''     >> help_pointers
	@echo ''noise    `pwd`/src/noise.f''      >> help_pointers
	@echo ''optext   `pwd`/src/optext.f''     >> help_pointers
	@echo ''picstat  `pwd`/src/picstat.f''    >> help_pointers
	@echo ''polfit   `pwd`/src/polfit.f''     >> help_pointers
	@echo ''pplot    `pwd`/src/pplot.f''      >> help_pointers
	@echo ''profit   `pwd`/src/profit.f''     >> help_pointers
	@echo ''recomp   `pwd`/src/recomp.f''     >> help_pointers
	@echo ''regpic   `pwd`/src/regpic.f''     >> help_pointers
	@echo ''skew     `pwd`/src/skew.f''       >> help_pointers
	@echo ''skyfit   `pwd`/src/skyfit.f''     >> help_pointers
	@echo ''skymov   `pwd`/src/skymov.f''     >> help_pointers
	@echo ''splfit   `pwd`/src/splnfit.f''    >> help_pointers
	@echo ''track    `pwd`/src/track.f''      >> help_pointers
	@echo ''debias   `pwd`/scripts/debias.pl''   >> help_pointers
	@echo ''fixhead  `pwd`/scripts/fixhead.pl''  >> help_pointers
	@echo ''makebias `pwd`/scripts/makebias.csh'' >> help_pointers
	@echo ''reduce   `pwd`/scripts/reduce.pl''    >> help_pointers
	@echo ''rotate   `pwd`/scripts/rotate.pl''    >> help_pointers
	@echo ''renumber `pwd`/scripts/renumber.pl''  >> help_pointers
	@echo ''splitbysource `pwd`/scripts/splitbysource.pl''   >> help_pointers
	@echo ''ultradas `pwd`/scripts/ultradas.csh''  >> help_pointers
	@echo ''lsnosdf  `pwd`/scripts/lsnosdf.csh''   >> help_pointers
	perl genhtml.pl $(INSTALL)/html $(INSTALL)/pamela_aliases
	cd scripts; perl genhtml.pl $(INSTALL)/html
#	@-\rm -f help_pointers
	-\cp -f  `pwd`/scripts/datafile          $(INSTALL)/html/datafile
	-\cp -f  `pwd`/scripts/debias.pl         $(INSTALL)/html/debias.pl
	-\cp -f  `pwd`/scripts/fixhead.pl        $(INSTALL)/html/fixhead.pl
	-\cp -f  `pwd`/scripts/listformat.csh    $(INSTALL)/html/listformat.csh
	-\cp -f  `pwd`/scripts/loganal.pl        $(INSTALL)/html/loganal.pl
	-\cp -f  `pwd`/scripts/loopdisplay.csh   $(INSTALL)/html/loopdisplay.csh
	-\cp -f  `pwd`/scripts/makebias.csh      $(INSTALL)/html/makebias.csh
	-\cp -f  `pwd`/scripts/reduce.pl         $(INSTALL)/html/reduce.pl
	-\cp -f  `pwd`/scripts/repet.pl          $(INSTALL)/html/repet.pl
	-\cp -f  `pwd`/scripts/rotate.pl         $(INSTALL)/html/rotate.pl
	-\cp -f  `pwd`/scripts/renumber.pl       $(INSTALL)/html/renumber.pl
	-\cp -f  `pwd`/scripts/whtdiv.csh        $(INSTALL)/html/whtdiv.csh
	-\cp -f  `pwd`/scripts/ultradas.csh      $(INSTALL)/html/ultradas.csh
	-\cp -f  `pwd`/scripts/splitbysource.pl  $(INSTALL)/html/splitbysource.pl
	-\cp -f  `pwd`/scripts/uniqformat.csh    $(INSTALL)/html/uniqformat.csh
	-\cp -f  `pwd`/scripts/ultradas.csh      $(INSTALL)/html/ultradas.csh
	-\cp -f  `pwd`/scripts/lsnosdf.csh       $(INSTALL)/html/lsnosdf.csh
	-\cp -fr `pwd`/html/*                    $(INSTALL)/html/.
	@chmod 755 $(INSTALL) $(INSTALL)/html
	@chmod 644 $(INSTALL)/html/*
	@chmod 755 $(INSTALL)/html/examples
	@chmod 644 $(INSTALL)/html/examples/*
	@-\git log > $(INSTALL)/html/git_change_log 


# Removes installed files

clean:
	@-\echo "Removing everything in "$(INSTALL)
	@-\rm -fr $(INSTALL)

tar:
	echo $(DATE) > .export_date
	cd ..; tar -cvf /tmp/pamela.tar --exclude=".git" pamela
	\rm -f /tmp/pamela.tar.gz
	gzip /tmp/pamela.tar

changes:
	git log > /tmp/pamela_changes
	git log $(PREVIOUS)..HEAD > /tmp/pamela_recent_changes

export: changes tar
	scp /tmp/pamela_changes $(WEB_SERVE):$(WEB_PATH)/software/.
	scp /tmp/pamela_recent_changes $(WEB_SERVE):$(WEB_PATH)/software/.
	scp /tmp/pamela.tar.gz $(WEB_SERVE):$(WEB_PATH)/software/.
	scp -r $(INSTALL)/html $(WEB_SERVE):$(WEB_PATH)/software/pamela/.
	ssh $(WEB_SERVE) "cd $(WEB_PATH)/software; sed -e 's%<\!-- pamela date --><td>.*</td>%<\!-- pamela date --><td>$(DATE)</td>%' index.html > junk.html; mv junk.html index.html"
	ssh $(WEB_SERVE) "cd $(WEB_PATH)/software; sed -e 's%<\!-- pamela version --><td>.*</td>%<\!-- pamela version --><td>$(CURRENT)</td>%' index.html > junk.html; mv junk.html index.html"

message:
	@-\echo " "
	@-\echo " "
	@-\echo "To start pamela, source the file $(INSTALL)/pamela_aliases"
	@-\echo "You may want to create an alias for it in your .cshrc as in:"
	@-\echo " "
	@-\echo "alias pamela 'source $(INSTALL)/pamela_aliases'"
	@-\echo " "
	@-\echo "For further help, point a web browser at $(INSTALL)/html/INDEX.html"
	@-\echo " "
	@-\echo "Good luck!"
	@-\echo " "


# here are some old configurations

## Solaris:
# INSTALL    = /disks/binary/weed/trm/software/solaris/pamela
# STAR       = /star
# PGDIR      = /usr/local/pgplot
# PGPLOT     = -L$(PGDIR) -lpgplot -L/usr/X11R6/lib -lX11
# F77        = f77
# FFLAGS     = -O

## Old linux laptop:
# INSTALL    = $(TRM_SOFTWARE)/pamela
# STAR       = /star
# PGDIR      = $(TRM_SOFTWARE)/lib
# PGPLOT     = -L$(PGDIR) -lpgplot -L/usr/X11R6/lib -lX11 -lpng -lz
# F77        = g77
# FFLAGS     = -O -fno-second-underscore -fno-automatic

# John Taylor's old laptop
# INSTALL    = /usr/local/pamela
# STAR       = /star
# PGDIR      = /star/lib
# PGPLOT     = -L$(PGDIR) -lpgplot -lgwm -L/usr/X11R6/lib -lX11 -lemsf -lems -lcnf
# F77        = g77
# FFLAGS     = -O -fno-second-underscore -fno-automatic

# Warwick old
# INSTALL    = /disks/software/trm-software/pamela
# STAR       = /star
# PGDIR      = /usr/local/pgplot
# PGPLOT     = -L$(PGDIR) -lpgplot -L/usr/X11R6/lib -lX11 -lpng -lz
# F77        = g77
# FFLAGS     = -O 
















