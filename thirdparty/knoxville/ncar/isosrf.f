      SUBROUTINE ISOSRF (T,LU,MU,LV,MV,MW,EYE,MUVWP2,SLAB,TISO,IFLAG)
      SAVE
      DIMENSION       T(LU,LV,MW),EYE(3)     ,SLAB(MUVWP2,MUVWP2)
C
      COMMON /ISOSR1/ ISLBT      ,U          ,V          ,W
      COMMON /ISOSR2/ LX         ,NX         ,NY         ,ISCR(8,128),
     1                ISCA(8,128)
      COMMON /ISOSR3/ ISCALE     ,XMIN       ,XMAX       ,YMIN       ,
     1                YMAX       ,BIGD       ,R0
      COMMON /ISOSR4/ RX         ,RY
      COMMON /ISOSR5/ NBPW       ,MASK(16)   ,GENDON
      COMMON /ISOSR6/ IX         ,IY         ,IDX        ,IDY        ,
     1                IS         ,ISS        ,NP         ,CV         ,
     2                INX(8)     ,INY(8)     ,IR(500)    ,NR
      COMMON /ISOSR7/ IENTRY     ,IONES
      COMMON /ISOSR9/ BIG        ,IXBIT
      EXTERNAL        ISOSRB
C
      LOGICAL         GENDON
      DATA IREF/1/
C
      AVE(A,B) = (A+B)*.5
C
C A.S.F. FOR SCALING
C
      SU(UTEMP) = UTEMP
      SV(VTEMP) = VTEMP
      SW(WTEMP) = WTEMP
C
C THE FOLLOWING CALL IS FOR GATHERING STATISTICS ON LIBRARY USE AT NCAR
C
      CALL Q8QST4 ('NSSL','ISOSRF','ISOSRF','VERSION 12')
      NERR = 0
C
C 3-SPACE  U,V,W,IU,IV,IW,ETC
C 2-SPACE  X,Y,IX,IY,ETC
C
C  INITIALIZE MASKS
C
      IF (.NOT.GENDON) CALL MMASK
C
C  SET SHIFT VALUE FOR X,Y PACKING
C
C  IF YOUR MACHINE HAS MORE THAN 16 BITS PER WORD THIS CHECK MAY BE
C  MODIFIED
C
      IF (LU .LE. 256) GO TO  10
      NERR = NERR + 1
      CALL SETER('DIMENSION OF CUBE EXCEEDS 256',NERR,2)
      RETURN
   10 DO  20 J=1,30
         IF (LU .LE. 2**(J-1)) GO TO  30
   20 CONTINUE
   30 IXBIT = J
      NU = MU
      NUP2 = NU+2
      NV = MV
      NVP2 = NV+2
      NW = MW
      NWP2 = NW+2
      FNU = NU
      FNV = NV
      FNW = NW
      SU1 = SU(1.)
      SV1 = SV(1.)
      SW1 = SW(1.)
      SUNU = SU(FNU)
      SVNV = SV(FNV)
      SWNW = SW(FNW)
      AVEU = AVE(SU1,SUNU)
      AVEV = AVE(SV1,SVNV)
      AVEW = AVE(SW1,SWNW)
      EYEU = EYE(1)
      EYEV = EYE(2)
      EYEW = EYE(3)
      NUVWP2 = MUVWP2
      TVAL = TISO
      NFLAG = IABS(IFLAG)
      IF (NFLAG.EQ.0 .OR. NFLAG.GE.8) NFLAG = 7
C
C SET UP SCALING
C
      FACT = -ISIGN(1,IFLAG)
      CALL SET3D (EYE,1.,FNU,1.,FNV,1.,FNW)
C
C BOUND LOWER AND LEFT EDGE OF SLAB
C
      EDGE = SIGN(BIG,FACT)
      DO  40 IUVW=1,NUVWP2
         SLAB(IUVW,1) = EDGE
         SLAB(1,IUVW) = EDGE
   40 CONTINUE
C
C SLICES PERPENDICULAR TO U. THAT IS, V W SLICES. T OF CONSTANT U.
C
      IF (NFLAG .LT. 4) GO TO 100
      CALL ZEROSC
      ISLBT = -1
C
C BOUND UPPER AND RIGHT EDGE OF SLAB.
C
      DO  50 IV=2,NVP2
         SLAB(IV,NWP2) = EDGE
   50 CONTINUE
      DO  60 IW=2,NWP2
         SLAB(NVP2,IW) = EDGE
   60 CONTINUE
C
C GO THRU 3-D ARRAY IN U DIRECTION.  IUEW=IU EITHER WAY.
C PICK IU BASED ON EYEU.
C
      DO  90 IUEW=1,NU
         IU = IUEW
         IF (EYEU .GT. AVEU) IU = NU+1-IUEW
         U = IU
C
C LOAD THIS SLICE OF T INTO SLAB.
C
         DO  80 IV=1,NV
            DO  70 IW=1,NW
               SLAB(IV+1,IW+1) = T(IU,IV,IW)
   70       CONTINUE
   80    CONTINUE
C
C CONTOUR THIS SLAB.
C
         CALL STCNTR (SLAB,NUVWP2,NVP2,NWP2,TVAL)
C
C CONSTRUCT VISIBILITY ARRAY.
C
         CALL FILLIN
   90 CONTINUE
C
C SLICES PERPENDICULAR TO V. U W SLICES. T OF CONSTANT V.
C
  100 IF (MOD(NFLAG/2,2) .EQ. 0) GO TO 160
      CALL ZEROSC
      ISLBT = 0
C
C BOUND UPPER AND RIGHT EDGE OF SLAB.
C
      DO 110 IU=2,NUP2
         SLAB(IU,NWP2) = EDGE
  110 CONTINUE
      DO 120 IW=2,NWP2
         SLAB(NUP2,IW) = EDGE
  120 CONTINUE
C
C GO THRU T IN V DIRECTION.  IVEW=IV EITHER WAY.
C
      DO 150 IVEW=1,NV
         IV = IVEW
         IF (EYEV .GT. AVEV) IV = NV+1-IVEW
         V = IV
C
C LOAD THIS SLICE OF T INTO SLAB.
C
         DO 140 IU=1,NU
            DO 130 IW=1,NW
               SLAB(IU+1,IW+1) = T(IU,IV,IW)
  130       CONTINUE
  140    CONTINUE
C
C CONTOUR THIS SLAB.
C
         CALL STCNTR (SLAB,NUVWP2,NUP2,NWP2,TVAL)
C
C CONSTRUCT VISIBILITY ARRAY.
C
         CALL FILLIN
  150 CONTINUE
C
C SLICES PERPENDICULAR TO W. U V SLICES. T OF CONSTANT W.
C
  160 IF (MOD(NFLAG,2) .EQ. 0) GO TO 220
      CALL ZEROSC
C
      ISLBT = 1
C
C BOUND UPPER AND RIGHT EDGE OF SLAB.
C
      DO 170 IU=2,NUP2
         SLAB(IU,NVP2) = EDGE
  170 CONTINUE
      DO 180 IV=2,NVP2
         SLAB(NUP2,IV) = EDGE
  180 CONTINUE
C
C GO THRU T IN W DIRECTION.
C
      DO 210 IWEW=1,NW
         IW = IWEW
         IF (EYEW .GT. AVEW) IW = NW+1-IWEW
         W = IW
C
C LOAD THIS SLICE OF T INTO SLAB.
C
         DO 200 IU=1,NU
            DO 190 IV=1,NV
               SLAB(IU+1,IV+1) = T(IU,IV,IW)
  190       CONTINUE
  200    CONTINUE
C
C CONTOUR THIS SLAB.
C
         CALL STCNTR (SLAB,NUVWP2,NUP2,NVP2,TVAL)
C
C CONSTRUCT VISIBILITY ARRAY.
C
         CALL FILLIN
  210 CONTINUE
C
C DRAW REFERENCE PLANE EDGES AND W AXIS.
C
  220 IF (IREF .EQ. 0) RETURN
      CALL TRN32I (SU1,SV1,SW1,XT,YT,DUM,2)
      IF (EYEV .LT. SV1) GO TO 240
      CALL FRSTC (IFIX(XT),IFIX(YT),1)
      DO 230 IU=2,NU
         CALL TRN32I (SU(FLOAT(IU)),SV1,SW1,XT,YT,DUM,2)
         CALL FRSTC (IFIX(XT),IFIX(YT),2)
  230 CONTINUE
      GO TO 250
  240 CALL PLOTIT (IFIX(XT),IFIX(YT),0)
      CALL TRN32I (SUNU,SV1,SW1,XT,YT,DUM,2)
      CALL PLOTIT (IFIX(XT),IFIX(YT),1)
  250 IF (EYEU .GT. SUNU) GO TO 270
      CALL FRSTC (IFIX(XT),IFIX(YT),1)
      DO 260 IV=2,NV
         CALL TRN32I (SUNU,SV(FLOAT(IV)),SW1,XT,YT,DUM,2)
         CALL FRSTC (IFIX(XT),IFIX(YT),2)
  260 CONTINUE
      GO TO 280
  270 CALL PLOTIT (IFIX(XT),IFIX(YT),0)
      CALL TRN32I (SUNU,SVNV,SW1,XT,YT,DUM,2)
      CALL PLOTIT (IFIX(XT),IFIX(YT),1)
  280 IF (EYEV .GT. SVNV) GO TO 300
      CALL FRSTC (IFIX(XT),IFIX(YT),1)
      DO 290 IUOW=2,NU
         CALL TRN32I (SU(FLOAT(NU-IUOW+1)),SVNV,SW1,XT,YT,DUM,2)
         CALL FRSTC (IFIX(XT),IFIX(YT),2)
  290 CONTINUE
      GO TO 310
  300 CALL PLOTIT (IFIX(XT),IFIX(YT),0)
      CALL TRN32I (SU1,SVNV,SW1,XT,YT,DUM,2)
      CALL PLOTIT (IFIX(XT),IFIX(YT),1)
  310 IF (EYEU .LT. SU1) GO TO 330
      CALL FRSTC (IFIX(XT),IFIX(YT),1)
      DO 320 IVOW=2,NV
         CALL TRN32I (SU1,SV(FLOAT(NV-IVOW+1)),SW1,XT,YT,DUM,2)
         CALL FRSTC (IFIX(XT),IFIX(YT),2)
  320 CONTINUE
      GO TO 340
  330 CALL PLOTIT (IFIX(XT),IFIX(YT),0)
      CALL TRN32I (SU1,SV1,SW1,XT,YT,DUM,2)
      CALL PLOTIT (IFIX(XT),IFIX(YT),1)
  340 IF (EYEU.LE.SU1 .OR. EYEV.LE.SV1) GO TO 360
      CALL FRSTC (IFIX(XT),IFIX(YT),1)
      DO 350 IW=2,NW
         CALL TRN32I (SU1,SV1,SW(FLOAT(IW)),XT,YT,DUM,2)
         CALL FRSTC (IFIX(XT),IFIX(YT),2)
  350 CONTINUE
      RETURN
  360 CALL PLOTIT (IFIX(XT),IFIX(YT),0)
      CALL TRN32I (SU1,SV1,SWNW,XT,YT,DUM,2)
      CALL PLOTIT (IFIX(XT),IFIX(YT),1)
      RETURN
      END
